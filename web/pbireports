<!doctype html><meta charset="utf-8">
<title>Insights</title>
<script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.23.1/dist/powerbi.js"></script>
<div id="pbi" style="height:80vh"></div>
<script>
(async () => {
  const r = await fetch("/api/pbi-token"); if(!r.ok) throw new Error(await r.text());
  const { embedUrl, reportId, token } = await r.json();
  const models = window["powerbi-client"].models;
  const pbi = powerbi.embed(document.getElementById("pbi"), {
    type:"report", id: reportId, embedUrl,
    accessToken: token, tokenType: models.TokenType.Embed,
    permissions: models.Permissions.All,
    settings:{ panes:{ filters:{ visible:true } } }
  });
  // Optional: refresh token just before expiry
  pbi.on("tokenExpired", async ()=> {
    const r = await fetch("/api/pbi-token"); const j = await r.json();
    await pbi.setAccessToken(j.token);
  });
})();
</script>

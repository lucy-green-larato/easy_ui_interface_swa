<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · Campaign Builder</title>
  <link rel="icon" href="/assets/larato-logo.svg" />
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #fff;
      --ink: #1c1e21;
      --muted: #6b7280;
      --border: #e5e7eb;
      --brand: #111827;
      --accent: #2563eb;
      --ok: #047857;
      --warn: #b45309;
      --err: #b91c1c;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--ink);
      background: var(--bg)
    }

    header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600
    }

    .chip {
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px
    }

    main {
      max-width: 1400px;
      margin: 16px auto;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 300px 1fr 290px;
      gap: 16px
    }

    @media (max-width:1100px) {
      main {
        grid-template-columns: 1fr
      }

      .assist {
        display: none
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 0 rgba(0, 0, 0, .02)
    }

    .rail {
      position: sticky;
      top: 64px;
      align-self: start;
      max-height: calc(100vh - 80px);
      overflow: auto;
      padding: 12px
    }

    .rail h3 {
      margin: 8px 8px 4px;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .04em
    }

    .group {
      padding: 8px;
      border-bottom: 1px dashed var(--border)
    }

    .group:last-child {
      border-bottom: 0
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px
    }

    input[type="text"],
    input[type="url"],
    select,
    .textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff
    }

    input[type="file"] {
      width: 100%
    }

    .muted {
      color: var(--muted)
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #111827;
      color: #fff;
      cursor: pointer
    }

    .btn.secondary {
      background: #fff;
      color: #111827
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed
    }

    .workspace {
      padding: 12px
    }

    .stage {
      display: flex;
      gap: 10px;
      margin: 4px 0 12px
    }

    .stage .step {
      flex: 1;
      padding: 8px;
      background: #f3f4f6;
      border-radius: 10px;
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      border: 1px solid #e5e7eb
    }

    .stage .step.active {
      background: #eef2ff;
      color: #3730a3;
      border-color: #c7d2fe
    }

    .stage .step.done {
      background: #ecfdf5;
      color: #047857;
      border-color: #a7f3d0
    }

    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
      align-items: center;
      justify-content: space-between
    }

    .tabs-left {
      display: flex;
      gap: 8px
    }

    .tab {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      background: #f9fafb;
      cursor: pointer
    }

    .tab.active {
      background: #fff;
      font-weight: 600
    }

    .panel {
      padding: 8px 4px 16px
    }

    .assist {
      padding: 12px
    }

    .assist .section {
      padding: 10px;
      border-bottom: 1px dashed var(--border)
    }

    .assist .section:last-child {
      border-bottom: 0
    }

    .list {
      margin: 6px 0 0;
      padding-left: 16px
    }

    .pre {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: .95rem
    }

    .table {
      width: 100%;
      border-collapse: collapse
    }

    .table th,
    .table td {
      text-align: left;
      border-bottom: 1px solid #eee;
      padding: .5rem;
      vertical-align: top
    }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity .2s;
      pointer-events: none
    }

    .toast.show {
      opacity: .9
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--warn);
      margin-right: 8px
    }

    .status-dot.ok {
      background: var(--ok)
    }

    .status-dot.err {
      background: var(--err)
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <img src="/assets/larato-logo.svg" alt="Inside Track" class="logo" style="height:24px" />
      <span>Inside Track Tools · <strong>Campaign Builder</strong></span>
      <span class="chip" id="envChip">Dev</span>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
      <button class="btn secondary" id="newRunBtn">New run</button>
      <button class="btn secondary" id="loadRecentBtn">Load recent</button>
      <div id="download-docx-mount"></div>
      <a href="#" class="muted">Help</a>
    </div>
  </header>

  <main>
    <!-- Left rail: inputs -->
    <aside class="card rail" id="inputs">
      <div class="group">
        <h3>Data source</h3>
        <label for="runSelect">Pick a recent Power BI run</label>
        <select id="runSelect">
          <option value="">(coming soon)</option>
        </select>
        <div class="muted" style="margin-top:6px">or</div>
        <label for="csvUpload" style="margin-top:6px">Upload CSV (testing only)</label>
        <input id="csvUpload" type="file" accept=".csv" />
        <div style="display:flex; gap:8px; align-items:center; margin-top:8px">
          <button id="goBtn" class="btn" disabled>Go</button>
          <div class="muted"><span id="csvBadge">(no file)</span></div>
        </div>
      </div>

      <div class="group">
        <h3>Company</h3>
        <label>Company name</label>
        <input id="companyName" type="text" placeholder="Comms 365" />
        <label style="margin-top:8px">Website</label>
        <input id="companyWebsite" type="url" placeholder="https://www.example.com" />
        <label style="margin-top:8px">LinkedIn</label>
        <input id="companyLinkedIn" type="url" placeholder="https://www.linkedin.com/company/..." />
        <label style="margin-top:8px">USPs / differentiators</label>
        <textarea id="companyUsps" class="textarea" rows="3"
          placeholder="Resilient connectivity; Millisecond failover"></textarea>
      </div>

      <div class="group">
        <h3>Options</h3>
        <label>Page (folder key)</label>
        <input id="pageKey" type="text" placeholder="Direct" value="Direct" />
        <label style="margin-top:8px">Tone</label>
        <select id="tone">
          <option value="match">Match company website (recommended)</option>
          <option value="professional" selected>Professional</option>
          <option value="warm">Warm</option>
        </select>
        <label style="margin-top:8px">Evidence window (months)</label>
        <select id="evidenceWindow">
          <option>6</option>
          <option>9</option>
          <option>12</option>
        </select>
        <label style="display:flex; align-items:center; gap:8px; margin-top:8px">
          <input id="includeCompliance" type="checkbox" checked /> Include compliance footer
        </label>
      </div>

      <div class="group">
        <h3>Status</h3>
        <div><span id="statusDot" class="status-dot"></span><span id="statusText">Idle</span></div>
        <div class="muted" style="margin-top:6px">Run: <span id="currentRunId">–</span></div>
      </div>
    </aside>

    <!-- Center: workspace -->
    <section class="card workspace">
      <!-- Stage / status -->
      <div class="stage" id="stageBar">
        <div class="step" id="step-ValidatingInput">Validate</div>
        <div class="step" id="step-EvidenceBuilder">Evidence</div>
        <div class="step" id="step-DraftCampaign">Draft</div>
        <div class="step" id="step-QualityGate">Quality</div>
        <div class="step" id="step-Completed">Done</div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tabs-left" id="sectionTabs"></div>
      </div>

      <div class="panel" id="centerPanel"></div>

      <div id="runBadge" class="muted">Run: <span id="runBadgeId">–</span></div>
      </div>

      <!-- Panels -->
      <div id="campaign-content" class="panel">
        <div id="tab-overview" class="card">
          <div class="muted">When a run completes, the executive summary and meta will render here.</div>
        </div>
        <div id="tab-landing" class="card" style="display:none">
          <div class="muted">Landing page assets will render here.</div>
        </div>
        <div id="tab-emails" class="card" style="display:none">
          <div class="muted">Emails will render here.</div>
        </div>
        <div id="tab-evidence" class="card" style="display:none">
          <div class="muted">Evidence log will render here.</div>
        </div>
        <div id="tab-sales" class="card" style="display:none">
          <div class="muted">Sales enablement content will render here.</div>
        </div>
      </div>
    </section>

    <!-- Right rail: assist / tips -->
    <aside class="card assist">
      <div class="section">
        <strong>Tips</strong>
        <ul class="list">
          <li>Upload a CSV, adjust options, then press <em>Go</em>.</li>
          <li>When status reaches <em>Completed</em>, the tabs will populate automatically.</li>
        </ul>
      </div>
      <div class="section">
        <strong>Debug</strong>
        <div class="pre" id="debugLog" style="max-height:42vh; overflow:auto;"></div>
      </div>
    </aside>
  </main>

  <div id="campaign-toast" class="toast"></div>

  <!-- Tab + stage helpers -->
  <script>
    (function () {
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
      const $ = (sel, root = document) => root.querySelector(sel);
      // === CSV loader for /api/generate(kind=campaign) ===
      let __csv_text = "";
      const __csv_input = $("#csvUpload");
      const __goBtn = $("#goBtn");
      const __csvBadge = $("#csvBadge");

      __csv_input.addEventListener("change", async (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) {
          __csv_text = "";
          __goBtn.disabled = true;
          if (__csvBadge) __csvBadge.textContent = "(no file)";
          return;
        }
        const text = await f.text();
        __csv_text = text;
        const rows = Math.max(0, (text.match(/\r?\n/g) || []).length - 1);
        if (__csvBadge) __csvBadge.textContent = `${f.name} · ${rows} rows`;
        __goBtn.disabled = false;
      });

      function setActiveTab(id) {
        $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.tabTarget === id));
        $$("#campaign-content > div").forEach(p => p.style.display = (p.id === id ? "" : "none"));
      }
      $$(".tab").forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tabTarget)));

      function updateStage(state) {
        const order = ["ValidatingInput", "EvidenceBuilder", "DraftCampaign", "QualityGate", "Completed"];
        order.forEach(s => {
          const el = $("#step-" + s);
          if (!el) return;
          el.classList.remove("active", "done");
          if (state === s) el.classList.add("active");
          if (order.indexOf(s) < order.indexOf(state)) el.classList.add("done");
        });
      }

      function setRunId(runId) {
        $("#currentRunId").textContent = runId || "–";
        $("#runBadgeId").textContent = runId || "–";
      }

      window.CampaignPage = { setActiveTab, updateStage, setRunId };
      setActiveTab("tab-overview");
    })();
  </script>

  <!-- Main logic: upload → Go → start → poll → fetch → render -->
  <script>
    (function () {
      const $ = (sel, root = document) => root.querySelector(sel);
      const debug = $("#debugLog");
      const toastEl = $("#campaign-toast");
      const setStatus = (txt, mode) => {
        $("#statusText").textContent = txt;
        const dot = $("#statusDot");
        dot.className = "status-dot";
        if (mode === "ok") dot.classList.add("ok");
        if (mode === "err") dot.classList.add("err");
      };
      const log = (m) => { const t = new Date().toISOString().replace('T', ' ').replace('Z', ''); debug.textContent += `[${t}] ${m}\n`; debug.scrollTop = debug.scrollHeight; };
      const toast = (m) => { toastEl.textContent = m; toastEl.classList.add("show"); setTimeout(() => toastEl.classList.remove("show"), 1600); };

      let selectedFile = null;
      let csvText = "";
      let csvSha = ""; let rowCount = 0; let currentRunId = "";

      async function sha256Hex(buf) {
        const hash = await crypto.subtle.digest("SHA-256", buf);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
      }
      function countCsvRows(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        return Math.max(0, lines.length - 1);
      }
      function parseRunIdFromAny(obj) {
        if (!obj || typeof obj !== "object") return "";
        if (obj.runId) return obj.runId;
        if (obj.id) return obj.id;
        if (obj.statusQueryGetUri) {
          const m = String(obj.statusQueryGetUri).match(/instances\/([^\/\?]+)/);
          if (m) return m[1];
        }
        return "";
      }

      $("#csvUpload").addEventListener("change", async (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) { selectedFile = null; $("#goBtn").disabled = true; $("#csvBadge").textContent = "(no file)"; return; }
        selectedFile = f;
        const [text, buf] = await Promise.all([f.text(), f.arrayBuffer()]);
        rowCount = countCsvRows(text);
        csvText = text;
        csvSha = await sha256Hex(buf);
        $("#csvBadge").textContent = `${f.name} · ${rowCount} rows · sha256=${csvSha.slice(0, 12)}…`;
        $("#goBtn").disabled = false;
        setStatus("Ready", "ok");
        log(`CSV ready: rows=${rowCount}, sha256=${csvSha}`);
      });

      $("#newRunBtn").addEventListener("click", () => toast("Select a CSV, then click Go"));

      $("#goBtn").addEventListener("click", async () => {
        if (!selectedFile) { toast("Choose a CSV first"); return; }
        $("#goBtn").disabled = true;
        setStatus("Generating…");
        log("Submitting to /api/generate (kind=campaign)");
        window.CampaignPage.updateStage("ValidatingInput");

        const csv_text = await selectedFile.text();
        const payload = {
          kind: "campaign",           // <-- REQUIRED by the API
          csv_text,                   // <-- REQUIRED by the API
          source: "upload",
          page: "campaign",
          rowCount,
          csv_sha256: csvSha,
          company: {
            name: $("#companyName").value || undefined,
            website: $("#companyWebsite").value || undefined,
            linkedin: $("#companyLinkedIn").value || undefined,
            usps: $("#companyUsps").value || undefined
          },
          tone: $("#tone").value || undefined,
          evidenceWindowMonths: parseInt($("#evidenceWindow").value || "6", 10),
          complianceFooter: $("#includeCompliance").checked
        };

        try {
          const res = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(() => ({}));
          if (data && data._debug_prompt) {
            log("---- PROMPT SENT TO LLM ----\n" + data._debug_prompt);
          }
          if (!res.ok) {
            log(`generate failed ${res.status}: ${JSON.stringify(data)}`);
            setStatus("Failed", "err");
            $("#goBtn").disabled = false;
            return;
          }
          window.CampaignPage.updateStage("DraftCampaign");
          window.CampaignPage.updateStage("QualityGate");
          window.CampaignPage.updateStage("Completed");

          // Accept any of the known shapes from the API
          const contract =
            data?.contract_v1 ||
            data?.contract_v1_flat ||
            data?.body?.contract_v1 ||
            data?.body ||
            data;
          window.CampaignUI.setContract(contract);
          setStatus("Completed", "ok");
          $("#goBtn").disabled = false;

        } catch (e) {
          log(`generate error: ${e && e.message ? e.message : e}`);
          setStatus("Error", "err");
          $("#goBtn").disabled = false;
        }
      });

      async function pollStatus(runId) {
        for (let i = 0; i < 90; i++) {
          try {
            const url = `/api/campaign/status?runId=${encodeURIComponent(runId)}`;
            const res = await fetch(url, { method: "GET" });
            if (!res.ok) { log(`status ${res.status}`); await new Promise(r => setTimeout(r, 1500)); continue; }
            const js = await res.json().catch(() => ({}));
            const s = String(js.state || js.runtimeStatus || "").toLowerCase();

            // map to visual stages when possible
            const stageMap = { validatinginput: "ValidatingInput", evidencebuilder: "EvidenceBuilder", draftcampaign: "DraftCampaign", qualitygate: "QualityGate", completed: "Completed" };
            Object.keys(stageMap).forEach(k => { if (s.includes(k)) window.CampaignPage.updateStage(stageMap[k]); });

            if (s.includes("completed")) {
              setStatus("Completed", "ok");
              await fetchResults(runId);
              return;
            }
            if (s.includes("failed") || s.includes("terminated")) {
              setStatus("Failed", "err");
              log(`failed: ${JSON.stringify(js)}`);
              return;
            }
          } catch (e) {
            log(`poll error: ${e}`);
          }
          await new Promise(r => setTimeout(r, 1500));
        }
        setStatus("Timeout", "err");
      }

      async function fetchResults(runId) {
        const urls = [
          `/api/campaign/fetch?file=campaign&runId=${encodeURIComponent(runId)}`,
          `/api/campaign/fetch?file=campaign`
        ];
        for (const u of urls) {
          try {
            const res = await fetch(u);
            if (!res.ok) { log(`fetch ${u} -> ${res.status}`); continue; }
            const js = await res.json().catch(() => ({}));
            window.CampaignUI.setContract(js);
            setStatus("Done", "ok");
            return;
          } catch (e) { log(`fetch error: ${e}`); }
        }
        setStatus("Fetch failed", "err");
      }

      // expose minimal API if other modules expect it
      window.Campaign = {
        startNewRun: async (opts = {}) => {
          // if someone clicks header "New run", we just prompt for CSV
          document.getElementById("csvUpload").click();
        },
        updateStage: window.CampaignPage.updateStage
      };
    })();
  </script>
  <script>
    (function () {
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      // Remove any legacy green status strip if still present
      $$('.stage')?.forEach(el => el.remove());

      const state = {
        contract: null,
        active: 'exec'
      };

      const SECTIONS = [
        { id: 'exec', label: 'Executive Summary', render: renderExecutiveSummary },
        { id: 'elog', label: 'Evidence Log (table)', render: renderEvidenceLog },
        { id: 'cases', label: 'Case Study Library (table)', render: renderCaseLibrary },
        { id: 'pos', label: 'Positioning & Differentiation', render: renderPositioning },
        { id: 'icp', label: 'ICP & Messaging Matrix (table)', render: renderICPMatrix },
        { id: 'offer', label: 'Offer Strategy & Assets', render: renderOffer },
        { id: 'chan', label: 'Channel Plan & Orchestration', render: renderChannel },
        { id: 'se', label: 'Sales Enablement Alignment', render: renderSalesEnablement },
        { id: 'ml', label: 'Measurement & Learning Plan', render: renderMeasurement },
        { id: 'comp', label: 'Compliance & Governance', render: renderCompliance },
        { id: 'risk', label: 'Risks & Contingencies', render: renderRisks },
        { id: 'one', label: 'One Page Campaign Summary', render: renderOnePager }
      ];

      function mountTabs() {
        const host = $('#sectionTabs');
        if (!host) return;
        host.innerHTML = '';
        SECTIONS.forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'tab' + (s.id === state.active ? ' active' : '');
          btn.type = 'button';
          btn.textContent = s.label;
          btn.dataset.section = s.id;
          btn.addEventListener('click', () => {
            state.active = s.id;
            $$('.tab', host).forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderActive();
          });
          host.appendChild(btn);
        });
      }

      function setPanelContent(node) {
        const mount = $('#centerPanel');
        if (!mount) return;
        mount.innerHTML = '';
        if (node) mount.appendChild(node);
      }

      function makePre(text) {
        const pre = document.createElement('div');
        pre.className = 'pre';
        pre.textContent = String(text || '').trim() || '(no content)';
        return pre;
      }

      function makeList(items) {
        const ul = document.createElement('ul');
        ul.className = 'list';
        (items || []).forEach(x => {
          const li = document.createElement('li');
          li.textContent = String(x || '').trim();
          ul.appendChild(li);
        });
        if (!ul.children.length) {
          const p = document.createElement('p');
          p.className = 'muted';
          p.textContent = '(none)';
          return p;
        }
        return ul;
      }

      function makeTable(headers, rows) {
        const table = document.createElement('table');
        table.className = 'table';
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        const tbody = document.createElement('tbody');
        (rows || []).forEach(r => {
          const tr = document.createElement('tr');
          r.forEach(cell => {
            const td = document.createElement('td');
            if (cell && typeof cell === 'object' && cell.__link) {
              const a = document.createElement('a');
              a.href = cell.href;
              a.textContent = cell.text || cell.href;
              a.target = '_blank';
              a.rel = 'noopener';
              td.appendChild(a);
            } else if (Array.isArray(cell)) {
              td.textContent = cell.join(', ');
            } else {
              td.textContent = String(cell ?? '');
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(thead);
        table.appendChild(tbody);
        return table;
      }

      function rowsOf(arr) { return Array.isArray(arr) ? arr : []; }

      function renderActive() {
        const s = SECTIONS.find(x => x.id === state.active);
        if (!s || !s.render) return;
        s.render();
      }

      // ---- RENDERERS (map exactly to contract_v1 keys) ----

      function renderExecutiveSummary() {
        const c = state.contract;
        const es = c?.['3_campaign_output']?.['3.1_executive_summary']?.draft || '(no executive summary)';
        setPanelContent(makePre(es));
      }

      function renderEvidenceLog() {
        const c = state.contract;
        const entries = c?.['2_workflow']?.['2C_evidence_log']?.entries || [];
        const headers = ['ClaimID', 'Publisher', 'Title', 'Date', 'URL', 'Excerpt', 'Relevance', 'Freshness'];
        const rows = entries.map(e => [
          e.claim_id || '',
          e.publisher || '',
          e.title || '',
          e.date || '',
          e.url ? { __link: true, href: e.url, text: e.url } : '',
          e.excerpt_max_2_lines || e.excerpt || '',
          e.relevance || '',
          e.freshness_status || ''
        ]);
        setPanelContent(makeTable(headers, rows));
      }

      function renderCaseLibrary() {
        const c = state.contract;
        const cases = c?.['2_workflow']?.['2D_case_study_library']?.cases || [];
        const headers = ['Case ID', 'Customer', 'Industry', 'Problem', 'Solution', 'Outcomes', 'Link', 'Source'];
        const rows = cases.map(k => [
          k.case_id || '',
          k.customer || '',
          k.industry || '',
          k.problem || '',
          k.solution || '',
          k.outcomes_metrics || k.outcomes || '',
          k.link ? { __link: true, href: k.link, text: k.link } : '',
          k.source || ''
        ]);
        setPanelContent(makeTable(headers, rows));
      }

      function renderPositioning() {
        const c = state.contract;
        const pos = c?.['3_campaign_output']?.['3.2_positioning_and_differentiation'] || {};
        const wrap = document.createElement('div');

        const h1 = document.createElement('h3'); h1.textContent = 'Value Proposition';
        wrap.appendChild(h1);
        wrap.appendChild(makePre(pos.value_proposition || ''));

        const sw = pos.swot_if_step_2B_ran?.swot || pos.swot || null;
        if (sw) {
          const h2 = document.createElement('h3'); h2.textContent = 'SWOT';
          wrap.appendChild(h2);
          const headers = ['Strengths', 'Weaknesses', 'Opportunities', 'Threats'];
          const rows = [[rowsOf(sw.strengths).join('\n'), rowsOf(sw.weaknesses).join('\n'), rowsOf(sw.opportunities).join('\n'), rowsOf(sw.threats).join('\n')]];
          const t = makeTable(headers, rows);
          // make cells pre-style
          $$('.table td', t).forEach(td => td.style.whiteSpace = 'pre-wrap');
          wrap.appendChild(t);
        }

        if (Array.isArray(pos.swot_if_step_2B_ran?.differentiators) || Array.isArray(pos.differentiators)) {
          const h3 = document.createElement('h3'); h3.textContent = 'Differentiators';
          wrap.appendChild(h3);
          wrap.appendChild(makeList(pos.swot_if_step_2B_ran?.differentiators || pos.differentiators || []));
        }

        const comp = rowsOf(pos.competitor_set);
        if (comp.length) {
          const h4 = document.createElement('h3'); h4.textContent = 'Competitor Set';
          wrap.appendChild(h4);
          const headers = ['Vendor', 'Reason in set', 'URL'];
          const rows = comp.map(v => [v.vendor || '', v.reason_in_set || '', v.url ? { __link: true, href: v.url, text: v.url } : '']);
          wrap.appendChild(makeTable(headers, rows));
        }

        setPanelContent(wrap);
      }

      function renderICPMatrix() {
        const c = state.contract;
        const block = c?.['3_campaign_output']?.['3.3_icp_and_messaging_matrix'] || {};
        const wrap = document.createElement('div');

        const h1 = document.createElement('h3'); h1.textContent = 'Non-negotiables';
        wrap.appendChild(h1);
        wrap.appendChild(makeList(block.icp_slices?.non_negotiables_from_top_needs_supplier || []));

        const h2 = document.createElement('h3'); h2.textContent = 'Messaging Matrix';
        wrap.appendChild(h2);
        const headers = ['Persona', 'Pain', 'Value statement', 'Proof (ClaimIDs)', 'CTA'];
        const rows = rowsOf(block.matrix_rows).map(r => [
          r.persona || '',
          r.pain_from_top_blockers || '',
          r.value_statement || '',
          rowsOf(r.proof?.claim_ids || []).join(', '),
          r.cta || ''
        ]);
        wrap.appendChild(makeTable(headers, rows));

        setPanelContent(wrap);
      }

      function renderOffer() {
        const c = state.contract;
        const offer = c?.['3_campaign_output']?.['3.4_offer_strategy_and_assets'] || {};
        const wrap = document.createElement('div');

        // --- Landing Page Wire Copy (hero + CTAs)
        const h0 = document.createElement('h3');
        h0.textContent = 'Landing Page Wire Copy';
        wrap.appendChild(h0);

        const lp = offer.landing_page_wire_copy || {};
        const lpList = [
          'Outcome header: ' + (lp.outcome_header || ''),
          'Proof line: ' + (lp.proof_line || ''),
          'Primary CTA: ' + (lp.cta || '')
        ];
        if (lp.cta_secondary) lpList.push('Secondary CTA: ' + lp.cta_secondary);
        wrap.appendChild(makeList(lpList));

        // --- Why it matters (table with links)
        if (Array.isArray(lp.why_it_matters) && lp.why_it_matters.length) {
          const h1a = document.createElement('h3');
          h1a.textContent = 'Why it matters';
          wrap.appendChild(h1a);

          const headers = ['Insight', 'ClaimID', 'Publisher', 'URL'];
          const rows = lp.why_it_matters.map(i => [
            i?.text || '',
            i?.claim_id || '',
            i?.publisher || '',
            i?.url ? { __link: true, href: i.url, text: i.url } : ''
          ]);
          wrap.appendChild(makeTable(headers, rows));
        }

        // --- What you get (bulleted list)
        if (Array.isArray(lp.what_you_get) && lp.what_you_get.length) {
          const h1b = document.createElement('h3');
          h1b.textContent = 'What you get';
          wrap.appendChild(h1b);
          wrap.appendChild(makeList(lp.what_you_get));
        }

        // --- How it works (steps)
        if (Array.isArray(lp.how_it_works_steps) && lp.how_it_works_steps.length) {
          const h2 = document.createElement('h3');
          h2.textContent = 'How it works';
          wrap.appendChild(h2);
          wrap.appendChild(makeList(lp.how_it_works_steps));
        }

        // --- Outcomes grid (metric → claim IDs)
        if (Array.isArray(lp.outcomes_grid) && lp.outcomes_grid.length) {
          const h3 = document.createElement('h3');
          h3.textContent = 'Outcomes you can measure';
          wrap.appendChild(h3);

          const headers = ['Result / Metric', 'ClaimIDs'];
          const rows = lp.outcomes_grid.map(g => [
            g?.metric || g?.result || '',
            rowsOf(g?.claim_ids).join(', ')
          ]);
          wrap.appendChild(makeTable(headers, rows));
        }

        // --- Customer proof (short paragraph)
        if (lp.customer_proof) {
          const h4 = document.createElement('h3');
          h4.textContent = 'Customer proof';
          wrap.appendChild(h4);
          wrap.appendChild(makePre(lp.customer_proof));
        }

        // --- Substantiation & privacy
        if (lp.substantiation_note || lp.privacy_link) {
          const h5 = document.createElement('h3');
          h5.textContent = 'Substantiation & privacy';
          wrap.appendChild(h5);

          if (lp.substantiation_note) {
            const p = document.createElement('p');
            p.className = 'muted';
            p.textContent = lp.substantiation_note;
            wrap.appendChild(p);
          }
          if (lp.privacy_link) {
            const p = document.createElement('p');
            p.className = 'muted';
            const a = document.createElement('a');
            a.href = lp.privacy_link;
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = lp.privacy_link;
            p.appendChild(document.createTextNode('Privacy: '));
            p.appendChild(a);
            wrap.appendChild(p);
          }
        }

        // --- Assets checklist (unchanged)
        if (Array.isArray(offer.asset_checklist)) {
          const h6 = document.createElement('h3');
          h6.textContent = 'Assets Checklist';
          wrap.appendChild(h6);
          wrap.appendChild(makeList(offer.asset_checklist));
        }

        setPanelContent(wrap);
      }

      function renderChannel() {
        const c = state.contract;
        const plan = c?.['3_campaign_output']?.['3.5_channel_plan_and_orchestration'] || {};
        const wrap = document.createElement('div');

        const emails = rowsOf(plan.email_sequence);
        if (emails.length) {
          const h1 = document.createElement('h3'); h1.textContent = 'Emails';
          wrap.appendChild(h1);
          const headers = ['ID', 'Subject', 'Body', 'ClaimIDs'];
          const rows = emails.map(e => [e.id || '', e.subject || '', e.body_90_120_words || '', rowsOf(e.claim_ids_included).join(', ')]);
          wrap.appendChild(makeTable(headers, rows));
        }

        const li = plan.linkedin || {};
        const h2 = document.createElement('h3'); h2.textContent = 'LinkedIn';
        wrap.appendChild(h2);
        const liList = [
          'Connect note: ' + (li.connect_note || ''),
          'Insight post: ' + (li.insight_post?.copy || li.insight_post || ''),
          'DM with value asset: ' + (li.dm_with_value_asset?.copy || li.dm || ''),
          'Comment strategy: ' + (li.comment_strategy || '')
        ];
        wrap.appendChild(makeList(liList));

        const paid = rowsOf(plan.paid_optional?.variants);
        if (plan.paid_optional?.enabled && paid.length) {
          const h3 = document.createElement('h3'); h3.textContent = 'Paid (optional)';
          wrap.appendChild(h3);
          const headers = ['Variant', 'Quantified proof', 'ClaimID', 'CTA'];
          const rows = paid.map(p => [p.name || p.variant || '', p.quantified_proof || p.proof || '', p.claim_id || '', p.cta || '']);
          wrap.appendChild(makeTable(headers, rows));
        }

        const ev = plan.event_webinar || {};
        if (ev.concept || rowsOf(ev.agenda).length || rowsOf(ev.speakers).length) {
          const h4 = document.createElement('h3'); h4.textContent = 'Event / Webinar';
          wrap.appendChild(h4);
          const rows = [
            ['Concept', ev.concept || ''],
            ['Agenda', rowsOf(ev.agenda).join(', ')],
            ['Speakers', rowsOf(ev.speakers).join(', ')],
            ['Registration CTA', ev.registration_cta || '']
          ];
          wrap.appendChild(makeTable(['Field', 'Value'], rows));
        }

        setPanelContent(wrap);
      }

      function renderSalesEnablement() {
        const c = state.contract;
        const se = c?.['3_campaign_output']?.['3.6_sales_enablement_alignment'] || {};
        const wrap = document.createElement('div');

        const h1 = document.createElement('h3'); h1.textContent = 'Discovery Questions';
        wrap.appendChild(h1);
        wrap.appendChild(makeList(se.discovery_questions_5_to_7 || []));

        const h2 = document.createElement('h3'); h2.textContent = 'Objection Cards';
        wrap.appendChild(h2);
        const headers = ['Blocker', 'Reframe (evidence)', 'ClaimID', 'Proof', 'Risk reversal'];
        const rows = rowsOf(se.objection_cards).map(o => [o.blocker || '', o.reframe_with_evidence || '', o.claim_id || '', o.proof_case_metric || '', o.risk_reversal_mechanism || '']);
        wrap.appendChild(makeTable(headers, rows));

        const h3 = document.createElement('h3'); h3.textContent = 'Proof Pack Outline';
        wrap.appendChild(h3);
        const ppo = se.proof_pack_outline || {};
        const list = [];
        if (Array.isArray(ppo.case_studies)) list.push('Case studies: ' + ppo.case_studies.join(', '));
        if (ppo.one_pager) list.push('One-pager ClaimIDs: ' + rowsOf(ppo.one_pager.claim_ids).join(', '));
        wrap.appendChild(makeList(list.length ? list : []));

        const h4 = document.createElement('h3'); h4.textContent = 'Handoff Rules';
        wrap.appendChild(h4);
        wrap.appendChild(makePre(se.handoff_rules?.follow_up_sla || se.handoff_rules || ''));

        setPanelContent(wrap);
      }

      function renderMeasurement() {
        const c = state.contract;
        const m = c?.['3_campaign_output']?.['3.7_measurement_and_learning_plan'] || {};
        const wrap = document.createElement('div');

        const h1 = document.createElement('h3'); h1.textContent = 'KPIs';
        wrap.appendChild(h1);
        wrap.appendChild(makePre(JSON.stringify(m.kpis || {}, null, 2)));

        const h2 = document.createElement('h3'); h2.textContent = 'Weekly Test Plan';
        wrap.appendChild(h2);
        wrap.appendChild(makeList(m.weekly_test_plan || []));

        const h3 = document.createElement('h3'); h3.textContent = 'UTM & CRM Mapping';
        wrap.appendChild(h3);
        wrap.appendChild(makePre(JSON.stringify(m.utm_and_crm_mapping || {}, null, 2)));

        const h4 = document.createElement('h3'); h4.textContent = 'Evidence Freshness Rule';
        wrap.appendChild(h4);
        wrap.appendChild(makePre(m.evidence_freshness_rule || ''));

        setPanelContent(wrap);
      }

      function renderCompliance() {
        const c = state.contract;
        const cg = c?.['3_campaign_output']?.['3.8_compliance_and_governance'] || {};
        const wrap = document.createElement('div');

        const h1 = document.createElement('h3'); h1.textContent = 'Substantiation File';
        wrap.appendChild(h1);
        wrap.appendChild(makePre(JSON.stringify(cg.substantiation_file || {}, null, 2)));

        const h2 = document.createElement('h3'); h2.textContent = 'GDPR/PECR Checklist';
        wrap.appendChild(h2);
        wrap.appendChild(makeList(cg.gdpr_pecr_checklist || []));

        const h3 = document.createElement('h3'); h3.textContent = 'Brand & Accessibility Checks';
        wrap.appendChild(h3);
        wrap.appendChild(makeList(cg.brand_accessibility_checks || []));

        const h4 = document.createElement('h3'); h4.textContent = 'Approval Log';
        wrap.appendChild(h4);
        wrap.appendChild(makeList(cg.approval_log || []));

        setPanelContent(wrap);
      }

      function renderRisks() {
        const c = state.contract;
        const rc = c?.['3_campaign_output']?.['3.9_risks_and_contingencies'] || {};
        const wrap = document.createElement('div');

        const rows = rowsOf(rc.triggers_and_actions).map(x => [x.trigger || '', x.action || '']);
        const headers = ['Trigger', 'Action'];
        wrap.appendChild(makeTable(headers, rows));

        setPanelContent(wrap);
      }

      function renderOnePager() {
        const c = state.contract;
        const op = c?.['3_campaign_output']?.['3.10_one_page_campaign_summary'] || {};
        const wrap = document.createElement('div');

        const rows = [
          ['ICP', op.icp || ''],
          ['Offer', op.offer || ''],
          ['Message bullets (with proofs)', rowsOf(op.message_bullets_with_proofs).join('\n')],
          ['Channels & cadence', op.channels_and_cadence || ''],
          ['KPI targets', op.kpi_targets || ''],
          ['Start date', op.start_date || ''],
          ['Owners', rowsOf(op.owners).join(', ')],
          ['Next review date', op.next_review_date || '']
        ];
        const t = makeTable(['Field', 'Value'], rows);
        $$('.table td', t).forEach(td => td.style.whiteSpace = 'pre-wrap');
        wrap.appendChild(t);

        setPanelContent(wrap);
      }

      // Public API for the orchestrator
      window.CampaignUI = {
        setContract: function (contract_v1) {
          state.contract = contract_v1 || null;
          // Default to Executive Summary when new data arrives
          state.active = 'exec';
          mountTabs();
          renderActive();
        }
      };

      // Initial mount
      document.addEventListener('DOMContentLoaded', () => {
        mountTabs();
        // If your existing code drops the last result on window, adopt it without breaking anything
        if (window.lastResult) {
          window.CampaignUI.setContract(window.lastResult);
        }
      });
    })();
  </script>
</body>

</html>
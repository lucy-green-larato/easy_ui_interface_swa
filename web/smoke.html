<!doctype html>
<meta charset="utf-8" />
<title>Call Library — Smoke Test</title>
<style>
  :root { --muted:#6b7280; --ok:#0a7f2e; --err:#b00020 }
  body{font:14px/1.5 ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased;margin:24px}
  pre{background:#f6f7fb;border:1px solid #e5e7eb;padding:12px;border-radius:8px;white-space:pre-wrap}
  .row{margin:8px 0}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
</style>

<h1>Call Library — Smoke Test</h1>
<div class="row muted">This checks that <code>getIndex()</code> and <code>getCallScript()</code> work end-to-end.</div>
<div id="status" class="row">Running…</div>
<pre id="log"></pre>

<script type="module">
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const log = (...a) => { logEl.textContent += a.join(' ') + '\n'; };
  const ok  = (m) => { statusEl.textContent = m; statusEl.className = 'row ok'; };
  const bad = (m) => { statusEl.textContent = m; statusEl.className = 'row err'; };

  try {
    // Import the library from the web root. If your repo serves /web as site root,
    // the safer path is relative:
    const modPath = './src/lib/callLibrary.js';
    log('Importing', modPath, '…');
    const lib = await import(modPath);

    log('Exports:', Object.keys(lib).join(', '));

    // 1) INDEX
    const idx = await lib.getIndex();
    log('INDEX products:', JSON.stringify(idx?.products ?? [], null, 2));
    if (!Array.isArray(idx?.products) || idx.products.length === 0) {
      throw new Error('Index has no products. Make sure web/index.json exists and is valid.');
    }

    // Choose first product for a basic script lookup
    const first = idx.products[0];
    const lookup = {
      product: first.id,
      buyerType: lib.canonical.buyer('Early Adopter'),
      mode: lib.canonical.mode('Direct')
    };
    log('Lookup:', JSON.stringify(lookup, null, 2));

    // 2) SCRIPT
    const script = await lib.getCallScript(lookup);
    log('SCRIPT meta:', JSON.stringify(script?.meta ?? {}, null, 2));
    log('SCRIPT stages:', Object.keys(script?.stages ?? {}).join(', '));

    ok('OK — Library reachable and returning data.');
  } catch (e) {
    bad('FAILED — see log below.');
    log((e && e.stack) ? e.stack : String(e));
  }
</script>
smoke ok

<!doctype html>
<html lang="en" data-app="inside-track-tools">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · Lead Qualification</title>
  <link rel="stylesheet" href="./styles.css?v=fix4" />
  <style>
    .panel.middle .output-card {
      position: sticky;
      top: calc(var(--header-h) + 12px);
      z-index: 5;
    }

    .output {
      white-space: pre-wrap;
      background: #fff;
      color: #111827;
      border: 1px solid var(--border);
      padding: 14px;
      border-radius: 12px;
      min-height: 240px;
      outline: none;
      resize: vertical;
    }

    .status {
      margin-top: var(--s-2);
      min-height: 1.2rem;
      color: var(--text-2)
    }

    .status[data-kind="error"] {
      color: var(--danger)
    }

    .status[data-kind="ok"] {
      color: var(--ok)
    }

    .sources-list ul {
      margin: .5rem 0 0 1.1rem
    }

    /* logo sizing consistent with index */
    .logo {
      height: 44px;
      width: auto;
      display: block
    }

    @media (max-width:640px) {
      .logo {
        height: 36px
      }
    }

    /* action button group */
    .action-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .btn.secondary {
      background: #fff;
      border: 1px solid var(--border)
    }

    .btn.primary:disabled,
    .btn.secondary:disabled {
      opacity: .6;
      cursor: not-allowed
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header class="app-header" role="banner">
    <div class="header-left">
      <img class="logo" src="./assets/larato-logo.svg" alt="Larato" />
      <div class="brand-text">
        <h1 class="app-title">Inside Track Tools</h1>
        <p class="kicker">Lead qualification briefing</p>
      </div>
    </div>
    <div class="header-right">
      <label class="model-note" style="gap:.5rem">
        <input type="checkbox" id="remember"> Remember
      </label>
      <button id="help" class="btn inline" type="button" title="About this tool">Help</button>
      <span id="user-badge" class="badge is-hidden" aria-live="polite" aria-atomic="true">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="7" r="4"></circle>
          <path d="M4 22c0-4 4-7 8-7s8 3 8 7"></path>
        </svg>
        <span id="user-email">Loading…</span>
      </span>
    </div>
  </header>

  <!-- LAYOUT -->
  <main id="main" class="layout" role="main">
    <!-- LEFT: INPUTS -->
    <section class="panel left" aria-label="Input form">
      <form id="lq-form" novalidate>
        <!-- Seller details -->
        <fieldset class="card" aria-labelledby="legend-supplier">
          <legend id="legend-supplier">Your details</legend>
          <div class="grid-2">
            <div class="field">
              <label for="seller_name">Your name <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_name" name="seller_name" required autocomplete="name" />
              <p class="error" id="seller_name_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="seller_company">Your company <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_company" name="seller_company" required autocomplete="organization" />
              <p class="error" id="seller_company_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
          <div class="field">
            <label for="seller_url">Your company URL <span aria-hidden="true" class="req">*</span></label>
            <input id="seller_url" name="seller_url" type="url" placeholder="https://www.yourcompany.co.uk" required
              inputmode="url" autocomplete="url" />
            <p class="error" id="seller_url_error" role="alert" aria-live="polite"></p>
            <p class="help">Use the primary site or investor page. We’ll reference this when qualifying value.</p>
          </div>
        </fieldset>

        <!-- Seller proposition -->
        <fieldset class="card" aria-labelledby="legend-prop">
          <legend id="legend-prop">Your proposition</legend>
          <div class="grid-2">
            <div class="field">
              <label for="proposition_name">Proposition name <span aria-hidden="true" class="req">*</span></label>
              <input id="proposition_name" name="proposition_name" placeholder="e.g., Sentinel Cloud Security"
                required />
              <p class="error" id="proposition_name_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="proposition_type">Type <span aria-hidden="true" class="req">*</span></label>
              <select id="proposition_type" name="proposition_type" required>
                <option value="">Select…</option>
                <option>SaaS</option>
                <option>Security</option>
                <option>Connectivity</option>
                <option>Data Services</option>
                <option>Hardware</option>
                <option>Services</option>
                <option>Other</option>
              </select>
              <p class="error" id="proposition_type_error" role="alert" aria-live="polite"></p>
            </div>
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="typical_deal_size_gbp">Typical deal size (GBP)</label>
              <input id="typical_deal_size_gbp" name="typical_deal_size_gbp" type="number" min="0" step="100"
                placeholder="e.g., 25000" inputmode="numeric" />
            </div>
            <div class="field">
              <label for="territory_or_segment_focus">Territory / segment focus</label>
              <input id="territory_or_segment_focus" name="territory_or_segment_focus"
                placeholder="e.g., UK mid-market; 100–1000 employees" />
            </div>
          </div>

          <div class="field">
            <label for="differentiation_points">Differentiation (one per line, 3–5)</label>
            <textarea id="differentiation_points" name="differentiation_points" rows="3"
              placeholder="Faster deployment&#10;UK data residency&#10;SOC2 &amp; ISO27001"></textarea>
          </div>

          <div class="field">
            <label for="technical_prereqs">Technical prerequisites / integrations (one per line)</label>
            <textarea id="technical_prereqs" name="technical_prereqs" rows="3"
              placeholder="Azure AD&#10;Microsoft 365&#10;SAML 2.0"></textarea>
          </div>

          <div class="field">
            <label for="sales_motion">Sales motion <span aria-hidden="true" class="req">*</span></label>
            <select id="sales_motion" name="sales_motion" required>
              <option value="">Select…</option>
              <option value="direct">Direct to end-user</option>
              <option value="channel">Via the UK Channel</option>
              <option value="hybrid">Hybrid</option>
            </select>
            <p class="error" id="sales_motion_error" role="alert" aria-live="polite"></p>
          </div>
        </fieldset>

        <!-- Prospect details -->
        <fieldset class="card" aria-labelledby="legend-lead">
          <legend id="legend-lead">Lead details</legend>
          <div class="field">
            <label for="company">Prospect company <span aria-hidden="true" class="req">*</span></label>
            <input id="company" name="company" required placeholder="Acme Networks Ltd" />
            <p class="error" id="company_error" role="alert" aria-live="polite"></p>
          </div>
          <div class="grid-2">
            <div class="field">
              <label for="industry">Industry <span aria-hidden="true" class="req">*</span></label>
              <input id="industry" name="industry" required placeholder="Managed Services / Cybersecurity" />
              <p class="error" id="industry_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="company_reg">Company reg. no. (optional)</label>
              <input id="company_reg" name="company_reg" placeholder="e.g., 01234567" />
              <p class="help">If provided, the backend can fetch Companies House filings for the last two years.</p>
            </div>
          </div>
          <div class="field">
            <label for="website">Prospect website <span aria-hidden="true" class="req">*</span></label>
            <input id="website" name="website" type="url" placeholder="https://www.example.co.uk" required
              inputmode="url" autocomplete="url" />
            <p class="error" id="website_error" role="alert" aria-live="polite"></p>
          </div>
          <div class="field">
            <label for="sources">Sources (URLs, comma or newline)</label>
            <textarea id="sources" name="sources" rows="3"
              placeholder="Annual report, LinkedIn page, Press release…"></textarea>
            <p class="help">Paste links that should be prioritised in the analysis.</p>
          </div>
          <div class="field">
            <label for="partner_linkedin">Partner LinkedIn URL (optional)</label>
            <input id="partner_linkedin" name="partner_linkedin" type="url"
              placeholder="https://www.linkedin.com/company/…" inputmode="url" autocomplete="url" />
          </div>
        </fieldset>
      </form>
    </section>

    <!-- MIDDLE: OUTPUT -->
    <section class="panel middle">
      <div class="output-card card">
        <div class="output-head">
          <h2 id="output-title">Qualification summary<span id="run-mode" class="pill" hidden></span></h2>
          <div class="action-group">
            <button id="gen-deep" class="btn primary" type="button" disabled
              title="Full analysis with evidence and plans">
              Deep dive
              <span class="spinner" aria-hidden="true"></span>
            </button>
            <button id="gen-light" class="btn secondary" type="button" disabled
              title="Fast summary with bullets and a verdict">
              Light touch
              <span class="spinner" aria-hidden="true"></span>
            </button>
            <button id="copy" class="btn inline" type="button" disabled>Copy summary</button>
            <button id="download" class="btn inline" type="button" disabled>Download .txt</button>
          </div>
        </div>

        <div id="output" class="output" tabindex="0" aria-label="Generated summary will appear here">
          Add details on the left, then click <em>Deep dive</em> or <em>Light touch</em>.
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <details style="margin-top:var(--s-3)">
          <summary class="kicker">API response (raw)</summary>
          <pre id="responseBox" style="overflow:auto"></pre>
        </details>
      </div>
    </section>

    <!-- RIGHT: REFERENCE RAIL -->
    <section class="panel right" aria-labelledby="intel-title">
      <aside class="intel card">
        <div class="intel-head">
          <h2 id="intel-title">Reference</h2>
          <button id="toggle-rail" class="btn small" type="button" aria-expanded="true"
            aria-controls="rail-body">Hide</button>
        </div>
        <div id="rail-body">
          <section class="intel-slot">
            <h3>Signals to check</h3>
            <section class="intel-slot">
              <h3>Financials (iXBRL)</h3>
              <div id="ixbrlBox" class="muted">No financials fetched.</div>
            </section>
            <section class="intel-slot">
              <h3>Upload accounts (OCR)</h3>
              <input type="file" id="accounts_file" accept=".pdf,.txt" multiple />
              <div id="accounts_status" class="muted">No file uploaded.</div>
            </section>
            <ul>
              <li>Confidence in sales and marketing</li>
              <li>M&amp;A / restructuring announcements</li>
              <li>Contract renewals or vendor changes</li>
              <li>Portfolio completeness</li>
            </ul>
          </section>

          <section class="intel-slot sources-list">
            <h3>Your sources</h3>
            <div id="sourcesList" class="muted">No sources yet.</div>
          </section>

          <section class="intel-slot">
            <h3>Financials (iXBRL)</h3>
            <div id="ixbrlBox" class="muted">No financials fetched.</div>
          </section>

          <section class="intel-slot">
            <h3>What changed</h3>
            <div id="delta" class="muted">Run twice to see differences.</div>
          </section>

          <section class="intel-slot">
            <h3>Notes</h3>
            <textarea id="notes" rows="6" placeholder="Saved locally only."></textarea>
          </section>
        </div>
      </aside>
    </section>
  </main>

  <!-- Help Modal -->
  <dialog id="help-modal" class="modal">
    <div class="card" style="max-width:700px">
      <div class="row-between" style="align-items:center">
        <h3 style="margin:0">About Lead Qualification</h3>
        <button id="help-close" class="btn inline" type="button">Close ×</button>
      </div>
      <p>Provide your details, your proposition, and the prospect’s details. Choose <em>Deep dive</em> for a full
        analysis, or <em>Light touch</em> for a fast summary.</p>
      <ul>
        <li><strong>Your company URL</strong> is used to qualify value and proof points.</li>
        <li>Add <em>Sources</em> to steer the analysis (annual report, LinkedIn, press).</li>
        <li>Optionally include a <em>Company reg. no.</em> so the backend can fetch Companies House filings.</li>
      </ul>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js"></script>

  <script>
    // Tell pdf.js where to find its worker (same version as above)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js";
    }
  </script>

  <script>
    // ---------- Auth ----------
    (async () => {
      try {
        const r = await fetch("/.auth/me", { credentials: "include", cache: "no-store" });
        if (r.status === 401) {
          const here = encodeURIComponent(location.pathname + location.search + location.hash || "/");
          location.href = "/.auth/login/aad?post_login_redirect_uri=" + here;
          return;
        }
        const me = await r.json().catch(() => null);
        const email = me?.clientPrincipal?.userDetails
          || (me?.clientPrincipal?.claims || []).find(c => (c.typ || "").toLowerCase().includes("email"))?.val
          || "";
        if (email) {
          const badge = document.getElementById("user-badge");
          const el = document.getElementById("user-email");
          if (badge && el) { el.textContent = email; badge.classList.remove("is-hidden"); }
        }
      } catch { }
    })();

    // ---------- Refs ----------
    const $ = (id) => document.getElementById(id);
    const form = $("lq-form");
    const remember = $("remember");
    const output = $("output");
    const statusEl = $("status");
    const responseBox = $("responseBox");
    const copyBtn = $("copy");
    const downloadBtn = $("download");
    const deepBtn = $("gen-deep");
    const lightBtn = $("gen-light");

    const fields = [
      "seller_name", "seller_company", "seller_url",
      "proposition_name", "proposition_type", "typical_deal_size_gbp", "territory_or_segment_focus",
      "differentiation_points", "technical_prereqs", "sales_motion",
      "company", "company_reg", "industry", "website", "sources", "notes"
    ];
    const STORAGE_KEY = "lead_qualification_v2.form";
    let lastSummary = localStorage.getItem("lead_qualification_v2.last_summary") || "";
    // B2: iXBRL state + helpers
    let ixbrlSummary = null;

    async function fetchIxbrlIfReady() {
      const reg = $("company_reg").value.trim();
      // Basic UK reg no. sanity check (6–8 digits)
      if (!/^[A-Z0-9]{6,8}$/i.test(reg)) {
        ixbrlSummary = null;
        const box = $("ixbrlBox");
        if (box) box.textContent = "No reg no. / not valid.";
        return;
      }
      const box = $("ixbrlBox");
      if (box) box.textContent = "Fetching…";
      try {
        const r = await fetch(`/api/ixbrl/financials?companyNumber=${encodeURIComponent(reg)}`, { cache: "no-store" });
        if (r.status === 204) {
          ixbrlSummary = null;
          if (box) box.textContent = "No iXBRL available for this company.";
          return;
        }
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        ixbrlSummary = data?.summary || null;
        if (!ixbrlSummary) {
          if (box) box.textContent = "No data returned.";
          return;
        }
        const y1 = ixbrlSummary.years?.[0], y2 = ixbrlSummary.years?.[1];
        const d = ixbrlSummary.derived || {};
        if (box) {
          box.innerHTML =
            (y1 ? `<div><strong>${y1.endDate || "Latest"}</strong>: turnover ${fmt(y1.turnover)}, op ${fmt(y1.operatingProfit)}, net assets ${fmt(y1.netAssets)}</div>` : "") +
            (y2 ? `<div><strong>${y2.endDate}</strong>: turnover ${fmt(y2.turnover)}, op ${fmt(y2.operatingProfit)}, net assets ${fmt(y2.netAssets)}</div>` : "") +
            `<div class="muted">YoY: ${fmtPct(d.revenueYoYPct)} • GM%: ${fmtPct(d.grossMarginPct?.y1)} • OPM%: ${fmtPct(d.operatingMarginPct?.y1)} • Current: ${fmtDec(d.currentRatio)} • Cash: ${fmtDec(d.cashRatio)}</div>`;
        }
      } catch (e) {
        ixbrlSummary = null;
        if (box) box.textContent = "Fetch failed.";
      }
    }

    function fmt(n) { return (n == null) ? "—" : new Intl.NumberFormat("en-GB").format(n); }
    function fmtPct(n) { return (n == null) ? "—" : new Intl.NumberFormat("en-GB", { maximumFractionDigits: 1 }).format(n) + "%"; }
    function fmtDec(n) { return (n == null) ? "—" : new Intl.NumberFormat("en-GB", { maximumFractionDigits: 2 }).format(n); }

    // ---------- Utilities ----------
    const setStatus = (msg, kind = "info") => { statusEl.textContent = msg || ""; statusEl.dataset.kind = kind; };
    const safeURL = (u) => { try { const x = new URL(u); return x.protocol === "http:" || x.protocol === "https:"; } catch { return false; } };
    const srcArray = () => (($("sources").value || "").split(/\n|,/).map(s => s.trim()).filter(Boolean));
    const lines = (t) => (t || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);

    function validateInline() {
      const req = {
        seller_name: !!$("seller_name").value.trim(),
        seller_company: !!$("seller_company").value.trim(),
        seller_url: safeURL($("seller_url").value.trim()),
        proposition_name: !!$("proposition_name").value.trim(),
        proposition_type: !!$("proposition_type").value.trim(),
        sales_motion: !!$("sales_motion").value.trim(),
        company: !!$("company").value.trim(),
        industry: !!$("industry").value.trim(),
        website: safeURL($("website").value.trim()),
      };
      $("seller_name_error").textContent = req.seller_name ? "" : "This field is required.";
      $("seller_company_error").textContent = req.seller_company ? "" : "This field is required.";
      $("seller_url_error").textContent = req.seller_url ? "" : "Enter a valid URL (https://…).";
      $("proposition_name_error").textContent = req.proposition_name ? "" : "This field is required.";
      $("proposition_type_error").textContent = req.proposition_type ? "" : "This field is required.";
      $("sales_motion_error").textContent = req.sales_motion ? "" : "Select a motion.";
      $("company_error").textContent = req.company ? "" : "This field is required.";
      $("industry_error").textContent = req.industry ? "" : "This field is required.";
      $("website_error").textContent = req.website ? "" : "Enter a valid URL (https://…).";

      const ok = Object.values(req).every(Boolean);
      deepBtn.disabled = !ok;
      lightBtn.disabled = !ok;
      return ok;
    }

    function updateRunModePill(mode, motion) {
      const el = $("run-mode");
      if (!el) return;
      const niceMode = mode === "light" ? "Light touch" : "Deep dive";
      const niceMotion = (motion || "").trim();
      el.textContent = niceMotion ? `${niceMode} (${niceMotion})` : niceMode;
      el.dataset.kind = (mode === "light" ? "light" : "deep");
      el.hidden = false;
    }

    function updateSourcesList() {
      const arr = srcArray();
      $("sourcesList").innerHTML = arr.length
        ? '<ul>' + arr.map(a => `<li><a href="${a}" target="_blank" rel="noopener">${a}</a></li>`).join("") + '</ul>'
        : 'No sources yet.';
    }

    function basePayload() {
      if (!validateInline()) return null;
      const srcRaw = $("sources").value || "";
      return {
        pack: "uk_b2b_sales_core",
        variables: {
          // seller context
          seller_name: $("seller_name").value.trim(),
          seller_company: $("seller_company").value.trim(),
          seller_url: $("seller_url").value.trim(),
          proposition_name: $("proposition_name").value.trim(),
          proposition_type: $("proposition_type").value.trim(),
          typical_deal_size_gbp: $("typical_deal_size_gbp").value ? Number($("typical_deal_size_gbp").value) : null,
          territory_or_segment_focus: $("territory_or_segment_focus").value.trim(),
          differentiation_points: lines($("differentiation_points").value),
          technical_prerequisites: lines($("technical_prereqs").value),
          sales_motion: $("sales_motion").value.trim(),
          ixbrl: ixbrlSummary,   // ← include compact iXBRL summary when available

          // prospect inputs
          company: $("company").value.trim(),
          company_registration_number: $("company_reg").value.trim(),
          industry: $("industry").value.trim(),
          website: $("website").value.trim(),
          sources_raw: srcRaw,
          sources: srcArray(),
          ixbrl: window.ixbrlSummary || null
        }
      };
    }

    function saveForm() {
      if (!remember.checked) return;
      const fd = Object.fromEntries(new FormData(form).entries());
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fd));
    }
    function loadForm() {
      if (localStorage.getItem(STORAGE_KEY)) remember.checked = true;
      try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        Object.entries(data).forEach(([k, v]) => {
          const el = form.elements[k] || $(k);
          if (el) el.value = v;
        });
      } catch { }
    }

    function diffText(oldT, newT) {
      if (!oldT) return "Run again to see differences.";
      if (oldT === newT) return "No changes.";
      const o = new Set(oldT.split(/\r?\n/));
      const n = new Set(newT.split(/\r?\n/));
      const added = [...n].filter(l => !o.has(l) && l.trim()).slice(0, 6);
      const removed = [...o].filter(l => !n.has(l) && l.trim()).slice(0, 6);
      let s = "";
      if (added.length) s += "Added:\n• " + added.join("\n• ") + "\n";
      if (removed.length) s += "Removed:\n• " + removed.join("\n• ");
      return s.trim();
    }
    function setSummary(text) {
      output.textContent = text || "";
      const has = !!(text && text.trim());
      copyBtn.disabled = !has; downloadBtn.disabled = !has;
      if (has) {
        $("delta").textContent = diffText(lastSummary, text) || "—";
        lastSummary = text;
        localStorage.setItem("lead_qualification_v2.last_summary", text);
      }
    }

    async function sendRequest(templateName) {
      const payload = (typeof basePayload === "function" ? basePayload() : buildPayload());
      if (!payload) return;
      payload.template = templateName;

      setStatus("Generating…");
      responseBox.textContent = "Sending…";

      const motion = ($("sales_motion").value || "").trim().toLowerCase();
      const optimisticMode = templateName === "opportunity_qualification_light" ? "light" : "deep";
      updateRunModePill(optimisticMode, motion);

      // Only show the spinner on the clicked button (but disable both)
      const activeBtn = (templateName === "opportunity_qualification_light") ? lightBtn : deepBtn;
      const disable = (v) => {
        [deepBtn, lightBtn].forEach(b => { if (b) b.disabled = v; });
        if (activeBtn) activeBtn.classList.toggle("busy", v);
      };
      disable(true);

      try {
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const errText = await res.text().catch(() => "");
          throw new Error(errText || res.statusText);
        }

        const srvMode = res.headers.get("x-qual-mode") || optimisticMode;
        const srvMotion = res.headers.get("x-qual-motion") || motion;
        updateRunModePill(srvMode, srvMotion);

        const text = await res.text();     // read once
        setSummary(text);
        responseBox.textContent = text;

        setStatus(`Done. Ran: ${srvMode === "light" ? "Light touch" : "Deep dive"}${srvMotion ? ` (${srvMotion})` : ""}.`, "ok");
      } catch (e) {
        setSummary("");
        responseBox.textContent = "Request failed: " + (e?.message || String(e));
        setStatus("Could not generate a qualification summary.", "error");
      } finally {
        disable(false);
        if (typeof saveForm === "function") saveForm();
      }
    }

    // ---------- Events ----------
    fields.forEach(id => ($(id)?.addEventListener?.("input", () => {
      validateInline();
      if (id === "sources") updateSourcesList();
      saveForm();
    })));

    // iXBRL triggers
    $("company_reg").addEventListener("blur", fetchIxbrlIfReady);
    $("company_reg").addEventListener("input", () => {
      const box = $("ixbrlBox");
      if (box) box.textContent = "—";
    });

    $("toggle-rail")?.addEventListener("click", () => {
      const btn = $("toggle-rail");
      const body = $("rail-body");
      const expanded = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", String(!expanded));
      body.hidden = expanded;
      btn.textContent = expanded ? "Show" : "Hide";
    });

    $("help")?.addEventListener("click", () => $("help-modal")?.showModal());
    $("help-close")?.addEventListener("click", () => $("help-modal")?.close());

    deepBtn.addEventListener("click", () => sendRequest("opportunity_qualification"));
    lightBtn.addEventListener("click", () => sendRequest("opportunity_qualification_light"));

    copyBtn.addEventListener("click", async () => {
      const txt = output?.innerText || ""; if (!txt.trim()) return;
      await navigator.clipboard.writeText(txt);
      setStatus("Copied summary to clipboard.", "ok");
    });

    downloadBtn.addEventListener("click", () => {
      const txt = output?.innerText || ""; if (!txt.trim()) return;
      const name = ($("company").value || "qualification").trim().replace(/\s+/g, "-");
      const blob = new Blob([txt], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `lead-qualification_${name}_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });

    remember.addEventListener("change", () => {
      if (!remember.checked) localStorage.removeItem(STORAGE_KEY); else saveForm();
    });

    // ——— Right-rail financials state ———
    window.ixbrlSummary = window.ixbrlSummary || null;

    // Render the little financials box. Guarded so no duplicate-declare.
    window.renderIxbrlBox = window.renderIxbrlBox || function (sum) {
      const fmt = (v) => v == null ? "n/a" : new Intl.NumberFormat("en-GB").format(v);
      const fmtPct = (v) => v == null ? "n/a" : (typeof v === "number" ? v.toFixed(1) + "%" : v);
      const fmtDec = (v) => v == null ? "n/a" : (Number.isFinite(+v) ? Number(v).toFixed(2) : "n/a");

      const y1 = sum?.years?.[0];
      const y2 = sum?.years?.[1];
      const d = sum?.derived || {};
      return [
        y1 ? `<div><strong>${y1.endDate || "Latest"}</strong>: turnover ${fmt(y1.turnover)}, op ${fmt(y1.operatingProfit)}, net assets ${fmt(y1.netAssets)}</div>` : "",
        y2 ? `<div><strong>${y2.endDate}</strong>: turnover ${fmt(y2.turnover)}, op ${fmt(y2.operatingProfit)}, net assets ${fmt(y2.netAssets)}</div>` : "",
        `<div class="muted">GM%: ${fmtPct(d.grossMarginPct?.y1)} • OPM%: ${fmtPct(d.operatingMarginPct?.y1)} • Current: ${fmtDec(d.currentRatio)} • Cash: ${fmtDec(d.cashRatio)}</div>`
      ].filter(Boolean).join("");
    };

    // Fetch iXBRL from your backend when a valid reg no. is present. Guarded.
    window.fetchIxbrlIfReady = window.fetchIxbrlIfReady || (async function fetchIxbrlIfReady() {
      const box = document.getElementById("ixbrlBox");
      const reg = (document.getElementById("company_reg")?.value || "").trim();
      if (!box) return;

      // Allow 6–8 alphanumeric CRNs (e.g., SC123456); tighten if you prefer digits only.
      if (!/^[A-Z0-9]{6,8}$/i.test(reg)) {
        box.textContent = "No reg no. / not valid.";
        return;
      }

      box.textContent = "Fetching…";
      try {
        const r = await fetch(`/api/ixbrl/financials?companyNumber=${encodeURIComponent(reg)}`, { cache: "no-store" });
        if (r.status === 204) {
          box.textContent = "No iXBRL available for this company.";
          window.ixbrlSummary = null;
          return;
        }
        if (!r.ok) {
          const t = await r.text().catch(() => "");
          box.textContent = "Upstream error.";
          console.warn("ixbrl error:", r.status, t);
          window.ixbrlSummary = null;
          return;
        }
        const data = await r.json();
        window.ixbrlSummary = data?.summary || null;
        box.innerHTML = window.ixbrlSummary ? window.renderIxbrlBox(window.ixbrlSummary) : "No financials found.";
      } catch (e) {
        box.textContent = "Fetch failed.";
        console.error(e);
        window.ixbrlSummary = null;
      }
    });

    // Connect the reg-no field to the fetcher (on blur)
    document.getElementById("company_reg")?.addEventListener("blur", () => {
      try { window.fetchIxbrlIfReady(); } catch { }
    });

    // Multi-file OCR upload handler (only wires the input; assumes you already added the parser).
    document.getElementById("accounts_file")?.addEventListener("change", (e) => {
      const files = Array.from(e.target?.files || []);
      if (!files.length) return;
      // If you already pasted the multi-file OCR parser: parseAccountsFiles(files)
      // If not yet, leave this as a placeholder; we can wire it when you’re ready.
      if (typeof parseAccountsFiles === "function") {
        parseAccountsFiles(files);
      } else {
        document.getElementById("accounts_status").textContent =
          "Parser not wired yet. (We’ll add it next.)";
      }
    });

    // ---------- OCR parser (multi-file) ----------
    (function () {
      // Don’t redefine if already present
      if (window.parseAccountsFiles) return;

      // Fallback formatters (use your existing ones if present)
      const fmt = window.fmt || (v => v == null ? "n/a" : new Intl.NumberFormat("en-GB").format(v));
      const fmtPct = window.fmtPct || (v => v == null ? "n/a" : (typeof v === "number" ? v.toFixed(1) + "%" : v));
      const fmtDec = window.fmtDec || (v => v == null ? "n/a" : (Number.isFinite(+v) ? Number(v).toFixed(2) : "n/a"));

      async function readPdfText(file) {
        if (!window.pdfjsLib) throw new Error("pdf.js not loaded");
        const url = URL.createObjectURL(file);
        try {
          const pdf = await pdfjsLib.getDocument(url).promise;
          const maxPages = Math.min(pdf.numPages, 8);
          let text = "";
          for (let p = 1; p <= maxPages; p++) {
            const page = await pdf.getPage(p);
            const content = await page.getTextContent();
            text += "\n" + content.items.map(it => it.str).join(" ");
          }
          return text;
        } finally { URL.revokeObjectURL(url); }
      }

      function lastNumberIn(s) {
        const matches = String(s || "").match(/[-(]?\s*£?\d[\d,]*\)?/g);
        if (!matches) return null;
        let raw = matches[matches.length - 1].replace(/[£,\s]/g, "");
        const neg = raw.startsWith("(") && raw.endsWith(")");
        raw = raw.replace(/[()]/g, "");
        const n = Number(raw);
        return Number.isFinite(n) ? (neg ? -n : n) : null;
      }

      function findVal(lines, labels) {
        const rx = new RegExp("\\b(" + labels.join("|").replace(/\s+/g, "\\s+") + ")\\b", "i");
        for (const line of lines) {
          if (rx.test(line)) {
            const v = lastNumberIn(line);
            if (v != null) return v;
          }
        }
        return null;
      }

      function parseEndDateToISO(s) {
        if (!s) return null;
        const dmy = s.match(/^([0-3]?\d)[\/\-]([01]?\d)[\/\-](\d{4})$/);
        if (dmy) {
          const [_, d, m, y] = dmy;
          return `${y}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        }
        const dt = new Date(s);
        return isNaN(dt.getTime()) ? null :
          `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}-${String(dt.getDate()).padStart(2, "0")}`;
      }

      function findEndDate(text) {
        const m = String(text || "").match(/\b(year\s+ended|for\s+the\s+year\s+ended)\s+([0-3]?\d[\/\-\s][A-Za-z]{3,9}[\/\-\s]\d{4}|[0-3]?\d[\/\-][01]?\d[\/\-]\d{4})/i);
        return m ? parseEndDateToISO(m[2].replace(/\s+/g, " ").trim()) : null;
      }

      function extractYearFromText(text) {
        if (!text || text.length < 200) return null;
        const lines = String(text).split(/\r?\n/).map(s => s.trim()).filter(Boolean);

        const turnover = findVal(lines, ["Turnover", "Revenue"]);
        const grossProfit = findVal(lines, ["Gross profit"]);
        const operatingProfit = findVal(lines, ["Operating profit", "Operating (loss)", "Operating loss"]);
        const pbt = findVal(lines, ["Profit before tax", "(Loss) before tax", "(loss) before taxation"]);
        const pat = findVal(lines, ["Profit for the financial year", "(Loss) for the financial year", "Profit for the year", "(Loss) for the year"]);
        const netAssets = findVal(lines, ["Net assets", "Net (liabilities)", "Net liabilities"]);
        const cash = findVal(lines, ["Cash at bank", "Cash and cash equivalents"]);
        const currentAssets = findVal(lines, ["Current assets"]);
        const currentLiabs = findVal(lines, ["Current liabilities"]);
        const totalAssets = findVal(lines, ["Total assets", "Total assets less current liabilities"]);
        const totalLiabs = findVal(lines, ["Total liabilities", "Total creditors"]);
        const endDate = findEndDate(text);

        if (turnover == null && operatingProfit == null && netAssets == null && currentAssets == null) return null;

        return {
          endDate, turnover, grossProfit, operatingProfit,
          profitBeforeTax: pbt, profitAfterTax: pat,
          cash, currentAssets, currentLiabilities: currentLiabs,
          totalAssets, totalLiabilities, totalDebt: null,
          netAssets
        };
      }

      function mergeYearsToSummary(years) {
        const byKey = new Map();
        for (const y of years) {
          if (!y || !y.endDate) continue;
          const k = y.endDate;
          if (!byKey.has(k)) { byKey.set(k, { ...y }); }
          else {
            const cur = byKey.get(k);
            for (const f of Object.keys(y)) if (cur[f] == null && y[f] != null) cur[f] = y[f];
          }
        }
        const merged = [...byKey.values()]
          .sort((a, b) => String(b.endDate).localeCompare(String(a.endDate)))
          .slice(0, 2);

        const y1 = merged[0], y2 = merged[1];
        const derived = {
          revenueYoYPct: (y1?.turnover != null && y2?.turnover != null && y2.turnover !== 0)
            ? ((y1.turnover - y2.turnover) / Math.abs(y2.turnover)) * 100 : null,
          grossMarginPct: {
            y1: (y1?.turnover && y1?.grossProfit != null) ? (y1.grossProfit / y1.turnover) * 100 : null,
            y2: (y2?.turnover && y2?.grossProfit != null) ? (y2.grossProfit / y2.turnover) * 100 : null
          },
          operatingMarginPct: {
            y1: (y1?.turnover && y1?.operatingProfit != null) ? (y1.operatingProfit / y1.turnover) * 100 : null,
            y2: (y2?.turnover && y2?.operatingProfit != null) ? (y2.operatingProfit / y2.turnover) * 100 : null
          },
          currentRatio: (y1?.currentAssets && y1?.currentLiabilities) ? (y1.currentAssets / y1.currentLiabilities) : null,
          cashRatio: (y1?.cash && y1?.currentLiabilities) ? (y1.cash / y1.currentLiabilities) : null,
          netDebtToEquity: (y1?.totalDebt != null && y1?.netAssets) ? (y1.totalDebt / y1.netAssets) : null
        };

        return { companyNumber: "manual-upload", years: merged, derived };
      }

      // Only define renderer if you don’t already have one
      if (!window.renderIxbrlBox) {
        window.renderIxbrlBox = function (sum) {
          const y1 = sum?.years?.[0];
          const y2 = sum?.years?.[1];
          const d = sum?.derived || {};
          return [
            y1 ? `<div><strong>${y1.endDate || "Latest"}</strong>: turnover ${fmt(y1.turnover)}, op ${fmt(y1.operatingProfit)}, net assets ${fmt(y1.netAssets)}</div>` : "",
            y2 ? `<div><strong>${y2.endDate}</strong>: turnover ${fmt(y2.turnover)}, op ${fmt(y2.operatingProfit)}, net assets ${fmt(y2.netAssets)}</div>` : "",
            `<div class="muted">GM%: ${fmtPct(d.grossMarginPct?.y1)} • OPM%: ${fmtPct(d.operatingMarginPct?.y1)} • Current: ${fmtDec(d.currentRatio)} • Cash: ${fmtDec(d.cashRatio)}</div>`
          ].filter(Boolean).join("");
        };
      }

      async function parseOneFileToYear(file) {
        const isPdf = (file.type || "").includes("pdf") || file.name.toLowerCase().endsWith(".pdf");
        const text = isPdf ? await readPdfText(file) : await file.text();
        return extractYearFromText(text);
      }

      async function parseAccountsFiles(files) {
        const status = document.getElementById("accounts_status");
        const box = document.getElementById("ixbrlBox");
        if (!files || !files.


    // ---------- Init ----------
    (function init() {
          loadForm();
          validateInline();
          updateSourcesList();

          try {
            $("notes").value = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}").notes || "";
          } catch { }

          $("notes").addEventListener("input", saveForm);

          // If a reg no. is already present, fetch iXBRL now
          if ($("company_reg").value.trim()) {
            fetchIxbrlIfReady();
          }
        })();
  </script>
</body>

</html>
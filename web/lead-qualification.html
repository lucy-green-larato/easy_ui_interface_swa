<!doctype html>
<html lang="en" data-app="inside-track-tools">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · Lead Qualification</title>
  <!-- Use your shared stylesheet from the Call Script page -->
  <link rel="stylesheet" href="./styles.css?v=fix4" />
  <style>
    /* Minor page-specific trims only (everything else comes from styles.css) */
    .panel.middle .output-card{ position: sticky; top: calc(var(--header-h) + 12px); z-index: 5; }
    .output{ white-space:pre-wrap; background:#fff; color:#111827; border:1px solid var(--border);
             padding:14px; border-radius:12px; min-height:240px; outline:none; resize:vertical; }
    .status{ margin-top:var(--s-2); min-height:1.2rem; color:var(--text-2) }
    .status[data-kind="error"]{ color: var(--danger) }
    .status[data-kind="ok"]{ color: var(--ok) }
    .sources-list ul{ margin:.5rem 0 0 1.1rem }
  </style>
</head>
<body>

  <!-- HEADER (same pattern as your call-script tool) -->
  <header class="app-header" role="banner">
    <div class="header-left">
      <img class="logo" src="./larato-logo.svg" alt="Larato" />
      <div class="brand-text">
        <h1 class="app-title">Inside Track Tools</h1>
        <p class="kicker">Lead qualification briefing</p>
      </div>
    </div>
    <div class="header-right">
      <label class="model-note" style="gap:.5rem">
        <input type="checkbox" id="remember"> Remember
      </label>
      <button id="help" class="btn inline" type="button" title="About this tool">Help</button>
      <span id="user-badge" class="badge is-hidden" aria-live="polite" aria-atomic="true">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="7" r="4"></circle>
          <path d="M4 22c0-4 4-7 8-7s8 3 8 7"></path>
        </svg>
        <span id="user-email">Loading…</span>
      </span>
      <a class="btn inline" href="/.auth/logout">Sign out</a>
    </div>
  </header>

  <!-- LAYOUT -->
  <main id="main" class="layout" role="main">
    <!-- LEFT: INPUTS -->
    <section class="panel left" aria-label="Input form">
      <form id="lq-form" novalidate>
        <!-- Supplier (your) details -->
        <fieldset class="card" aria-labelledby="legend-supplier">
          <legend id="legend-supplier">Your details</legend>
          <div class="grid-2">
            <div class="field">
              <label for="seller_name">Your name <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_name" name="seller_name" required autocomplete="name" />
              <p class="error" id="seller_name_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="seller_company">Your company <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_company" name="seller_company" required autocomplete="organization" />
              <p class="error" id="seller_company_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
          <div class="field">
            <label for="seller_url">Your company URL <span aria-hidden="true" class="req">*</span></label>
            <input id="seller_url" name="seller_url" type="url" placeholder="https://www.yourcompany.co.uk" required inputmode="url" autocomplete="url" />
            <p class="error" id="seller_url_error" role="alert" aria-live="polite"></p>
            <p class="help">Use the primary site or investor page. We’ll reference this when qualifying value.</p>
          </div>
        </fieldset>

        <!-- Prospect details -->
        <fieldset class="card" aria-labelledby="legend-lead">
          <legend id="legend-lead">Lead details</legend>
          <div class="field">
            <label for="company">Prospect company <span aria-hidden="true" class="req">*</span></label>
            <input id="company" name="company" required placeholder="Acme Networks Ltd" />
            <p class="error" id="company_error" role="alert" aria-live="polite"></p>
          </div>
          <div class="field">
            <label for="industry">Industry <span aria-hidden="true" class="req">*</span></label>
            <input id="industry" name="industry" required placeholder="Managed Services / Cybersecurity" />
            <p class="error" id="industry_error" role="alert" aria-live="polite"></p>
          </div>
          <div class="field">
            <label for="website">Prospect website <span aria-hidden="true" class="req">*</span></label>
            <input id="website" name="website" type="url" placeholder="https://www.example.co.uk" required inputmode="url" autocomplete="url" />
            <p class="error" id="website_error" role="alert" aria-live="polite"></p>
          </div>
          <div class="field">
            <label for="sources">Sources (URLs, comma or newline)</label>
            <textarea id="sources" name="sources" rows="3" placeholder="Annual report, LinkedIn page, Press release…"></textarea>
            <p class="help">Paste links that should be prioritised in the analysis.</p>
          </div>
        </fieldset>
      </form>
    </section>

    <!-- MIDDLE: OUTPUT -->
    <section class="panel middle">
      <div class="output-card card">
        <div class="output-head">
          <h2 id="output-title">Qualification summary</h2>
          <div class="row-between" style="gap:8px">
            <button id="generate" class="btn primary" type="button" disabled>
              <span class="btn-label">Generate qualification</span>
              <span class="spinner" aria-hidden="true"></span>
            </button>
            <button id="copy" class="btn inline" type="button" disabled>Copy summary</button>
            <button id="download" class="btn inline" type="button" disabled>Download .txt</button>
            <button id="viewPayload" class="btn inline" type="button">View payload</button>
          </div>
        </div>

        <div id="output" class="output" tabindex="0" aria-label="Generated summary will appear here">
          Add details on the left, then click <em>Generate qualification</em>.
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <details id="payloadWrap" style="margin-top:var(--s-3)">
          <summary class="kicker">Payload preview</summary>
          <pre id="previewBox" style="overflow:auto"></pre>
        </details>

        <details style="margin-top:var(--s-3)">
          <summary class="kicker">API response (raw)</summary>
          <pre id="responseBox" style="overflow:auto"></pre>
        </details>
      </div>
    </section>

    <!-- RIGHT: REFERENCE RAIL -->
    <section class="panel right" aria-labelledby="intel-title">
      <aside class="intel card">
        <div class="intel-head">
          <h2 id="intel-title">Reference</h2>
          <button id="toggle-rail" class="btn small" type="button" aria-expanded="true" aria-controls="rail-body">Hide</button>
        </div>
        <div id="rail-body">
          <section class="intel-slot">
            <h3>Signals to check</h3>
            <ul>
              <li>Hiring spikes in engineering/IT</li>
              <li>M&amp;A / restructuring announcements</li>
              <li>Contract renewals or vendor changes</li>
              <li>Certifications / compliance events</li>
              <li>Cloud migrations or refresh cycles</li>
            </ul>
          </section>

          <section class="intel-slot sources-list">
            <h3>Your sources</h3>
            <div id="sourcesList" class="muted">No sources yet.</div>
          </section>

          <section class="intel-slot">
            <h3>What changed</h3>
            <div id="delta" class="muted">Run twice to see differences.</div>
          </section>

          <section class="intel-slot">
            <h3>Notes</h3>
            <textarea id="notes" rows="6" placeholder="Saved locally only."></textarea>
          </section>
        </div>
      </aside>
    </section>
  </main>

  <!-- Simple Help Modal -->
  <dialog id="help-modal" class="modal">
    <div class="card" style="max-width:700px">
      <div class="row-between" style="align-items:center">
        <h3 style="margin:0">About Lead Qualification</h3>
        <button id="help-close" class="btn inline" type="button">Close ×</button>
      </div>
      <p>Provide your supplier details and the prospect’s details. We’ll generate a concise
        qualification summary that weighs your value against the prospect’s context and signals.</p>
      <ul>
        <li><strong>Your company URL</strong> is used to qualify value and proof points.</li>
        <li>Add <em>Sources</em> to steer the analysis (annual report, LinkedIn, press).</li>
      </ul>
    </div>
  </dialog>

  <script>
    // ---------- Auth ----------
    (async () => {
      try{
        const r = await fetch("/.auth/me", { credentials:"include", cache:"no-store" });
        if (r.status === 401) {
          const here = encodeURIComponent(location.pathname + location.search + location.hash || "/");
          location.href = "/.auth/login/aad?post_login_redirect_uri=" + here;
          return;
        }
        const me = await r.json().catch(()=>null);
        const email = me?.clientPrincipal?.userDetails
          || (me?.clientPrincipal?.claims||[]).find(c => (c.typ||"").toLowerCase().includes("email"))?.val
          || "";
        if (email) {
          const badge = document.getElementById("user-badge");
          const el = document.getElementById("user-email");
          if (badge && el) { el.textContent = email; badge.classList.remove("is-hidden"); }
        }
      }catch{}
    })();

    // ---------- Refs ----------
    const $ = (id)=>document.getElementById(id);
    const form = $("lq-form");
    const remember = $("remember");
    const output = $("output");
    const statusEl = $("status");
    const generateBtn = $("generate");
    const copyBtn = $("copy");
    const downloadBtn = $("download");
    const previewBox = $("previewBox");
    const responseBox = $("responseBox");
    const payloadWrap = $("payloadWrap");

    const fields = ["seller_name","seller_company","seller_url","company","industry","website","sources","notes"];
    const STORAGE_KEY = "lead_qualification_v2.form";
    let lastSummary = localStorage.getItem("lead_qualification_v2.last_summary") || "";

    // ---------- Utilities ----------
    const setStatus = (msg, kind="info") => {
      statusEl.textContent = msg || "";
      statusEl.dataset.kind = kind;
    };
    const safeURL = (u) => { try{ const x = new URL(u); return x.protocol==="http:"||x.protocol==="https:"; } catch { return false; } };
    const srcArray = () => ( ($("sources").value || "").split(/\n|,/).map(s=>s.trim()).filter(Boolean) );

    function validateInline(){
      const req = {
        seller_name: !!$("seller_name").value.trim(),
        seller_company: !!$("seller_company").value.trim(),
        seller_url: safeURL($("seller_url").value.trim()),
        company: !!$("company").value.trim(),
        industry: !!$("industry").value.trim(),
        website: safeURL($("website").value.trim()),
      };
      $("seller_name_error").textContent = req.seller_name ? "" : "This field is required.";
      $("seller_company_error").textContent = req.seller_company ? "" : "This field is required.";
      $("seller_url_error").textContent = req.seller_url ? "" : "Enter a valid URL (https://…).";
      $("company_error").textContent = req.company ? "" : "This field is required.";
      $("industry_error").textContent = req.industry ? "" : "This field is required.";
      $("website_error").textContent = req.website ? "" : "Enter a valid URL (https://…).";

      const ok = Object.values(req).every(Boolean);
      generateBtn.disabled = !ok;
      return ok;
    }

    function updateSourcesList(){
      const arr = srcArray();
      $("sourcesList").innerHTML = arr.length
        ? '<ul>'+arr.map(a=>`<li><a href="${a}" target="_blank" rel="noopener">${a}</a></li>`).join("")+'</ul>'
        : 'No sources yet.';
    }

    function buildPayload(){
      if(!validateInline()) return null;
      const srcRaw = $("sources").value || "";
      return {
        pack: "uk_b2b_sales_core",
        template: "opportunity_qualification",
        variables: {
          seller_name: $("seller_name").value.trim(),
          seller_company: $("seller_company").value.trim(),
          seller_url: $("seller_url").value.trim(),
          company: $("company").value.trim(),
          industry: $("industry").value.trim(),
          website: $("website").value.trim(),
          sources_raw: srcRaw,
          sources: srcArray()
        }
      };
    }

    function saveForm(){
      if (!remember.checked) return;
      const fd = Object.fromEntries(new FormData(form).entries());
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fd));
    }
    function loadForm(){
      if (localStorage.getItem(STORAGE_KEY)) remember.checked = true;
      try{
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        Object.entries(data).forEach(([k,v])=>{
          const el = form.elements[k] || $(k);
          if (el) el.value = v;
        });
      }catch{}
    }

    function setSummary(text){
      output.textContent = text || "";
      const has = !!(text && text.trim());
      copyBtn.disabled = !has; downloadBtn.disabled = !has;
      if (has) {
        $("delta").textContent = diffText(lastSummary, text) || "—";
        lastSummary = text;
        localStorage.setItem("lead_qualification_v2.last_summary", text);
      }
    }
    function diffText(oldT, newT){
      if(!oldT) return "Run again to see differences.";
      if(oldT === newT) return "No changes.";
      const o = new Set(oldT.split(/\r?\n/));
      const n = new Set(newT.split(/\r?\n/));
      const added = [...n].filter(l=>!o.has(l) && l.trim()).slice(0,6);
      const removed = [...o].filter(l=>!n.has(l) && l.trim()).slice(0,6);
      let s = "";
      if (added.length) s += "Added:\n• " + added.join("\n• ") + "\n";
      if (removed.length) s += "Removed:\n• " + removed.join("\n• ");
      return s.trim();
    }

    // ---------- Events ----------
    fields.forEach(id => ( $(id)?.addEventListener?.("input", () => {
      validateInline();
      if (id==="sources") updateSourcesList();
      saveForm();
    })));

    $("toggle-rail")?.addEventListener("click", () => {
      const btn = $("toggle-rail");
      const body = $("rail-body");
      const expanded = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", String(!expanded));
      body.hidden = expanded;
      btn.textContent = expanded ? "Show" : "Hide";
    });

    $("help")?.addEventListener("click", ()=> $("help-modal")?.showModal());
    $("help-close")?.addEventListener("click", ()=> $("help-modal")?.close());

    $("viewPayload").addEventListener("click", () => {
      const p = buildPayload(); if(!p) return;
      previewBox.textContent = JSON.stringify(p, null, 2);
      payloadWrap.open = true;
      setStatus("Payload ready.");
      saveForm();
    });

    generateBtn.addEventListener("click", async () => {
      const payload = buildPayload(); if(!payload) return;
      setStatus("Generating…");
      responseBox.textContent = "Sending…";
      generateBtn.classList.add("busy");
      try{
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        setSummary(text);
        responseBox.textContent = text;
        setStatus("Done.", "ok");
      }catch(e){
        setSummary("");
        responseBox.textContent = "Request failed: " + (e?.message || String(e));
        setStatus("Could not generate a qualification summary.", "error");
      }finally{
        generateBtn.classList.remove("busy");
        saveForm();
      }
    });

    copyBtn.addEventListener("click", async () => {
      const txt = output?.innerText || ""; if (!txt.trim()) return;
      await navigator.clipboard.writeText(txt);
      setStatus("Copied summary to clipboard.","ok");
    });

    downloadBtn.addEventListener("click", () => {
      const txt = output?.innerText || ""; if (!txt.trim()) return;
      const name = ($("company").value || "qualification").trim().replace(/\s+/g,"-");
      const blob = new Blob([txt], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `lead-qualification_${name}_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });

    remember.addEventListener("change", () => {
      if (!remember.checked) localStorage.removeItem(STORAGE_KEY); else saveForm();
    });

    // ---------- Init ----------
    (function init(){
      loadForm();
      validateInline();
      updateSourcesList();
      // restore notes
      try { $("notes").value = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}").notes || ""; } catch {}
      $("notes").addEventListener("input", saveForm);
    })();
  </script>
</body>
</html>

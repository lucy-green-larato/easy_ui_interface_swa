<!doctype html>
<html lang="en" data-app="inside-track-tools">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · Lead qualification</title>
  <link rel="stylesheet" href="./styles.css?v=2025-08-24-1">
</head>

<body>
  <!-- HEADER (reused shell) -->
  <header class="app-header" role="banner">
    <div class="header-left">
      <img class="logo" src="./assets/larato-logo-bullet.svg" alt="Larato Inside Track Sales Tools" />
      <div class="brand-text">
        <h1 class="app-title">Inside Track Tools</h1>
        <p class="kicker">Lead qualification</p>
      </div>
    </div>
    <div class="header-right">
      <div class="calltype-mini" role="group" aria-labelledby="sales-model-label">
        <span id="sales-model-label" class="mini-label">Direct or partner sales</span>
        <select id="call_type" name="call_type" form="qual-form" required aria-describedby="call_type_error">
          <option value="">Select…</option>
          <option>Direct</option>
          <option>Partner</option>
        </select>
        <label class="remember">
          <input type="checkbox" id="remember_call_type" form="qual-form" /> Remember
        </label>
        <span id="call_type_error" class="error-inline" role="alert" aria-live="polite"></span>
      </div>

      <span class="model-note">
        <span class="label">Sales model in use:</span>
        <strong id="map-label">Direct</strong>
      </span>

      <button id="help" class="btn inline" type="button" title="About this tool">Help</button>

      <span id="user-badge" class="badge is-hidden" aria-live="polite" aria-atomic="true">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="7" r="4"></circle>
          <path d="M4 22c0-4 4-7 8-7s8 3 8 7"></path>
        </svg>
        <span id="user-email">Loading…</span>
      </span>
    </div>
  </header>

  <!-- LAYOUT -->
  <main id="main" class="layout" role="main">
    <!-- LEFT -->
    <section class="panel left" aria-label="Form">
      <form id="qual-form" novalidate>
        <!-- Sales model indicator -->
        <div class="card" style="margin-bottom:var(--s-4)">
          <p><strong>Sales model in use</strong> <span id="model-indicator">Direct</span> <em class="fineprint">·
              <br>Model
              can be changed above.</em></p>
        </div>

        <fieldset class="card" aria-labelledby="legend-person">
          <legend id="legend-person">You and your prospect</legend>
          <div class="grid-2">
            <div class="field">
              <label for="seller_name">Your name <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_name" name="seller_name" required autocomplete="name" />
              <p class="error" id="seller_name_error" role="alert" aria-live="polite"></p>
            </div>

            <!-- Mobile-only mirror -->
            <div class="field field-calltype-xs">
              <label for="call_type_xs">Sales model <span aria-hidden="true" class="req">*</span></label>
              <select id="call_type_xs" name="call_type_xs" aria-describedby="call_type_error_xs">
                <option value="">Select…</option>
                <option>Direct</option>
                <option>Partner</option>
              </select>
              <p class="error" id="call_type_error_xs" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="seller_company">Your company <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_company" name="seller_company" required autocomplete="organization" />
              <p class="error" id="seller_company_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="seller_company_url">Your website</label>
              <input id="seller_company_url" name="seller_company_url" type="url" inputmode="url"
                placeholder="https://yourcompany.com" />
              <p class="error" id="seller_company_url_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="detail">Output length</label>
              <select id="detail" name="detail">
                <option value="full" selected>Full (detailed)</option>
                <option value="summary">Summary / Exec</option>
              </select>
              <p class="fineprint">Controls report length & depth.</p>
            </div>

            <div class="field">
              <label for="prospect_name">Prospect name <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_name" name="prospect_name" required />
              <p class="error" id="prospect_name_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="prospect_role">Prospect role <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_role" name="prospect_role" required placeholder="e.g., Finance Director" />
              <p class="error" id="prospect_role_error" role="alert" aria-live="polite"></p>
            </div>

            <!-- Prospect website (required) -->
            <div class="field">
              <label for="prospect_website">Prospect website <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_website" name="prospect_website" type="url" inputmode="url" required
                placeholder="https://prospect.com" />
              <p class="error" id="prospect_website_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="prospect_company">Prospect company <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_company" name="prospect_company" required />
              <p class="error" id="prospect_company_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <div class="field">
          <label class="label-with-help" for="company_number">
            Companies House no.
            <button id="ch-help" class="btn info" type="button" aria-controls="ch-modal" aria-expanded="false"
              title="Important information for financial analysis"
              aria-label="Important information for financial analysis">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" stroke="currentColor" fill="none"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="9"></circle>
                <line x1="12" y1="10" x2="12" y2="16"></line>
                <circle cx="12" cy="7" r="1.25" fill="currentColor"></circle> <!-- solid dot -->
              </svg>
            </button>
          </label>

          <input id="company_number" name="company_number" placeholder="Optional (e.g., 01234567)" />

          <p id="company_number_hint" class="fineprint">
            Important information for financial analysis. Click the button to read.
          </p>
        </div>

        <div class="field">
          <label for="product_service">Product / service offered <span aria-hidden="true" class="req">*</span></label>
          <input id="product_service" name="product_service" required
            placeholder="Free-form (e.g., FTTP, SIP, IoT, UCaaS, managed LAN)" />
          <p class="error" id="product_service_error" role="alert" aria-live="polite"></p>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="competitors">Competition</label>
            <input id="competitors" name="competitors" placeholder="e.g., BT Wholesale, CityFibre, Gamma" />
          </div>
          <div class="field">
            <label for="existing_provider">Existing provider(s)</label>
            <input id="existing_provider" name="existing_provider" placeholder="e.g., Openreach, Microsoft, Vodafone" />
          </div>
        </div>

        <div class="field">
          <label for="context">Other context to analyse</label>
          <textarea id="context" name="context" rows="2"
            placeholder="Constraints, timelines, budget signals, known suppliers, etc."></textarea>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="company_linkedin">Company LinkedIn</label>
            <input id="company_linkedin" name="company_linkedin" placeholder="https://www.linkedin.com/company/..."
              inputmode="url" />
          </div>
          <div class="field">
            <label for="contact_linkedins">Key contact LinkedIn URLs</label>
            <input id="contact_linkedins" name="contact_linkedins" placeholder="Comma or newline separated" />
          </div>
        </div>

        <div class="field">
          <label for="events">Trade show(s) this year</label>
          <input id="events" name="events" placeholder="e.g., Channel Live; Connected North" />
        </div>
        </fieldset>

        <fieldset class="card" aria-labelledby="legend-evidence">
          <legend id="legend-evidence">Evidence</legend>

          <!-- iXBRL fetch -->
          <div class="row-between" style="align-items:flex-end; gap:12px;">
            <div>
              <p class="muted" style="margin:.25rem 0 .5rem 0">Fetch latest iXBRL by company number (multi-year
                supported).</p>
              <button id="fetch-ixbrl" class="btn inline" type="button">Fetch iXBRL</button>
              <span id="ixbrl-status" class="muted" aria-live="polite" style="margin-left:.5rem"></span>
            </div>
            <div id="ixbrl-chips" class="chips"></div>
          </div>

          <!-- Manual metrics (fallback if 204 or user preference) -->
          <details id="manual-metrics" class="card" style="margin-top:var(--s-3)">
            <summary>Open this panel to enter metrics manually</summary>
            <div class="grid-3" style="margin-top:var(--s-3)">
              <div class="field"><label for="m_end_y1">Year 1 end date</label><input id="m_end_y1"
                  placeholder="YYYY-MM-DD"></div>
              <div class="field"><label for="m_turnover_y1">Y1 turnover (£)</label><input id="m_turnover_y1"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_gp_y1">Y1 gross profit (£)</label><input id="m_gp_y1"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_op_y1">Y1 operating profit (£)</label><input id="m_op_y1"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_ca_y1">Y1 current assets (£)</label><input id="m_ca_y1"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_cl_y1">Y1 current liabilities (£)</label><input id="m_cl_y1"
                  inputmode="numeric"></div>
            </div>
            <div class="grid-3">
              <div class="field"><label for="m_end_y2">Year 2 end date</label><input id="m_end_y2"
                  placeholder="YYYY-MM-DD"></div>
              <div class="field"><label for="m_turnover_y2">Y2 turnover (£)</label><input id="m_turnover_y2"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_gp_y2">Y2 gross profit (£)</label><input id="m_gp_y2"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_op_y2">Y2 operating profit (£)</label><input id="m_op_y2"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_ca_y2">Y2 current assets (£)</label><input id="m_ca_y2"
                  inputmode="numeric"></div>
              <div class="field"><label for="m_cl_y2">Y2 current liabilities (£)</label><input id="m_cl_y2"
                  inputmode="numeric"></div>
            </div>
          </details>

          <!-- OCR PDF upload -->
          <div class="field">
            <label for="report_files">Upload annual report(s) (PDF)</label>
            <input id="report_files" name="report_files" type="file" accept="application/pdf" multiple />
            <p id="file_hint" class="muted">
              Multi-year financial analysis is available. Add the last two years’ filings (max 2).
            </p>
            <ul id="file_list" class="muted" style="margin:.5rem 0 0 0;padding-left:1.1rem"></ul>
          </div>

        </fieldset>

        <fieldset class="card" aria-labelledby="legend-buyer">
          <legend id="legend-buyer">Buyer type</legend>
          <div class="field">
            <label for="buyer_type">Buyer behaviour</label>
            <select id="buyer_type" name="buyer_type">
              <option>Innovator</option>
              <option>Early adopter</option>
              <option selected>Early majority</option>
              <option>Late majority</option>
              <option>Sceptic</option>
            </select>
          </div>
        </fieldset>

        <div class="actions">
          <button id="submit" class="btn primary" type="submit" disabled>
            <span class="btn-label">Generate qualification</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
          <button id="resetBtn" type="reset" class="btn small">Reset</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <details id="diagnostics" class="diag card" style="margin-top:var(--s-5)">
          <summary>Diagnostics</summary>
          <pre id="diag-json" tabindex="0" aria-label="Diagnostics JSON"></pre>
          <p class="muted">If you see a 401 unauthorised error, please <a href="/.auth/login/aad">sign in again</a>.</p>
        </details>
      </form>
    </section>

    <!-- MIDDLE -->
    <section class="panel middle">
      <div class="row-between output-head">
        <h2 id="output-title">Opportunity qualification analysis</h2>
        <div class="row-between" style="gap:8px">
          <div class="meta" id="output-meta" aria-live="polite" style="color:var(--text-2);font-size:.9rem"></div>
        </div>
      </div>

      <div id="output" class="output" tabindex="0" aria-label="Generated report will appear here"></div>

      <div id="sources" class="card" style="margin-top:var(--s-3); display:none">
        <h3>Sources</h3>
        <ol id="source-list" style="margin:0; padding-left:1.25rem"></ol>
      </div>

      <!-- Output actions -->
      <div class="output-actions">
        <button id="copy-report" class="btn inline" type="button" disabled>Copy</button>
        <button id="download-report" class="btn inline" type="button" disabled>Download .txt</button>
        <button id="export-docx" class="btn inline" type="button" disabled>Export .docx</button>
        <button id="send-prioritise" class="btn inline" type="button" disabled>Send for prioritisation</button>
        <!-- Wrap the Email button to place a label under it -->
        <span class="stack">
          <button id="email-report" class="btn inline" type="button" disabled
            aria-describedby="email-hint">Email</button>
          <span id="email-hint" class="fineprint">Internal email</span>
        </span>
      </div>


      <!-- Notes -->
      <div class="notes-card card" style="margin-top:var(--s-4)">
        <div class="row-between">
          <h3>Qualification notes</h3>
          <div class="row-between" style="gap:8px">
            <button id="save-notes" class="btn inline" type="button">Save notes</button>
            <button id="download-notes" class="btn inline" type="button">Download .txt</button>
          </div>
        </div>
        <textarea id="notes" rows="6"
          placeholder="Type notes during desk research or calls. Saved locally on this device."></textarea>
        <p class="muted" style="margin-top:.5rem">Notes are stored locally (this browser only).</p>
      </div>

      <div class="change-log" style="margin-top:var(--s-4)">
        <h3>What changed</h3>
        <ul id="delta-log" class="delta" aria-live="polite"></ul>
      </div>
      <div class="activity" style="margin-top:var(--s-4)">
        <h3>Recent activity</h3>
        <ol id="activity-log" class="activity-log" aria-live="polite" style="margin:0;padding-left:1.25rem"></ol>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel right" aria-labelledby="intel-title">
      <aside class="intel card">
        <div class="intel-head">
          <h2 id="intel-title">Helpful tips</h2>
          <button id="toggle-intel" class="btn small" type="button" aria-expanded="true"
            aria-controls="intel-body">Hide</button>
        </div>
        <div id="intel-body">
          <ul id="tips-list"></ul>
          <p id="tips-empty" class="muted">Tips will appear after you generate a report.</p>
        </div>
      </aside>

      <aside class="card" style="margin-top:var(--s-4)">
        <h3>Financial flags</h3>
        <ul id="flags-list" class="muted"></ul>
      </aside>
    </section>
  </main>

  <!-- CH / iXBRL HELP MODAL -->
  <dialog id="ch-modal" class="modal">
    <div class="card" style="max-width:700px">
      <div class="row-between" style="align-items:center">
        <h3 style="margin:0">About Companies House numbers & iXBRL</h3>
        <button id="ch-close" class="btn inline" type="button">Close ×</button>
      </div>
      <p><strong>What this does</strong><br>
        Use this panel to assemble an evidence-based view of a lead’s commercial performance.</p>

      <ul>
        <li>You can analyse <strong>one or two financial years</strong>.</li>
        <li>Two evidence routes:
          <ol>
            <li><strong>Fetch iXBRL</strong> (recommended) — enter the Companies House number and click <em>Fetch
                iXBRL</em>.</li>
            <li><strong>Upload accounts</strong> — add up to two <strong>OCR’d</strong> PDF filings (most recent years).
            </li>
          </ol>
        </li>
        <li>Or enter <strong>key commercial metrics manually</strong> if filings aren’t available.</li>
      </ul>

      <h4>What is iXBRL?</h4>
      <p>iXBRL (“Inline XBRL”) is a <strong>digital accounts format</strong> that Companies House is rolling out and
        increasingly mandating. It replaces image-only PDFs and lets the tool read headline figures directly.</p>

      <h4>Making PDFs searchable (OCR)</h4>
      <p>If your accounts are scans or image-only PDFs, run OCR before uploading so the tool can read them:</p>
      <ol>
        <li>Open the PDF in your editor (e.g., Adobe Acrobat).</li>
        <li>Use <em>Recognise Text</em> / <em>OCR</em> for the entire document.</li>
        <li>Save as a new “searchable” PDF and upload here (max two files, most recent years).</li>
      </ol>
      <p class="muted">Tip: ensure text is selectable and the file isn’t password-protected.</p>

      <h4>How your inputs are used</h4>
      <ul>
        <li><strong>Company number</strong> is used to fetch iXBRL and link to filings.</li>
        <li><strong>Buyer type</strong> shapes the qualification analysis and the tips you see on the right.</li>
      </ul>

    </div>
  </dialog>

  <!-- HELP MODAL -->
  <dialog id="help-modal" class="modal">
    <div class="card" style="max-width:700px">
      <div class="row-between" style="align-items:center">
        <h3 style="margin:0">About this tool</h3>
        <button id="help-close" class="btn inline" type="button">Close ×</button>
      </div>
      <p>This Lead qualification tool assembles an evidence-only partner-readiness report using your inputs, public
        links, iXBRL, and uploaded filings.</p>
      <h3>How to use it</h3>
      <ol>
        <li>Set the sales model (Direct or Partner) at the top.</li>
        <li>Complete People and Company & sources. CH number is optional.</li>
        <li>Fetch iXBRL and/or upload OCR PDFs (last two years for multi-year analysis).</li>
        <li>Click <em>Generate qualification</em>. The report appears in the middle with citations and a
          <em>Sources</em> list.
        </li>
        <li>Copy, download, export .docx, or email the summary. Use <em>Qualification notes</em> to capture findings.
        </li>
      </ol>
      <h3>What the tool assures</h3>
      <ul>
        <li>Evidence-only output. Unsupported claims are removed.</li>
        <li>Multi-year chips show YoY and liquidity ratios (if available).</li>
        <li>Partner mode adds risks & mitigations automatically.</li>
      </ul>
      <h3>Privacy & storage</h3>
      <ul>
        <li>Notes are stored locally in your browser.</li>
        <li>Generation runs server-side. If you see 401, sign in again via the Diagnostics link.</li>
      </ul>
    </div>
  </dialog>

  <!-- PRIORITISATION MODAL -->
  <dialog id="prio-modal" class="modal">
    <div class="card" style="max-width:700px">
      <div class="row-between" style="align-items:center">
        <h3 style="margin:0">Opportunity prioritisation</h3>
        <button id="prio-close" class="btn inline" type="button">Close ×</button>
      </div>

      <div id="prio-body" style="margin-top:var(--s-3)">
        <!-- Scoring results are injected here -->
      </div>

      <div class="row-between" style="margin-top:var(--s-3); gap:8px">
        <button id="prio-copy" class="btn inline" type="button" title="Copy JSON payload for the next tool">Copy
          JSON</button>
        <span class="fineprint">This JSON contains: strategicImpact, operationalImpact, partialFit.</span>
      </div>
    </div>
  </dialog>

  <!-- === SCRIPT === -->
  <script type="module">
    /* ---------- Shared helpers ---------- */
    const basePrefix = (() => {
      const path = location.pathname || "/";
      const segs = path.split("/").filter(Boolean);
      const last = segs[segs.length - 1] || "";
      if (/\.[a-z0-9]+$/i.test(last)) return "";
      return segs.length ? "/" + segs[0] : "";
    })();

    const STORAGE_PREFIX = "lead_qualification_v1";
    const FORM_ID = "qual-form";
    const OUTPUT_KEY = STORAGE_PREFIX + ".last_output";
    const ACTIVITY_KEY = STORAGE_PREFIX + ".activity";
    const FORM_KEY = STORAGE_PREFIX + ".form";
    const NOTES_KEY_PREFIX = STORAGE_PREFIX + ".notes";
    const CALL_PREF_KEY = STORAGE_PREFIX + ".call_pref";

    const esc = s => String(s || "").replace(/[&<>]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c]));
    const strongify = s => String(s || "").replace(/\*\*([^\*\n][\s\S]*?)\*\*/g, "<strong>$1</strong>");

    // Minimal markdown → HTML (H2/H3, lists, paragraphs)
    function mdToHtml(md) {
      var s = String(md || "").replace(/\r/g, "");
      var lines = s.split("\n");
      var out = [];
      var inList = false;
      function flushList() { if (inList) { out.push("</ul>"); inList = false; } }
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) { flushList(); continue; }
        if (/^#{2,}\s+/.test(line)) {
          flushList();
          out.push("<h3>" + esc(line.replace(/^#{2,}\s+/, "")) + "</h3>");
          continue;
        }
        if (/^- /.test(line)) {
          if (!inList) { out.push("<ul>"); inList = true; }
          out.push("<li>" + strongify(esc(line.slice(2))) + "</li>");
          continue;
        }
        flushList();
        out.push("<p>" + strongify(esc(line)) + "</p>");
      }
      flushList();
      return out.join("");
    }

    // Buyer behaviour → slug
    function buyerSlug(label) {
      const l = String(label || "").toLowerCase();
      if (l.includes("innovator")) return "innovator";
      if (l.includes("early adopter")) return "early-adopter";
      if (l.includes("early majority")) return "early-majority";
      if (l.includes("late majority")) return "late-majority";
      if (l.includes("sceptic") || l.includes("skeptic")) return "sceptic";
      return "early-majority";
    }

    // --- Prioritisation (local-only, no server calls) ---
    function scoreOpportunityFromText(text) {
      const t = String(text || "").toLowerCase();

      // You can tune these lists anytime without affecting other logic
      const strategicTerms = [
        "board", "strategy", "strategic", "transformation", "digital transformation", "operating model",
        "market entry", "expansion", "acquisition", "merger", "regulatory", "compliance mandate",
        "capex", "multi-year plan", "growth thesis", "turnaround", "replatform", "modernisation"
      ];
      const operationalTerms = [
        "process", "workflow", "cost", "efficiency", "automation", "sla", "ticket", "backlog",
        "incident", "downtime", "utilisation", "throughput", "rollout", "migration",
        "integration", "time to value", "productivity", "service desk", "operational"
      ];

      function countHits(terms) {
        let c = 0;
        for (const s of terms) {
          const rx = new RegExp("\\b" + s.replace(/\s+/g, "\\s+") + "\\b", "gi");
          const m = t.match(rx);
          if (m) c += m.length;
        }
        return c;
      }

      const sCount = countHits(strategicTerms);
      const oCount = countHits(operationalTerms);

      // Simple thresholds; adjust if you wish
      const hasStrategic = sCount >= 2;
      const hasOperational = oCount >= 2;

      // "Only partially" if exactly one bucket is strong OR both are weak
      const partialFit = (hasStrategic ^ hasOperational) || (!hasStrategic && !hasOperational);

      return {
        strategicImpact: {
          yesNo: hasStrategic,
          rationale: hasStrategic
            ? `Found ${sCount} strong strategic signal(s).`
            : `Insufficient strategic signals (found ${sCount}).`
        },
        operationalImpact: {
          yesNo: hasOperational,
          rationale: hasOperational
            ? `Found ${oCount} strong operational signal(s).`
            : `Insufficient operational signals (found ${oCount}).`
        },
        partialFit: {
          yesNo: partialFit,
          rationale: partialFit
            ? "Signals indicate incomplete coverage (strong in one area or weak overall)."
            : "Signals indicate good coverage across strategic and operational."
        }
      };
    }

    function buildPrioritisationPayload({ scores, inputs, scriptText }) {
      return {
        createdAt: new Date().toISOString(),
        sourceTool: "InsideTrack-LeadQualification",
        // The three fields you want to hand to the ranking tool later:
        strategicImpact: scores.strategicImpact,     // { yesNo, rationale }
        operationalImpact: scores.operationalImpact, // { yesNo, rationale }
        partialFit: scores.partialFit,               // { yesNo, rationale }
        // Optional extras (for future use)
        prospect_company: inputs.prospect_company || "",
        product_service: inputs.product_service || "",
        buyer_type: inputs.buyer_type || "",
        excerpt: String(scriptText || "").slice(0, 800)
      };
    }

    function renderPrioritisationPreviewHTML(scores) {
      function badge(val) {
        return `<span class="pill" style="margin-left:.5rem">${val ? "Yes" : "No"}</span>`;
      }
      return `
    <h4>Review</h4>
    <ul>
      <li><strong>Strategic problem solved?</strong> ${badge(scores.strategicImpact.yesNo)}<br>
          <span class="muted">${esc(scores.strategicImpact.rationale)}</span></li>
      <li style="margin-top:.5rem"><strong>Operational problem solved?</strong> ${badge(scores.operationalImpact.yesNo)}<br>
          <span class="muted">${esc(scores.operationalImpact.rationale)}</span></li>
      <li style="margin-top:.5rem"><strong>Only partially solves the buyer’s problems?</strong> ${badge(scores.partialFit.yesNo)}<br>
          <span class="muted">${esc(scores.partialFit.rationale)}</span></li>
    </ul>
    <p class="fineprint" style="margin-top:var(--s-3)">This is a lightweight client-side assessment based on the generated report’s text.</p>
  `;
    }

    // DOM refs
    const form = document.getElementById(FORM_ID);
    const statusEl = document.getElementById("status");
    const diag = document.getElementById("diagnostics");
    const diagJson = document.getElementById("diag-json");
    const outputEl = document.getElementById("output");
    const outputMeta = document.getElementById("output-meta");
    const copyBtn = document.getElementById("copy-report");
    const dlBtn = document.getElementById("download-report");
    const docxBtn = document.getElementById("export-docx");
    const emailBtn = document.getElementById("email-report");
    const notesArea = document.getElementById("notes");
    const saveNotesBtn = document.getElementById("save-notes");
    const downloadNotesBtn = document.getElementById("download-notes");
    const deltaLog = document.getElementById("delta-log");
    const activityLog = document.getElementById("activity-log");
    const ixbrlBtn = document.getElementById("fetch-ixbrl");
    const ixbrlStatus = document.getElementById("ixbrl-status");
    const ixbrlChips = document.getElementById("ixbrl-chips");
    const flagsList = document.getElementById("flags-list");
    const tipsList = document.getElementById("tips-list");
    const tipsEmpty = document.getElementById("tips-empty");
    const sourcesCard = document.getElementById("sources");
    const sourceList = document.getElementById("source-list");
    // Prioritisation UI
    const prioBtn = document.getElementById("send-prioritise");
    const prioModal = document.getElementById("prio-modal");
    const prioClose = document.getElementById("prio-close");
    const prioBody = document.getElementById("prio-body");
    const prioCopy = document.getElementById("prio-copy");

    let LAST_PRIO_PAYLOAD = null; // set on each score for Copy JSON

    const callTypeSel = document.getElementById("call_type");
    const callTypeSelXs = document.getElementById("call_type_xs");
    const rememberCallType = document.getElementById("remember_call_type");
    const modelIndicator = document.getElementById("model-indicator");
    const mapLabel = document.getElementById("map-label");

    const chModal = document.getElementById("ch-modal");
    const chHelp = document.getElementById("ch-help");
    const chClose = document.getElementById("ch-close");

    const helpBtn = document.getElementById("help");
    const helpModal = document.getElementById("help-modal");
    const helpClose = document.getElementById("help-close");

    // **File input: correct IDs**
    const reportInput = document.getElementById("report_files");
    const reportList = document.getElementById("file_list");

    const requiredIds = [
      "call_type",
      "seller_name",
      "seller_company",
      "prospect_name",
      "prospect_role",
      "prospect_company",
      "prospect_website",
      "product_service"
    ];

    // Accessibility helpers
    function setStatus(msg, kind = "info") {
      if (!statusEl) return;
      statusEl.textContent = msg;
      statusEl.dataset.kind = kind;
    }
    function validateField(id) {
      const el = document.getElementById(id);
      if (!el) return true;
      const val = (el.value || "").trim();
      const ok = requiredIds.includes(id) ? !!val : true;
      const errEl = document.getElementById(id + "_error");
      if (errEl) {
        if (ok) { errEl.textContent = ""; el.classList.remove("invalid"); el.removeAttribute("aria-invalid"); }
        else { errEl.textContent = "This field is required."; el.classList.add("invalid"); el.setAttribute("aria-invalid", "true"); }
      }
      return ok;
    }
    function allRequiredFilled() {
      const missing = requiredIds.filter(id => !String(document.getElementById(id)?.value || "").trim());
      if (missing.length) setStatus("Please complete: " + missing.map(id => id.replace("_", " ")).join(", ") + ".", "error");
      else setStatus("");
      return missing.length === 0;
    }

    // Persist
    function saveForm() {
      if (!form) return;
      const fd = Object.fromEntries(new FormData(form).entries());
      try { localStorage.setItem(FORM_KEY, JSON.stringify(fd)); } catch { }
    }
    function loadForm() {
      if (!form) return;
      try {
        const raw = localStorage.getItem(FORM_KEY); if (!raw) return;
        const data = JSON.parse(raw);
        Object.entries(data).forEach(([k, v]) => {
          const el = form.elements[k] || document.getElementById(k);
          if (!el) return;
          el.value = v;
        });
      } catch { }
    }
    const notesKey = () => {
      const pn = (form?.elements?.prospect_name?.value || "").trim().toLowerCase();
      const pc = (form?.elements?.prospect_company?.value || "").trim().toLowerCase();
      return NOTES_KEY_PREFIX + "::" + pc + "::" + pn;
    };
    function loadNotes() { try { notesArea.value = localStorage.getItem(notesKey()) || ""; } catch { } }
    function saveNotes() { try { localStorage.setItem(notesKey(), notesArea.value || ""); setStatus("Notes saved."); } catch { setStatus("Could not save notes.", "error"); } }
    function updateMapIndicator() {
      modelIndicator.textContent = callTypeSel?.value || "Not set";
      mapLabel.textContent = callTypeSel?.value || "Not set";
    }
    function loadCallPref() {
      try {
        const pref = JSON.parse(localStorage.getItem(CALL_PREF_KEY) || "null");
        if (pref?.call_type && callTypeSel && !callTypeSel.value) callTypeSel.value = pref.call_type;
        if (pref?.remember === true && rememberCallType) rememberCallType.checked = true;
      } catch { }
      updateMapIndicator();
    }
    function saveCallPrefIfRequested() {
      if (rememberCallType?.checked && callTypeSel?.value) {
        localStorage.setItem(CALL_PREF_KEY, JSON.stringify({ remember: true, call_type: callTypeSel.value }));
      } else if (rememberCallType && !rememberCallType.checked) {
        localStorage.removeItem(CALL_PREF_KEY);
      }
      updateMapIndicator();
    }

    // File list (optional; never blocks submit)
    reportInput?.addEventListener("change", () => {
      reportList && (reportList.innerHTML = "");
      const files = Array.from(reportInput.files || []).slice(0, 2);
      files.forEach(f => {
        const li = document.createElement("li");
        li.textContent = f.name + " (" + Math.ceil((f.size || 0) / 1024) + " KB)";
        reportList?.appendChild(li);
      });
      enableSubmitIfValid();
    });

    // iXBRL fetch
    async function fetchIxbrl(companyNumber) {
      if (!companyNumber) return { ok: false, status: 400, data: null };
      ixbrlStatus.textContent = "Fetching…";
      const endpoints = [
        "/api/ixbrl-financials?company=" + encodeURIComponent(companyNumber),
        "/api/ixbrl-financials/" + encodeURIComponent(companyNumber),
        "/api/ixbrl-financials?company_number=" + encodeURIComponent(companyNumber)
      ];
      for (let i = 0; i < endpoints.length; i++) {
        const url = endpoints[i];
        try {
          const r = await fetch(url, { headers: { "Accept": "application/json" }, cache: "no-store" });
          if (r.status === 204) { ixbrlStatus.textContent = "No iXBRL available."; return { ok: false, status: 204, data: null }; }
          let data = {};
          try { data = await r.json(); } catch { data = {}; }
          if (!r.ok) throw new Error((data && data.error) || ("HTTP " + r.status));
          ixbrlStatus.textContent = "Loaded.";
          return { ok: true, status: 200, data };
        } catch (e) {
          // try the next endpoint
        }
      }
      ixbrlStatus.textContent = "Could not fetch iXBRL.";
      return { ok: false, status: 500, data: null };
    }

    function pct(n) { return (n == null || isNaN(n)) ? "—" : (Math.round(n * 10) / 10) + "%"; }
    function ratio(n) { return (n == null || isNaN(n)) ? "—" : String(Math.round(n * 100) / 100); }

    function renderIxbrlChips(summaryLike) {
      ixbrlChips.innerHTML = "";
      if (!summaryLike) return;

      const summary = summaryLike.summary || summaryLike; // tolerate either shape
      if (!summary?.derived && !(summary?.years && summary.years.length)) return;

      const d = summary.derived || {};
      const chips = [];

      if (d.revenueYoYPct != null) chips.push('<span class="chip">Revenue YoY: ' + pct(d.revenueYoYPct) + '</span>');
      if (d.grossMarginPct && d.grossMarginPct.y1 != null) chips.push('<span class="chip">Gross margin (Y1): ' + pct(d.grossMarginPct.y1) + '</span>');
      if (d.grossMarginPct && d.grossMarginPct.y2 != null) chips.push('<span class="chip">Gross margin (Y2): ' + pct(d.grossMarginPct.y2) + '</span>');
      if (d.currentRatio != null) chips.push('<span class="chip">Current ratio: ' + ratio(d.currentRatio) + '</span>');
      if (d.cashRatio != null) chips.push('<span class="chip">Cash ratio: ' + ratio(d.cashRatio) + '</span>');
      ixbrlChips.innerHTML = chips.join(" ");

      // Auto-flags → auto tips
      const flags = [];
      if (d.revenueYoYPct != null && d.revenueYoYPct < 0) flags.push("Revenue contracted YoY.");
      if (d.currentRatio != null && d.currentRatio < 1) flags.push("Current ratio below 1.0 (liquidity pressure).");
      if (d.cashRatio != null && d.cashRatio < 0.25) flags.push("Cash ratio very low.");
      if (d.netDebtToEquity != null && d.netDebtToEquity > 1) flags.push("High leverage (net debt / equity > 1).");

      flagsList.innerHTML = "";
      flags.forEach(f => { const li = document.createElement("li"); li.textContent = f; flagsList.appendChild(li); });
      applyAutoTips(flags); // will merge with model/bank tips
    }

    // -------- Tips system (unified) --------
    const TIPS_JSON_URL = "./assets/qualification-tips.json";
    let QUAL_TIPS = { default: [], byBuyerType: {}, byMode: {} };
    let BASE_TIPS = []; // from LLM or bank
    let AUTO_TIPS = []; // from flags

    async function loadTipsBank() {
      try {
        const res = await fetch(TIPS_JSON_URL, { cache: "no-store" });
        if (res.ok) {
          const bank = await res.json();
          if (bank && typeof bank === "object") QUAL_TIPS = bank;
        }
      } catch { /* fallback keeps defaults */ }
    }

    function pickBankTips(buyerType, mode) {
      const byType = (QUAL_TIPS.byBuyerType && QUAL_TIPS.byBuyerType[String(buyerType || "").toLowerCase()]) || [];
      const byMode = (QUAL_TIPS.byMode && QUAL_TIPS.byMode[String(mode || "").toLowerCase()]) || [];
      const def = QUAL_TIPS.default || [];
      return [...byType, ...byMode, ...def].filter(Boolean).slice(0, 3);
    }

    function applyAutoTips(flags) {
      const auto = [];
      flags.forEach(f => {
        if (/Revenue contracted/i.test(f)) auto.push("Frame growth levers (coverage, conversion, ARPU) with conservative targets.");
        if (/Current ratio below 1/i.test(f)) auto.push("Propose low-friction onboarding and activity-gated MDF to de-risk cash usage.");
        if (/Cash ratio very low/i.test(f)) auto.push("Position light-touch pilots and postcode-led campaigns before scale.");
        if (/High leverage/i.test(f)) auto.push("Avoid heavy upfront commitments; tie discounts to first wins.");
      });
      AUTO_TIPS = Array.from(new Set(auto)).slice(0, 5);
      renderTips(); // merge with BASE_TIPS
    }

    function renderTips() {
      const list = document.getElementById("tips-list");
      if (!list) return;
      list.innerHTML = "";
      const merged = Array.from(new Set([...AUTO_TIPS, ...BASE_TIPS])).slice(0, 8);
      merged.forEach(t => { const li = document.createElement("li"); li.textContent = t; list.appendChild(li); });
      tipsEmpty.style.display = merged.length ? "none" : "";
    }

    // Source rendering
    function renderSources(citations) {
      sourceList.innerHTML = "";
      const items = Array.isArray(citations) ? citations : [];
      if (!items.length) { sourcesCard.style.display = "none"; return; }
      for (let i = 0; i < items.length; i++) {
        const c = items[i] || {};
        const li = document.createElement("li");
        const label = (c.label || c.title || c.url || "Source");
        const url = (c.url || "");
        if (url) {
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = label;
          li.appendChild(a);
        } else {
          li.textContent = label;
        }
        sourceList.appendChild(li);
      }
      sourcesCard.style.display = "";
    }

    // Buttons state
    function setBusy(isBusy) {
      const submitBtn = document.getElementById("submit");
      if (submitBtn) {
        submitBtn.disabled = isBusy || !allRequiredFilled();
        submitBtn.classList.toggle('busy', isBusy);
      }
      document.getElementById("resetBtn")?.setAttribute("aria-disabled", isBusy ? "true" : "false");

      const hasText = !!(outputEl?.textContent?.trim());
      copyBtn && (copyBtn.disabled = isBusy || !hasText);
      dlBtn && (dlBtn.disabled = isBusy || !hasText);
      emailBtn && (emailBtn.disabled = isBusy || !hasText);
      docxBtn && (docxBtn.disabled = isBusy || !hasText);
      prioBtn && (prioBtn.disabled = isBusy || !hasText);
    }

    // Change log
    function computeDelta(oldText, newText) {
      const oldLines = (oldText || "").split("\n"), newLines = (newText || "").split("\n");
      let added = 0, removed = 0;
      const oldSet = new Set(oldLines), newSet = new Set(newLines);
      newLines.forEach(l => { if (!oldSet.has(l) && l.trim()) added++; });
      oldLines.forEach(l => { if (!newSet.has(l) && l.trim()) removed++; });
      return { added, removed };
    }
    function renderDelta(delta) {
      deltaLog.innerHTML = "";
      const a = document.createElement("li");
      a.textContent = "+" + delta.added + " new line" + (delta.added === 1 ? "" : "s");
      const r = document.createElement("li");
      r.textContent = "−" + delta.removed + " removed line" + (delta.removed === 1 ? "" : "s");
      deltaLog.appendChild(a);
      deltaLog.appendChild(r);
    }

    function addActivity(entry) {
      const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || "[]");
      list.unshift(entry);
      localStorage.setItem(ACTIVITY_KEY, JSON.stringify(list.slice(0, 3)));
      renderActivity();
    }
    function renderActivity() {
      const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || "[]");
      activityLog.innerHTML = "";
      list.forEach(item => {
        const li = document.createElement("li");
        const timeSpan = document.createElement("span");
        timeSpan.className = "time";
        timeSpan.textContent = item.time || "";
        li.appendChild(timeSpan);
        li.appendChild(document.createTextNode(" "));
        const pill1 = document.createElement("span");
        pill1.className = "pill";
        pill1.textContent = item.product || "";
        li.appendChild(pill1);
        li.appendChild(document.createTextNode(" "));
        const pill2 = document.createElement("span");
        pill2.className = "pill";
        pill2.textContent = item.buyer || "";
        li.appendChild(pill2);
        activityLog.appendChild(li);
      });
    }

    // Copy / Download / .docx / Email
    copyBtn?.addEventListener("click", async () => {
      const txt = outputEl?.innerText || "";
      if (!txt.trim()) return;
      try { await navigator.clipboard.writeText(txt); setStatus("Copied."); }
      catch { setStatus("Could not copy.", "error"); }
    });
    dlBtn?.addEventListener("click", () => {
      const txt = outputEl?.textContent || "";
      const who = (form?.elements?.prospect_company?.value || "report").trim().replace(/\s+/g, "-");
      const blob = new Blob([txt], { type: "text/plain" });
      const URL_ = window.URL || window.webkitURL;
      const url = URL_.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `lead-qualification_${who}_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL_.revokeObjectURL(url);
    });
    docxBtn?.addEventListener("click", () => {
      try {
        setStatus("Preparing .docx…");
        const payload = {
          kind: "qualification-docx",
          basePrefix,
          variables: collectVariables(),
          html: outputEl?.innerHTML || "",
          citations: safeJson(outputEl?.getAttribute("data-citations")) || []
        };
        fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(r => r.ok ? r.blob() : r.json().then(d => { throw new Error(d?.error || ("HTTP " + r.status)); }))
          .then(blob => {
            const URL_ = window.URL || window.webkitURL;
            if (blob && blob.size) {
              const url = URL_.createObjectURL(blob);
              const who = (form?.elements?.prospect_company?.value || "report").replace(/\s+/g, "-");
              const a = document.createElement("a");
              a.href = url; a.download = `lead-qualification_${who}.docx`;
              document.body.appendChild(a); a.click(); document.body.removeChild(a);
              URL_.revokeObjectURL(url);
              setStatus("Exported .docx");
            } else {
              throw new Error("empty-blob");
            }
          })
          .catch(() => {
            // Fallback: export current HTML
            const URL_ = window.URL || window.webkitURL;
            const htmlBlob = new Blob([outputEl?.innerHTML || ""], { type: "text/html" });
            const url = URL_.createObjectURL(htmlBlob);
            const a = document.createElement("a");
            a.href = url; a.download = "lead-qualification.html";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL_.revokeObjectURL(url);
            setStatus("Exported HTML (server .docx not available).", "info");
          });
      } catch { setStatus("Could not export .docx", "error"); }
    });
    emailBtn?.addEventListener("click", () => {
      try {
        const payload = {
          kind: "qualification-email",
          basePrefix,
          variables: {
            seller_name: (form.elements.seller_name?.value || "").trim(),
            seller_company: (form.elements.seller_company?.value || "").trim(),
            prospect_name: (form.elements.prospect_name?.value || "").trim(),
            prospect_role: (form.elements.prospect_role?.value || "").trim(),
            prospect_company: (form.elements.prospect_company?.value || "").trim(),
            buyer_type: (form.elements.buyer_type?.value || "").trim()
          },
          reportMdText: localStorage.getItem(OUTPUT_KEY) || "",
          notes: (notesArea?.value || "")
        };
        setStatus("Building email…");
        fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(r => r.json().then(data => { if (!r.ok) throw new Error(data?.error || "Could not build email."); return data; }))
          .then(data => {
            const email = data?.email?.text || data?.followup?.email || "";
            if (email) {
              const to = "";
              const subj = data?.email?.subject
                || `Summary of opportunity with ${(form.elements.prospect_company?.value || "Lead")} for sales management`;
              const href = "mailto:" + encodeURIComponent(to) + "?subject=" + encodeURIComponent(subj) + "&body=" + encodeURIComponent(email);
              location.href = href;
              setStatus("Email composed.");
            } else {
              setStatus("No email content produced.", "error");
            }
          })
          .catch(e => { setStatus("Could not compose email", "error"); diag.open = true; diagJson.textContent = String(e?.message || e); });
      } catch (e) { setStatus("Could not compose email", "error"); diag.open = true; diagJson.textContent = String(e?.message || e); }
    });

    prioBtn?.addEventListener("click", () => {
      const scriptText = (outputEl?.innerText || "").trim() || (localStorage.getItem(OUTPUT_KEY) || "");
      if (!scriptText) { setStatus("No report to score.", "error"); return; }

      const inputs = collectVariables();                // reuse your existing function
      const scores = scoreOpportunityFromText(scriptText);
      LAST_PRIO_PAYLOAD = buildPrioritisationPayload({ scores, inputs, scriptText });

      if (prioBody) prioBody.innerHTML = renderPrioritisationPreviewHTML(scores);
      prioModal?.showModal();
    });

    prioClose?.addEventListener("click", () => prioModal?.close());

    prioCopy?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify(LAST_PRIO_PAYLOAD || {}, null, 2));
        setStatus("Prioritisation JSON copied.");
      } catch {
        setStatus("Could not copy prioritisation JSON.", "error");
      }
    });

    // CH modal
    chHelp?.addEventListener("click", () => chModal?.showModal());
    chClose?.addEventListener("click", () => chModal?.close());

    // Help modal
    helpBtn?.addEventListener("click", () => helpModal?.showModal());
    helpClose?.addEventListener("click", () => helpModal?.close());

    // Toggle tips panel
    document.getElementById("toggle-intel")?.addEventListener("click", () => {
      const btn = document.getElementById("toggle-intel");
      const body = document.getElementById("intel-body");
      const expanded = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", String(!expanded));
      body.hidden = expanded;
      btn.textContent = expanded ? "Show" : "Hide";
    });

    // Fetch iXBRL click
    ixbrlBtn?.addEventListener("click", async () => {
      const num = (form.elements.company_number?.value || "").trim();
      if (!num) { setStatus("Enter a Companies House number or upload PDFs.", "error"); return; }
      setBusy(true);
      const res = await fetchIxbrl(num);
      setBusy(false);
      if (res.ok) {
        const summary = res.data?.summary || res.data || {};
        renderIxbrlChips({ summary });
        form.dataset.ixbrl = JSON.stringify(summary);
      } else if (res.status === 204) {
        renderIxbrlChips(null);
        form.dataset.ixbrl = JSON.stringify({});
        setStatus("iXBRL not available; you can upload PDFs or open the panel to enter metrics manually.", "info");
      }
    });

    function safeJson(raw) { if (!raw) return null; try { return JSON.parse(raw); } catch { return null; } }
    function num(x) { const n = Number(String(x || "").replace(/[,£\s]/g, "")); return Number.isFinite(n) ? n : null; }
    function normUrl(u) {
      u = String(u || "").trim();
      return u && !/^https?:\/\//i.test(u) ? "https://" + u : u;
    }
    ["seller_company_url", "prospect_website"].forEach(id => {
      const el = document.getElementById(id);
      el?.addEventListener("blur", () => {
        el.value = normUrl(el.value);
        saveForm();
        validateField(id);
      });
    });

    function collectVariables() {
      return {
        // --- top-level selectors / controls ---
        call_type: (callTypeSel?.value || "").trim(),
        detail: (form.elements.detail?.value || "full").trim(),

        // --- you / your company ---
        seller_name: (form.elements.seller_name?.value || "").trim(),
        seller_company: (form.elements.seller_company?.value || "").trim(),
        seller_company_url: normUrl(form.elements.seller_company_url?.value),

        // --- prospect person & company ---
        prospect_name: (form.elements.prospect_name?.value || "").trim(),
        prospect_role: (form.elements.prospect_role?.value || "").trim(),
        prospect_company: (form.elements.prospect_company?.value || "").trim(),
        prospect_website: normUrl(form.elements.prospect_website?.value),
        company_number: (form.elements.company_number?.value || "").trim(),

        // --- offer / context ---
        product_service: (form.elements.product_service?.value || "").trim(),
        competitors: (form.elements.competitors?.value || "").trim(),
        existing_provider: (form.elements.existing_provider?.value || "").trim(),
        context: (form.elements.context?.value || "").trim(),

        // --- links ---
        company_linkedin: (form.elements.company_linkedin?.value || "").trim(),
        contact_linkedins: (form.elements.contact_linkedins?.value || "").trim(),
        events: (form.elements.events?.value || "").trim(),

        // --- buyer ---
        buyer_type: (form.elements.buyer_type?.value || "").trim(),

        // --- manual metrics (unchanged) ---
        manual: {
          y1: {
            endDate: (document.getElementById("m_end_y1")?.value || "").trim(),
            turnover: num(document.getElementById("m_turnover_y1")?.value),
            grossProfit: num(document.getElementById("m_gp_y1")?.value),
            operatingProfit: num(document.getElementById("m_op_y1")?.value),
            currentAssets: num(document.getElementById("m_ca_y1")?.value),
            currentLiabilities: num(document.getElementById("m_cl_y1")?.value)
          },
          y2: {
            endDate: (document.getElementById("m_end_y2")?.value || "").trim(),
            turnover: num(document.getElementById("m_turnover_y2")?.value),
            grossProfit: num(document.getElementById("m_gp_y2")?.value),
            operatingProfit: num(document.getElementById("m_op_y2")?.value),
            currentAssets: num(document.getElementById("m_ca_y2")?.value),
            currentLiabilities: num(document.getElementById("m_cl_y2")?.value)
          }
        }
      };
    }

    // Sales model mirror + remember
    callTypeSel?.addEventListener("change", () => {
      if (callTypeSelXs) callTypeSelXs.value = callTypeSel.value;
      validateField("call_type"); saveForm(); updateMapIndicator();
      if (rememberCallType) saveCallPrefIfRequested();
      enableSubmitIfValid();
    });
    callTypeSelXs?.addEventListener("change", () => {
      if (callTypeSel) callTypeSel.value = callTypeSelXs.value;
      validateField("call_type"); saveForm(); updateMapIndicator();
      if (rememberCallType) saveCallPrefIfRequested();
      enableSubmitIfValid();
    });

    // Notes
    saveNotesBtn?.addEventListener("click", saveNotes);
    downloadNotesBtn?.addEventListener("click", () => {
      const who = (form?.elements?.prospect_company?.value || "notes").trim().replace(/\s+/g, "-");
      const txt = notesArea?.value || "";
      const blob = new Blob([txt], { type: "text/plain" });
      const URL_ = window.URL || window.webkitURL;
      const url = URL_.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `qualification-notes_${who}_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL_.revokeObjectURL(url);
    });

    // Enable submit
    function enableSubmitIfValid() {
      const submitBtn = document.getElementById("submit");
      if (submitBtn) submitBtn.disabled = !allRequiredFilled();
    }

    // Form input persistence & validation
    document.addEventListener("input", (e) => {
      if (e.target.closest && e.target.closest("#" + FORM_ID)) {
        validateField(e.target.id);
        saveForm();
        enableSubmitIfValid();
      }
    });

    // Submit: build payload and call /api/generate
    form?.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!allRequiredFilled()) return;

      const values = collectVariables();
      const ixbrlSummary = safeJson(form.dataset.ixbrl);
      const files = Array.from(reportInput?.files || []).slice(0, 2); // optional

      const policy = { evidenceOnly: true, dropUnsupportedClaims: true };

      setBusy(true);
      setStatus("Generating qualification…");
      if (diag) diag.open = false;
      if (diagJson) diagJson.textContent = "";

      function two(n) { return (n < 10 ? "0" : "") + n; }
      function handleData(data) {
        const md =
          (data?.report && (data.report.md || data.report.text)) ||
          data?.text || data?.markdown || "";
        const citations =
          (data?.report && data.report.citations) ||
          data?.citations || data?.sources || [];
        const tipsFromModel = Array.isArray(data?.tips) ? data.tips : [];

        if (!String(md).trim()) throw new Error("Empty report returned from API.");

        const html = mdToHtml(md);
        outputEl && (outputEl.innerHTML = html);
        outputEl && outputEl.setAttribute("data-citations", JSON.stringify(citations || []));

        outputMeta && (outputMeta.textContent =
          `${values.prospect_company || "—"} · ${values.product_service || "—"} · ${values.call_type || "—"}`);

        renderSources(citations);

        // Tips: prefer model → else bank; then merge with AUTO_TIPS
        const buyerType = (form.elements.buyer_type?.value || "").trim();
        const mode = (form.elements.call_type?.value || "").trim();
        BASE_TIPS = tipsFromModel.length ? tipsFromModel : pickBankTips(buyerType, mode);
        renderTips();

        // Enable actions
        copyBtn && (copyBtn.disabled = false);
        dlBtn && (dlBtn.disabled = false);
        emailBtn && (emailBtn.disabled = false);
        docxBtn && (docxBtn.disabled = false);
        prioBtn && (prioBtn.disabled = false);

        // Delta & activity
        const old = localStorage.getItem(OUTPUT_KEY) || "";
        const delta = computeDelta(old, md);
        renderDelta(delta);
        localStorage.setItem(OUTPUT_KEY, md);

        const now = new Date();
        const time = two(now.getHours()) + ":" + two(now.getMinutes());
        addActivity({ time, product: values.product_service || "—", buyer: values.buyer_type || "—" });

        setStatus("Done. (Generated from API)");
        document.getElementById("output-title")?.focus();
      }

      function handleError(err) {
        setStatus("Could not generate the report. See Diagnostics for details.", "error");
        if (diag && diagJson) { diag.open = true; diagJson.textContent = String(err?.message || err); }
      }

      if (files.length) {
        const fd = new FormData();
        fd.append("kind", "lead-qualification");
        fd.append("basePrefix", basePrefix);
        fd.append("variables", JSON.stringify(values));
        fd.append("ixbrlSummary", JSON.stringify(ixbrlSummary || {}));
        fd.append("policy", JSON.stringify(policy));
        files.forEach((f, i) => fd.append("files", f, f?.name || `report-${i + 1}.pdf`));

        fetch("/api/generate", { method: "POST", body: fd })
          .then(resp => resp.json().catch(() => ({})).then(data => { if (!resp.ok) throw new Error(data?.error || ("API " + resp.status)); return data; }))
          .then(handleData)
          .catch(handleError)
          .finally(() => setBusy(false));
      } else {
        const body = {
          kind: "lead-qualification",
          basePrefix,
          variables: values,
          ixbrlSummary: ixbrlSummary || {},
          policy
        };
        fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        })
          .then(resp => resp.json().catch(() => ({})).then(data => { if (!resp.ok) throw new Error(data?.error || ("API " + resp.status)); return data; }))
          .then(handleData)
          .catch(handleError)
          .finally(() => setBusy(false));
      }
    });

    // Reset handler
    form?.addEventListener("reset", () => {
      queueMicrotask(() => {
        try {
          localStorage.removeItem(FORM_KEY);
          localStorage.removeItem(ACTIVITY_KEY);
          localStorage.removeItem(OUTPUT_KEY);
          localStorage.removeItem(notesKey());
        } catch { }
        outputEl && (outputEl.innerHTML = "");
        sourceList && (sourceList.innerHTML = "");
        sourcesCard && (sourcesCard.style.display = "none");
        flagsList && (flagsList.innerHTML = "");
        tipsList && (tipsList.innerHTML = "");
        tipsEmpty && (tipsEmpty.style.display = "");
        ixbrlChips && (ixbrlChips.innerHTML = "");
        statusEl && (statusEl.textContent = "");
        copyBtn && (copyBtn.disabled = true);
        dlBtn && (dlBtn.disabled = true);
        emailBtn && (emailBtn.disabled = true);
        docxBtn && (docxBtn.disabled = true);
        prioBtn && (prioBtn.disabled = true);
        try { prioModal?.close(); } catch { }
        LAST_PRIO_PAYLOAD = null;
        document.querySelector(".panel.left")?.scrollTo({ top: 0, behavior: "auto" });
        document.getElementById("seller_name")?.focus();
        BASE_TIPS = []; AUTO_TIPS = []; renderTips();
      });
    });

    // ==== Init ====
    (async function init() {
      try {
        const me = await fetch("/.auth/me", { cache: "no-store" });
        const j = await me.json();
        const email = j?.clientPrincipal?.userDetails || j?.clientPrincipal?.identityProvider || "";
        const userBadge = document.getElementById("user-badge");
        const userEmail = document.getElementById("user-email");
        if (email && userBadge && userEmail) { userEmail.textContent = email; userBadge.classList.remove("is-hidden"); }
      } catch { }

      loadForm(); loadCallPref();
      if (callTypeSelXs && callTypeSel) callTypeSelXs.value = callTypeSel.value || "";
      updateMapIndicator();

      await loadTipsBank(); // populate QUAL_TIPS

      // Preload “financial analysis needed” nudge if CH missing
      const ch = (form?.elements?.company_number?.value || "").trim();
      if (!ch) document.getElementById("company_number_hint").style.display = "";

      enableSubmitIfValid();
      renderActivity();

      // Render initial (empty) tips state
      renderTips();
    })();
  </script>
  <!-- Removed stray <script src="./lead-qualification.js"> to avoid 404 -->
</body>

</html>
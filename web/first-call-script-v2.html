<!doctype html>
<html lang="en" data-app="inside-track-tools">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · First Call Script (v2)</title>
  <link rel="stylesheet" href="./styles.css?v=fix3" />
  <style>
    :root{
      --bg:#f7f7f9; --surface-1:#fff; --surface-2:#eef0f4; --surface-3:#e5e8ee;
      --text-1:#1d2129; --text-2:#5b6270; --accent:#2458e6; --accent-pressed:#1f49be;
      --danger:#b00020; --ok:#0a7f2e; --ring:2px solid rgba(36,88,230,.35);
      --shadow:0 1px 2px rgba(0,0,0,.06), 0 6px 24px rgba(0,0,0,.06);
      --radius:10px; --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:24px; --space-6:32px;
      --font-system:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --right-min:280px;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text-1);font:16px/1.45 var(--font-system)}
    .app-header{display:flex;align-items:center;justify-content:space-between;gap:var(--space-3);padding:var(--space-3) var(--space-5)}
    .header-left{display:flex;align-items:center;gap:.75rem;min-width:0;flex:1 1 auto}
    .logo{width:clamp(44px,5vw,52px);height:auto;object-fit:contain;flex-shrink:0}
    .brand-text{display:flex;flex-direction:column}
    .app-title{font-weight:600;margin:.25rem 0 0}
    .kicker{font-size:.875rem;color:var(--text-2);margin-top:.125rem}
    .header-right{display:flex;align-items:center;gap:.75rem;flex:0 0 auto}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--surface-3);background:var(--surface-1);cursor:pointer;font-weight:600}
    .btn.small{padding:6px 10px;font-size:.9rem}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.primary:hover{background:var(--accent-pressed)}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.5);border-top-color:#fff;display:none}
    .btn.primary.busy .spinner{display:inline-block;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .calltype-mini{display:flex;align-items:center;gap:.6rem;padding:6px 10px;border-radius:999px;background:var(--surface-1);border:1px solid var(--surface-3);font-size:.95rem;white-space:nowrap}
    .calltype-mini .mini-label{font-weight:600}
    .calltype-mini select{padding:6px 10px;border-radius:8px;border:1px solid var(--surface-3);background:#fff}
    .calltype-mini .remember{display:flex;align-items:center;gap:.35rem;color:var(--text-2)}
    .error-inline{color:var(--danger);font-size:.85rem}
    .model-note{display:inline-flex;align-items:center;gap:.35rem;padding:6px 10px;background:var(--surface-2);border:1px solid var(--surface-3);border-radius:999px;font-size:.9rem;color:var(--text-2)}
    .badge{display:flex;align-items:center;gap:.4rem;padding:8px 12px;background:var(--surface-2);border:1px solid var(--surface-3);border-radius:999px;font-size:.9rem;color:var(--text-1);white-space:nowrap}
    .badge svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2}
    .badge.is-hidden{display:none}
    .layout{display:grid;grid-template-columns:minmax(0,1.35fr) minmax(0,2.65fr) minmax(var(--right-min),clamp(260px,14vw,300px));gap:var(--space-6);padding:var(--space-5);align-items:start;box-sizing:border-box}
    @media (max-width:1200px){.layout{grid-template-columns:1fr}}
    .panel{display:block}
    .card{background:transparent;border:0;box-shadow:none;padding:0}
    .card .card{border:0;box-shadow:none;padding:0}
    fieldset{border:0;margin:0 0 var(--space-5);padding:0}
    legend{font-weight:600;margin-bottom:var(--space-3);font-size:1.125rem}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-4)}
    @media (max-width:800px){.grid-2{grid-template-columns:1fr}}
    label{display:block;margin-bottom:6px;font-weight:600}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--surface-3);background:#fff;outline:none;transition:box-shadow .15s ease,border-color .15s ease}
    input:focus,select:focus,textarea:focus{box-shadow:var(--ring);border-color:var(--accent)}
    .help{margin:.25rem 0 0;color:var(--text-2);font-size:.9rem}
    .error{min-height:1.25rem;color:var(--danger);font-size:.9rem;margin:.25rem 0 0}
    .actions{display:flex;gap:var(--space-3);align-items:center;margin-top:var(--space-4);flex-wrap:wrap}
    .status{margin-top:var(--space-3);min-height:1.35rem;color:var(--text-2)}
    .status[data-kind="error"]{color:var(--danger)}
    .status[data-kind="ok"]{color:var(--ok)}
    .output{white-space:pre-wrap;background:#f6f7fb;color:#1f2937;border:1px solid #e5e7eb;padding:var(--space-4);border-radius:8px;min-height:180px;outline:none}
    .intel-grid{display:grid;grid-template-columns:1fr !important;gap:var(--space-3)}
    .intel .intel-slot{background:transparent;border:0}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header" role="banner">
    <div class="header-left">
      <img class="logo" src="./larato-logo.svg" alt="Larato" />
      <div class="brand-text">
        <h1 class="app-title">Inside Track Tools</h1>
        <p class="kicker">First Call Script · v2</p>
      </div>
    </div>

    <div class="header-right">
      <div class="calltype-mini" role="group" aria-labelledby="sales-model-label">
        <span id="sales-model-label" class="mini-label">Direct or partner sales</span>
        <select id="call_type" name="call_type" form="script-form" required aria-describedby="call_type_error">
          <option value="">Select…</option>
          <option>Direct</option>
          <option>Partner</option>
        </select>
        <label class="remember"><input type="checkbox" id="remember_call_type" form="script-form" />Remember</label>
        <span id="call_type_error" class="error-inline" role="alert" aria-live="polite"></span>
      </div>

      <span class="model-note"><span class="label">Sales model in use:</span> <strong id="map-label">Not set</strong></span>

      <span id="user-badge" class="badge is-hidden" aria-live="polite" aria-atomic="true">
        <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="7" r="4"></circle><path d="M4 22c0-4 4-7 8-7s8 3 8 7"></path></svg>
        <span>Loading user…</span>
      </span>
    </div>
  </header>

  <!-- LAYOUT -->
  <main id="main" class="layout" role="main">
    <!-- LEFT -->
    <section class="panel left" aria-label="Form">
      <form id="script-form" novalidate>
        <fieldset class="card" aria-labelledby="legend-call-details">
          <legend id="legend-call-details">Call details</legend>
          <div class="grid-2">
            <div class="field">
              <label for="seller_name">Your name <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_name" name="seller_name" required autocomplete="name" />
              <p class="help">Shown in the opening line.</p>
              <p class="error" id="seller_name_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="seller_company">Your company <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_company" name="seller_company" required autocomplete="organization" />
              <p class="help">Organisation you represent.</p>
              <p class="error" id="seller_company_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="prospect_name">Prospect name <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_name" name="prospect_name" required />
              <p class="error" id="prospect_name_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="prospect_role">Prospect role <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_role" name="prospect_role" required placeholder="e.g., Finance Director" />
              <p class="error" id="prospect_role_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="prospect_company">Prospect company <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_company" name="prospect_company" required />
              <p class="error" id="prospect_company_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="card" aria-labelledby="legend-targeting">
          <legend id="legend-targeting">Targeting</legend>
          <div class="grid-2">
            <div class="field">
              <label for="product">Product <span aria-hidden="true" class="req">*</span></label>
              <!-- DEFAULT IS “Select…” SO IT CAN’T STICK ON “Loading…” -->
              <select id="product" name="product" required>
                <option value="">Select…</option>
              </select>
              <p class="help">One of the Inside Track product categories.</p>
              <p class="error" id="product_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="buyer_behaviour">Buyer behaviour <span aria-hidden="true" class="req">*</span></label>
              <select id="buyer_behaviour" name="buyer_behaviour" required>
                <option value="">Select…</option>
                <option>Innovator</option>
                <option>Early adopter</option>
                <option>Early majority</option>
                <option>Late majority</option>
                <option>Sceptic</option>
              </select>
              <p class="help">Adoption profile from the Inside Track company record.</p>
              <p class="error" id="buyer_behaviour_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="card" aria-labelledby="legend-preferences">
          <legend id="legend-preferences">Script preferences</legend>
          <div class="grid-2">
            <div class="field">
              <label for="tone">Tone</label>
              <select id="tone" name="tone">
                <option value="">(No preference)</option>
                <option>Professional (corporate)</option>
                <option>Warm (relaxed)</option>
              </select>
              <p class="help">Optional style guidance.</p>
            </div>
            <div class="field">
              <label for="length">Length</label>
              <select id="length" name="length">
                <option>~50 words (≈30–45 sec)</option>
                <option selected>~100 words (≈1 min)</option>
                <option>~150 words (≈1.5–2 min)</option>
              </select>
              <p class="help">Approximate spoken duration is shown.</p>
            </div>
          </div>
        </fieldset>

        <div class="actions">
          <button id="submit" class="btn primary" type="submit" disabled>
            <span class="btn-label">Generate script</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
          <button id="reset" class="btn" type="button">Reset</button>
          <button id="copy" class="btn" type="button" disabled>Copy</button>
          <button id="download" class="btn" type="button" disabled>Download .txt</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <details id="diagnostics" class="diag card" style="margin-top:var(--space-5)">
          <summary>Diagnostics</summary>
          <pre id="diag-json" tabindex="0" aria-label="Diagnostics JSON"></pre>
          <p class="muted">If you see a 401 unauthorised error, please <a href="/.auth/login/aad">sign in again</a>.</p>
        </details>
      </form>
    </section>

    <!-- MIDDLE -->
    <section class="panel middle">
      <div class="output-card card">
        <div class="output-head" style="display:flex;align-items:baseline;justify-content:space-between;gap:var(--space-3)">
          <h2 id="output-title">Generated Script</h2>
          <div class="meta" id="output-meta" aria-live="polite" style="color:var(--text-2);font-size:.9rem"></div>
        </div>
        <pre id="output" class="output" tabindex="0" aria-label="Generated script will appear here"></pre>
        <div class="change-log" style="margin-top:var(--space-4)">
          <h3>What changed</h3>
          <ul id="delta-log" class="delta" aria-live="polite"></ul>
        </div>
        <div class="activity" style="margin-top:var(--space-4)">
          <h3>Recent activity</h3>
          <ol id="activity-log" class="activity-log" aria-live="polite" style="margin:0;padding-left:1.25rem"></ol>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel right" aria-labelledby="intel-title">
      <aside class="intel card">
        <div class="intel-head" style="display:flex;align-items:center;justify-content:space-between;gap:var(--space-3)">
          <h2 id="intel-title">Buyer needs</h2>
          <button id="toggle-intel" class="btn small" type="button" aria-expanded="true" aria-controls="intel-body">Hide</button>
        </div>
        <div id="intel-body">
          <div class="intel-grid">
            <section><h3>1) Buyer Priorities</h3><div id="intel-priorities" class="intel-slot"></div></section>
            <section><h3>2) Typical Pains</h3><div id="intel-pains" class="intel-slot"></div></section>
            <section><h3>3) Triggers</h3><div id="intel-triggers" class="intel-slot"></div></section>
            <section><h3>4) Value Proof</h3><div id="intel-proof" class="intel-slot"></div></section>
            <section><h3>5) Objections</h3><div id="intel-objections" class="intel-slot"></div></section>
            <section><h3>6) CTAs</h3><div id="intel-ctas" class="intel-slot"></div></section>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <template id="activity-item">
    <li>
      <span class="time"></span>
      <span class="pill product"></span>
      <span class="pill buyer"></span>
      <span class="pill length"></span>
    </li>
  </template>

  <!-- ALL LOGIC: dynamic imports + bulletproof Product population -->
  <script type="module">
    // Built-in list so Product is always usable
    const LOCAL_PRODUCTS = [
      { id:'connectivity',        label:'Connectivity (mobile & fixed)' },
      { id:'cybersecurity',       label:'Cybersecurity' },
      { id:'ai',                  label:'Artificial Intelligence' },
      { id:'hardware_software',   label:'Hardware/software' },
      { id:'it_solutions',        label:'IT solutions' },
      { id:'microsoft_solutions', label:'Microsoft solutions' },
      { id:'telecoms_solutions',  label:'Telecoms solutions' }
    ];

    // ---- Dynamic imports (no hard failure) ----
    let lib = null, synth = null;
    try {
      lib = await import('/src/lib/callLibrary.js');
    } catch {
      try { lib = await import('./src/lib/callLibrary.js'); } catch {}
    }
    try {
      synth = await import('/src/lib/callSynthesis.js');
    } catch {
      try { synth = await import('./src/lib/callSynthesis.js'); } catch {}
    }

    // ---- Elements ----
    const form = document.getElementById('script-form');
    const productSel = document.getElementById('product');
    const buyerBehSel = document.getElementById('buyer_behaviour');
    const submitBtn = document.getElementById('submit');
    const resetBtn = document.getElementById('reset');
    const copyBtn = document.getElementById('copy');
    const downloadBtn = document.getElementById('download');
    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');
    const outputMeta = document.getElementById('output-meta');
    const deltaLog = document.getElementById('delta-log');
    const activityLog = document.getElementById('activity-log');
    const activityTpl = document.getElementById('activity-item');

    const REQUIRED = ['call_type','seller_name','seller_company','prospect_name','prospect_role','prospect_company','buyer_behaviour','product'];
    const nowTime = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

    // ---- Helpers ----
    function setStatus(m, kind='info'){ statusEl.textContent=m; statusEl.dataset.kind=kind; }
    function allRequiredFilled(){
      const ids = REQUIRED;
      for (const id of ids){
        const el = form.elements[id] || document.getElementById(id);
        if (!el || !String(el.value||'').trim()) return false;
      }
      return true;
    }
    function refreshSubmit(){ submitBtn.disabled = !allRequiredFilled(); }
    function setSlot(id, arr){ const el = document.getElementById(id); if (el) el.replaceChildren(...(arr?.length?arr:['No data']).map(t=>{const p=document.createElement('p'); p.textContent=t; return p;})); }
    function computeDelta(a,b){
      const A=(a||'').split('\n'), B=(b||'').split('\n'); let add=0, rem=0;
      const SA=new Set(A), SB=new Set(B);
      B.forEach(l=>{ if(!SA.has(l)&&l.trim()) add++; });
      A.forEach(l=>{ if(!SB.has(l)&&l.trim()) rem++; });
      return {add,rem};
    }
    function renderDelta(d){ deltaLog.innerHTML=''; const li1=document.createElement('li'); li1.textContent=`+${d.add} new lines`; const li2=document.createElement('li'); li2.textContent=`−${d.rem} removed lines`; deltaLog.append(li1,li2); }

    // ---- Product index with fallbacks ----
    async function loadIndex(){
      // 1) Library helper
      if (lib?.getIndex) {
        try {
          const idx = await lib.getIndex();
          if (Array.isArray(idx?.products) && idx.products.length) return idx.products;
        } catch {}
      }
      // 2) Direct URLs (covers site-root vs ./web root)
      const urls = [
        '/content/call-library/v1/index.json',
        './content/call-library/v1/index.json',
        '/web/content/call-library/v1/index.json'
      ];
      for (const u of urls){
        try {
          const r = await fetch(u, {cache:'no-store'});
          if (r.ok) {
            const j = await r.json();
            if (Array.isArray(j?.products) && j.products.length) return j.products;
          }
        } catch {}
      }
      // 3) Built-in list
      document.getElementById('product_error')?.append(' Using built-in list.');
      return LOCAL_PRODUCTS;
    }

    // ---- Populate Product immediately ----
    (async () => {
      const items = await loadIndex();
      productSel.innerHTML = '<option value="">Select…</option>';
      for (const {id, label} of items){
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = label || id;
        productSel.appendChild(opt);
      }
      refreshSubmit();
    })();

    // ---- Form wiring (trimmed to essentials for this fix) ----
    form.addEventListener('input', refreshSubmit);
    form.addEventListener('change', refreshSubmit);

    // Narrative helpers (as before)
    function toUk(text){
      if (!text) return '';
      const map = [[/organization(s)?/gi,'organisation$1'],[/organize(d|s|r|ing)?/gi,'organise$1'],[/optimization/gi,'optimisation'],[/optimi(z|s)e(?!d|r|s|ing)/gi,'optimise'],[/center(s)?/gi,'centre$1'],[/modeling/gi,'modelling'],[/license/gi,'licence'],[/utilize/gi,'utilise']];
      let out = text; for (const [re,rep] of map) out = out.replace(re,rep); return out;
    }
    function stripHeads(t){ return (t||'').replace(/^(Opening|Buyer pain|Buyer desire|Example|Objections|Call to action)\s*[-–—]*\s*$/gim,'').replace(/\n{3,}/g,'\n\n').trim(); }
    function greet(text, v){
      const p=(v.prospect_name||'').trim(), s=(v.seller_name||'').trim();
      const hello = p ? `Hi ${p}, ` : 'Hi, ';
      const intro = (s||v.seller_company) ? `${hello}it’s ${s||'a colleague'}${v.seller_company?` from ${v.seller_company}`:''}. ` : hello;
      return intro + (text ? text.charAt(0).toUpperCase()+text.slice(1) : 'Thanks for taking my call—I’ll keep this brief and useful.');
    }
    const inline = a => Array.isArray(a)&&a.length ? a.join('; ') : '';

    function compose(stages, v){
      const s = stages || {};
      const p = [];
      p.push(greet((s.opening?.talk_track||s.opening?.script||'').trim(), v));
      const pain = (s.buyer_pain?.talk_track||s.buyer_pain?.script||'').trim(); if (pain) p.push(pain);
      const desire = (s.buyer_desire?.talk_track||s.buyer_desire?.script||'').trim(); if (desire) p.push(desire);
      const ex = (s.example?.talk_track||s.example?.script||'').trim();
      const proof = inline(s.example?.proof_points_text||s.example?.proof_points||[]);
      if (ex || proof) p.push([ex, proof && `For example: ${proof}.`].filter(Boolean).join(' '));
      const obj = (s.objections?.talk_track||s.objections?.script||'').trim();
      const anticip = inline(s.objections?.anticipated||[]);
      if (obj || anticip) p.push([obj, anticip && `Common concerns we handle: ${anticip}.`].filter(Boolean).join(' '));
      let cta = (s.call_to_action?.talk_track||s.call_to_action?.script||'').trim();
      const ctas = s.call_to_action?.ctas_text||s.call_to_action?.ctas||[];
      if (!cta && ctas?.length) cta = String(ctas[0]);
      if (cta && !/[.?!]$/.test(cta)) cta += '?';
      if (cta) p.push(cta);
      return toUk(stripHeads(p.filter(Boolean).join('\n\n').trim()));
    }

    // Submit (uses synth if available)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!allRequiredFilled()){ setStatus('Please complete all required fields.','error'); return; }
      if (!synth?.generateCallFromLibrary){ setStatus('Cannot generate: library engine not loaded.','error'); return; }

      const fd = Object.fromEntries(new FormData(form).entries());
      const lookup = {
        product: fd.product,
        buyerType: lib?.canonical ? lib.canonical.buyer(fd.buyer_behaviour) : fd.buyer_behaviour,
        mode:      lib?.canonical ? lib.canonical.mode(fd.call_type) : fd.call_type
      };
      const lengthHint = Number((/\d+/.exec(fd.length||'')?.[0]) || 100);
      const formCtx = { company:fd.prospect_company, role:fd.prospect_role, sector:'', company_size:'', scenario:'', meeting_type:'first call' };

      setStatus('Synthesising call script from Library…');
      try{
        const result = await synth.generateCallFromLibrary({
          lookup, form: formCtx, tone: fd.tone, length: lengthHint
        });
        const text = compose(result.stages, {
          seller_name:fd.seller_name, seller_company:fd.seller_company, prospect_name:fd.prospect_name
        });
        outputEl.textContent = text;
        outputMeta.textContent = result.metaLine || `Library · ${lookup.product||'—'} · ${fd.buyer_behaviour||'—'} · ${fd.call_type||'—'}`;
        copyBtn.disabled = !text; downloadBtn.disabled = !text;

        setSlot('intel-priorities',   result.buyerNeeds['intel-priorities'] || []);
        setSlot('intel-pains',        result.buyerNeeds['intel-pains'] || []);
        setSlot('intel-triggers',     result.buyerNeeds['intel-priorities'] || []);
        setSlot('intel-proof',        result.buyerNeeds['intel-proof-points'] || []);
        setSlot('intel-objections',   result.buyerNeeds['intel-objections'] || []);
        setSlot('intel-ctas',         result.buyerNeeds['intel-ctas'] || []);

        const d = computeDelta('', text); renderDelta(d);
        setStatus('Done.');
      }catch(err){
        setStatus('Could not generate a call script.','error');
        document.getElementById('diag-json').textContent = String(err && err.stack || err);
        document.getElementById('diagnostics').open = true;
      }
    });

    // Reset
    resetBtn.addEventListener('click', ()=>{
      form.reset();
      productSel.value = '';
      refreshSubmit();
      setStatus('Form reset.');
    });
  </script>
</body>
</html>

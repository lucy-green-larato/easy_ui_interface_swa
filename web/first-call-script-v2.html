<!doctype html>
<html lang="en" data-app="inside-track-tools">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · First Call Script (v2)</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    /* Small, page-scoped helpers (rest lives in styles.css) */
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px;}
    .badge{display:inline-flex;gap:.5rem;align-items:center;padding:.25rem .5rem;border-radius:999px;background:var(--surface-2);font-size:.875rem}
    .kicker{font-size:.875rem;color:var(--text-2);margin-top:.125rem}
    details.diag summary{cursor:pointer}
    .remember-row{display:flex;align-items:center;gap:.5rem;margin-top:.25rem}
    .note{color:var(--text-2);font-size:.9rem}
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="app-header" role="banner">
    <div class="brand">
      <h1 class="title">Inside Track Tools</h1>
      <p class="kicker">First Call Script · v2</p>
    </div>
    <div class="signed-in">
      <span id="user-badge" class="badge" aria-live="polite" aria-atomic="true">
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="7" r="4"></circle><path d="M4 22c0-4 4-7 8-7s8 3 8 7"></path></svg>
        <span>Loading user…</span>
      </span>
    </div>
  </header>

  <main id="main" class="layout" role="main">
    <!-- LEFT: form + actions -->
    <section class="panel left" aria-labelledby="form-title">
      <h2 id="form-title">Script Inputs</h2>

      <form id="script-form" novalidate>
        <!-- NEW Card: Call type (with remember option) -->
        <fieldset class="card" aria-describedby="map-indicator">
          <legend>Call type</legend>
          <div class="field">
            <label for="call_type">Is this a direct sales call or via a partner? <span aria-hidden="true" class="req">*</span></label>
            <select id="call_type" name="call_type" required>
              <option value="">Select…</option>
              <option>Direct</option>
              <option>Partner</option>
            </select>
            <p class="error" id="call_type_error" role="alert" aria-live="polite"></p>
            <div class="remember-row">
              <input type="checkbox" id="remember_call_type" />
              <label for="remember_call_type" class="note">Remember this for future sessions</label>
            </div>
            <p id="map-indicator" class="note">Default script map: <strong id="map-label">Not set</strong></p>
          </div>
        </fieldset>

        <!-- Card: Caller -->
        <fieldset class="card">
          <legend>Caller details</legend>
          <div class="field">
            <label for="seller_name">Your name <span aria-hidden="true" class="req">*</span></label>
            <input id="seller_name" name="seller_name" required autocomplete="name" />
            <p class="help">Introduce yourself clearly at the start of the call.</p>
            <p class="error" id="seller_name_error" role="alert" aria-live="polite"></p>
          </div>

          <div class="field">
            <label for="seller_company">Your company <span aria-hidden="true" class="req">*</span></label>
            <input id="seller_company" name="seller_company" required autocomplete="organization" />
            <p class="help">Shown in the opening line and value statement.</p>
            <p class="error" id="seller_company_error" role="alert" aria-live="polite"></p>
          </div>
        </fieldset>

        <!-- Card: Prospect -->
        <fieldset class="card">
          <legend>Prospect details</legend>
          <div class="grid-2">
            <div class="field">
              <label for="prospect_name">Prospect name <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_name" name="prospect_name" required />
              <p class="error" id="prospect_name_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="prospect_role">Prospect role <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_role" name="prospect_role" required placeholder="e.g., Finance Director" />
              <p class="error" id="prospect_role_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="prospect_company">Prospect company <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_company" name="prospect_company" required />
              <p class="error" id="prospect_company_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <!-- Card: Targeting -->
        <fieldset class="card">
          <legend>Targeting</legend>
          <div class="grid-2">
            <div class="field">
              <label for="product">Product <span aria-hidden="true" class="req">*</span></label>
              <select id="product" name="product" required>
                <option value="">Loading…</option>
              </select>
              <p class="help">One of the Inside Track product categories.</p>
              <p class="error" id="product_error" role="alert" aria-live="polite"></p>
            </div>

            <!-- CHANGED: Buyer type → Buyer behaviour -->
            <div class="field">
              <label for="buyer_behaviour">Buyer behaviour <span aria-hidden="true" class="req">*</span></label>
              <select id="buyer_behaviour" name="buyer_behaviour" required>
                <option value="">Select…</option>
                <option>Innovator</option>
                <option>Early adopter</option>
                <option>Early majority</option>
                <option>Late majority</option>
                <option>Sceptic</option>
              </select>
              <p class="help">Adoption profile from the Inside Track company record.</p>
              <p class="error" id="buyer_behaviour_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <!-- Card: Script Preferences -->
        <fieldset class="card">
          <legend>Script preferences</legend>
          <div class="grid-2">
            <div class="field">
              <label for="tone">Tone</label>
              <input id="tone" name="tone" placeholder="Professional, warm, concise" />
              <p class="help">Optional guidance for tone of voice.</p>
            </div>

            <div class="field">
              <label for="length">Length</label>
              <select id="length" name="length">
                <option>~100 words</option>
                <option>~50 words</option>
                <option>~150 words</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="value_proposition">Value proposition</label>
            <textarea id="value_proposition" name="value_proposition" rows="2" placeholder="Your one-liner value statement"></textarea>
          </div>

          <div class="field">
            <label for="call_to_action">Call to action</label>
            <input id="call_to_action" name="call_to_action" placeholder="E.g., 20-minute discovery next week" />
          </div>

          <div class="field">
            <label for="context">Context</label>
            <textarea id="context" name="context" rows="3" placeholder="Any relevant background for the model"></textarea>
          </div>
        </fieldset>

        <!-- Actions -->
        <div class="actions">
          <button id="submit" class="btn primary" type="submit" disabled>
            <span class="btn-label">Generate script</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
          <button id="reset" class="btn" type="button">Reset</button>
          <button id="copy" class="btn" type="button" disabled>Copy</button>
          <button id="download" class="btn" type="button" disabled>Download .txt</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <details id="diagnostics" class="diag">
          <summary>Diagnostics</summary>
          <pre id="diag-json" tabindex="0" aria-label="Diagnostics JSON"></pre>
          <p class="muted">If you see a 401 unauthorised error, please <a href="/.auth/login/aad">sign in again</a>.</p>
        </details>
      </form>
    </section>

    <!-- RIGHT: output + market intel -->
    <section class="panel right" aria-labelledby="output-title">
      <div class="split">
        <div class="output-card card">
          <div class="output-head">
            <h2 id="output-title">Generated Script</h2>
            <div class="meta" id="output-meta" aria-live="polite"></div>
          </div>
          <pre id="output" class="output" tabindex="0" aria-label="Generated script will appear here"></pre>
          <div class="change-log">
            <h3>What changed</h3>
            <ul id="delta-log" class="delta" aria-live="polite"></ul>
          </div>
          <div class="activity">
            <h3>Recent activity</h3>
            <ol id="activity-log" class="activity-log" aria-live="polite"></ol>
          </div>
        </div>

        <aside class="intel card" aria-labelledby="intel-title">
          <div class="intel-head">
            <h2 id="intel-title">Market Intelligence</h2>
            <button id="toggle-intel" class="btn small" type="button" aria-expanded="true" aria-controls="intel-body">Hide</button>
          </div>
          <div id="intel-body">
            <div class="intel-grid">
              <section>
                <h3>1) Buyer Priorities</h3>
                <div id="intel-priorities" class="intel-slot"></div>
              </section>
              <section>
                <h3>2) Typical Pains</h3>
                <div id="intel-pains" class="intel-slot"></div>
              </section>
              <section>
                <h3>3) Triggers</h3>
                <div id="intel-triggers" class="intel-slot"></div>
              </section>
              <section>
                <h3>4) Value Proof</h3>
                <div id="intel-proof" class="intel-slot"></div>
              </section>
              <section>
                <h3>5) Objections</h3>
                <div id="intel-objections" class="intel-slot"></div>
              </section>
              <section>
                <h3>6) CTAs</h3>
                <div id="intel-ctas" class="intel-slot"></div>
              </section>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <template id="activity-item">
    <li>
      <span class="time"></span>
      <span class="pill product"></span>
      <span class="pill buyer"></span>
      <span class="pill length"></span>
    </li>
  </template>

  <script>
    (function () {
      const FORM_ID = 'script-form';
      const STORAGE_KEY = 'first_call_script_v2.form';
      const ACTIVITY_KEY = 'first_call_script_v2.activity';
      const OUTPUT_KEY = 'first_call_script_v2.last_output';
      const CALL_PREF_KEY = 'first_call_script_v2.call_pref'; // NEW: persisted default call type
      const INTEL_URL = './intel.json';
      const REQUIRED = [
        'call_type',           // now in its own card
        'seller_name',
        'seller_company',
        'prospect_name',
        'prospect_role',
        'prospect_company',
        'buyer_behaviour',     // CHANGED: replaces buyer_type
        'product'
      ];

      // Elements
      const form = document.getElementById(FORM_ID);
      const submitBtn = document.getElementById('submit');
      const resetBtn = document.getElementById('reset');
      const copyBtn = document.getElementById('copy');
      const downloadBtn = document.getElementById('download');
      const outputEl = document.getElementById('output');
      const outputMeta = document.getElementById('output-meta');
      const statusEl = document.getElementById('status');
      const deltaLog = document.getElementById('delta-log');
      const activityLog = document.getElementById('activity-log');
      const activityTpl = document.getElementById('activity-item');
      const diag = document.getElementById('diagnostics');
      const diagJson = document.getElementById('diag-json');
      const productSel = document.getElementById('product');
      const buyerBehSel = document.getElementById('buyer_behaviour');
      const toggleIntelBtn = document.getElementById('toggle-intel');
      const intelBody = document.getElementById('intel-body');
      const callTypeSel = document.getElementById('call_type');
      const rememberCallType = document.getElementById('remember_call_type');
      const mapLabel = document.getElementById('map-label');

      const intelSlots = {
        priorities: document.getElementById('intel-priorities'),
        pains: document.getElementById('intel-pains'),
        triggers: document.getElementById('intel-triggers'),
        proof: document.getElementById('intel-proof'),
        objections: document.getElementById('intel-objections'),
        ctas: document.getElementById('intel-ctas'),
      };

      let intel = null;
      let lastOutput = localStorage.getItem(OUTPUT_KEY) || '';

      // Utility
      const qs = (name) => form.querySelector(`[name="${name}"]`);
      const nowTime = () => new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });

      function setBusy(isBusy) {
        submitBtn.disabled = isBusy || !form.checkValidity();
        resetBtn.disabled = isBusy;
        copyBtn.disabled = isBusy || !outputEl.textContent.trim();
        downloadBtn.disabled = isBusy || !outputEl.textContent.trim();
        submitBtn.classList.toggle('busy', isBusy);
      }

      function setStatus(msg, kind='info') {
        statusEl.textContent = msg;
        statusEl.dataset.kind = kind;
      }

      function validateField(input) {
        const errorEl = document.getElementById(`${input.id}_error`);
        if (!errorEl) return;
        if (input.validity.valid) {
          errorEl.textContent = '';
          input.classList.remove('invalid');
        } else {
          input.classList.add('invalid');
          let message = 'Please fill out this field.';
          if (input.validity.valueMissing) message = 'This field is required.';
          errorEl.textContent = message;
        }
      }

      function saveForm() {
        const data = Object.fromEntries(new FormData(form).entries());
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      function loadForm() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          Object.entries(data).forEach(([k,v]) => {
            const el = qs(k);
            if (el) el.value = v;
          });
        } catch {}
      }

      function clearFormState() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(ACTIVITY_KEY);
        // keep last output and call preference
      }

      function refreshSubmitState() {
        submitBtn.disabled = !form.checkValidity();
      }

      // --- Market Intelligence (still product × buyer — may show fallback if no data) ---
      function renderIntel(product, buyer) {
        if (!intel) return;
        const p = intel.products?.[product];
        // buyer mapping kept for compatibility; may not exist for behaviours → fallback shown
        const b = p?.buyers?.[buyer];
        const fallback = (arr) => (arr && arr.length ? arr : ['No data available for this selection.']);
        intelSlots.priorities.replaceChildren(...fallback(b?.priorities).map(li));
        intelSlots.pains.replaceChildren(...fallback(b?.pains).map(li));
        intelSlots.triggers.replaceChildren(...fallback(b?.triggers).map(li));
        intelSlots.proof.replaceChildren(...fallback(b?.proof).map(li));
        intelSlots.objections.replaceChildren(...fallback(b?.objections).map(li));
        intelSlots.ctas.replaceChildren(...fallback(b?.ctas).map(li));
      }

      function li(text) {
        const el = document.createElement('p');
        el.textContent = text;
        return el;
      }

      // --- Call type preference (script map default) ---
      function loadCallPref() {
        try {
          const pref = JSON.parse(localStorage.getItem(CALL_PREF_KEY) || 'null');
          if (pref?.call_type && !callTypeSel.value) {
            callTypeSel.value = pref.call_type;
          }
          updateMapIndicator();
          if (pref?.remember === true) rememberCallType.checked = true;
        } catch { updateMapIndicator(); }
      }

      function saveCallPrefIfRequested() {
        if (rememberCallType.checked && callTypeSel.value) {
          localStorage.setItem(CALL_PREF_KEY, JSON.stringify({ remember: true, call_type: callTypeSel.value }));
        } else {
          // Do not discard an existing pref unless the user unticks remember
          if (!rememberCallType.checked) {
            localStorage.removeItem(CALL_PREF_KEY);
          }
        }
        updateMapIndicator();
      }

      function updateMapIndicator() {
        const pref = JSON.parse(localStorage.getItem(CALL_PREF_KEY) || 'null');
        const label = pref?.call_type ? pref.call_type : 'Not set';
        mapLabel.textContent = label;
      }

      // --- Activity log ---
      function addActivity(entry) {
        const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]');
        list.unshift(entry);
        localStorage.setItem(ACTIVITY_KEY, JSON.stringify(list.slice(0,3)));
        renderActivity();
      }

      function renderActivity() {
        const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]');
        activityLog.innerHTML = '';
        list.forEach(item => {
          const node = activityTpl.content.cloneNode(true);
          node.querySelector('.time').textContent = item.time;
          node.querySelector('.product').textContent = item.product;
          node.querySelector('.buyer').textContent = item.buyer_behaviour;
          node.querySelector('.length').textContent = item.length;
          activityLog.appendChild(node);
        });
      }

      // --- Delta between outputs ---
      function computeDelta(oldText, newText) {
        const oldLines = oldText.split('\n');
        const newLines = newText.split('\n');
        let added = 0, removed = 0;
        const oldSet = new Set(oldLines);
        const newSet = new Set(newLines);
        newLines.forEach(l => { if (!oldSet.has(l) && l.trim()) added++; });
        oldLines.forEach(l => { if (!newSet.has(l) && l.trim()) removed++; });
        return { added, removed };
      }

      function renderDelta(delta) {
        deltaLog.innerHTML = '';
        const a = document.createElement('li');
        a.textContent = `+${delta.added} new line${delta.added===1?'':'s'}`;
        const r = document.createElement('li');
        r.textContent = `−${delta.removed} removed line${delta.removed===1?'':'s'}`;
        deltaLog.appendChild(a);
        deltaLog.appendChild(r);
      }

      async function getUser() {
        try {
          const res = await fetch('/.auth/me', { credentials: 'include' });
          const el = document.getElementById('user-badge');
          if (!res.ok) throw new Error('auth');
          const data = await res.json();
          const claim = data?.clientPrincipal?.userDetails || 'Signed in';
          el.querySelector('span:last-child').textContent = claim;
        } catch {
          const el = document.getElementById('user-badge');
          el.querySelector('span:last-child').innerHTML = 'Not signed in — <a href="/.auth/login/aad">Sign in</a>';
        }
      }

      // Event wiring
      form.addEventListener('input', (e) => {
        if (e.target.matches('input,select,textarea')) {
          validateField(e.target);
          saveForm();
          refreshSubmitState();
        }
      });

      form.addEventListener('change', (e) => {
        if (e.target === productSel || e.target === buyerBehSel) {
          renderIntel(productSel.value, buyerBehSel.value);
        }
        if (e.target === callTypeSel || e.target === rememberCallType) {
          saveCallPrefIfRequested();
        }
      });

      document.getElementById('toggle-intel').addEventListener('click', () => {
        const expanded = toggleIntelBtn.getAttribute('aria-expanded') === 'true';
        toggleIntelBtn.setAttribute('aria-expanded', String(!expanded));
        intelBody.hidden = expanded;
        toggleIntelBtn.textContent = expanded ? 'Show' : 'Hide';
      });

      document.getElementById('reset').addEventListener('click', () => {
        form.reset();
        clearFormState();
        // Keep remembered call type (separate store)
        loadCallPref(); // will reapply remembered default & indicator
        renderIntel(productSel.value, buyerBehSel.value);
        renderActivity();
        refreshSubmitState();
        setStatus('Form reset. Stored values cleared.');
        form.querySelector('input, select, textarea')?.focus();
      });

      document.getElementById('copy').addEventListener('click', async () => {
        const txt = outputEl.textContent;
        if (!txt.trim()) return;
        await navigator.clipboard.writeText(txt);
        setStatus('Copied to clipboard.');
      });

      document.getElementById('download').addEventListener('click', () => {
        const txt = outputEl.textContent;
        if (!txt.trim()) return;
        const blob = new Blob([txt], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `first-call-script_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setStatus('Download started.');
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        // Validate
        let firstInvalid = null;
        [...form.elements].forEach(el => {
          if (el.matches('input,select,textarea')) {
            validateField(el);
            if (!firstInvalid && !el.checkValidity()) firstInvalid = el;
          }
        });
        if (firstInvalid) {
          setStatus('Please fix the highlighted fields.', 'error');
          firstInvalid.focus();
          return;
        }

        // Persist call type preference if asked
        saveCallPrefIfRequested();

        // Collect variables using current field names, map buyer_behaviour -> buyer_type to keep API contract
        const fd = Object.fromEntries(new FormData(form).entries());
        const variables = {
          seller_name: fd.seller_name || '',
          seller_company: fd.seller_company || '',
          prospect_name: fd.prospect_name || '',
          prospect_role: fd.prospect_role || '',
          prospect_company: fd.prospect_company || '',
          call_type: fd.call_type || '',
          buyer_type: fd.buyer_behaviour || '',   // API expects buyer_type
          product: fd.product || '',
          tone: fd.tone || '',
          length: fd.length || '',
          call_to_action: fd.call_to_action || '',
          context: fd.context || '',
          value_proposition: fd.value_proposition || ''
        };

        const payload = {
          pack: 'uk_b2b_sales_core',
          template: 'first_call_script_v2', // unchanged; back end can branch by call_type
          variables
        };

        setBusy(true);
        setStatus('Generating…');
        diag.open = false;
        diagJson.textContent = '';

        const t0 = performance.now();
        try {
          const res = await fetch('/api/generate', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload),
            credentials: 'include'
          });

          const text = await res.text();
          let data = {};
          try { data = JSON.parse(text); } catch {}

          if (!res.ok) {
            if (res.status === 401) {
              setStatus('Unauthorised. Please sign in again.', 'error');
            } else if (res.status === 400) {
              setStatus('Request was rejected. See diagnostics below.', 'error');
            } else {
              setStatus(`Error ${res.status}. See diagnostics below.`, 'error');
            }
            diag.open = true;
            diagJson.textContent = JSON.stringify({ status: res.status, body: data || text }, null, 2);
            document.getElementById('diagnostics').scrollIntoView({behavior: window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto':'smooth'});
            document.getElementById('diagnostics').focus();
            return;
          }

          const out = (data.output || data.preview || '').trim();
          outputEl.textContent = out || '(No output returned.)';
          const t1 = performance.now();
          outputMeta.textContent = `Generated at ${nowTime()} · pack: ${data.packPath || 'uk_b2b_sales_core'} · template: ${data.template || 'first_call_script_v2'} · ${(t1 - t0).toFixed(0)}ms`;

          // Enable actions
          copyBtn.disabled = !out;
          downloadBtn.disabled = !out;

          // Delta
          const delta = computeDelta(lastOutput, out);
          renderDelta(delta);
          lastOutput = out;
          localStorage.setItem(OUTPUT_KEY, out);

          // Activity
          addActivity({
            time: nowTime(),
            product: variables.product || '—',
            buyer_behaviour: variables.buyer_type || '—',
            length: variables.length || '—'
          });

          setStatus('Done. Script ready.');
          document.getElementById('output-title').focus();

        } catch (err) {
          setStatus('Network error. Please try again.', 'error');
          diag.open = true;
          diagJson.textContent = String(err);
          document.getElementById('diagnostics').focus();
        } finally {
          setBusy(false);
        }
      });

      // Init
      (async function init(){
        // Auth badge
        try {
          const res = await fetch('/.auth/me', { credentials: 'include' });
          const el = document.getElementById('user-badge');
          if (!res.ok) throw new Error('auth');
          const data = await res.json();
          const claim = data?.clientPrincipal?.userDetails || 'Signed in';
          el.querySelector('span:last-child').textContent = claim;
        } catch {
          const el = document.getElementById('user-badge');
          el.querySelector('span:last-child').innerHTML = 'Not signed in — <a href="/.auth/login/aad">Sign in</a>';
        }

        // Load intel (unchanged schema)
        try {
          const res = await fetch(INTEL_URL, { cache: 'no-store' });
          intel = await res.json();
        } catch { intel = { products: {} }; }

        // Restore form values
        loadForm();

        // Apply remembered call type ONLY if field is empty (so it acts as a default)
        loadCallPref();

        // Populate product options from intel.json (if available)
        const products = Object.keys(intel.products || {});
        productSel.innerHTML = '<option value="">Select…</option>';
        products.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p; opt.textContent = p;
          productSel.appendChild(opt);
        });

        // Render intel on load if we have both values
        if (productSel.value && buyerBehSel.value) {
          renderIntel(productSel.value, buyerBehSel.value);
        }

        // Validate once on load (for restored state)
        REQUIRED.forEach(name => { const el = qs(name); if (el) validateField(el); });
        submitBtn.disabled = !form.checkValidity();

        // Activity + output
        renderActivity();
        const last = localStorage.getItem(OUTPUT_KEY);
        if (last) { outputEl.textContent = last; copyBtn.disabled = false; downloadBtn.disabled = false; }

        setStatus('Ready.');
      })();
    })();
  </script>
</body>
</html>

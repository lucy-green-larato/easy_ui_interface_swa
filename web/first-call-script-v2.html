<!doctype html>
<html lang="en" data-app="inside-track-tools">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · First Call Script (v2)</title>
  <link rel="stylesheet" href="./styles.css?v=fix4" />
  <style>
    /* Page-scoped tweaks only */
    :root{
      --right-min: 280px;
      --space-3: 12px; --space-4:16px; --space-5:24px; --space-6:32px;
      --surface-3:#e5e8ee; --text-2:#5b6270; --accent:#2458e6; --bg:#f7f7f9;
    }
    body{background:var(--bg)}
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.35fr) minmax(0,2.65fr) minmax(var(--right-min),clamp(260px,14vw,300px));
      gap:var(--space-6); padding:var(--space-5); align-items:start; width:100%;
    }
    @media (max-width:1200px){ .layout{ grid-template-columns:1fr; } }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:var(--space-3) }
    @media (max-width: 800px){ .grid-2{ grid-template-columns:1fr } }

    /* Readable script box */
    .output{
      white-space:pre-wrap;
      background:#fff;
      color:#111827;
      border:1px solid #e5e7eb;
      padding:var(--space-5);
      border-radius:12px;
      min-height:260px;
      outline:none;
      font: 16.5px/1.7 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      letter-spacing:.005em;
    }

    .tips-card ul{ margin:.5rem 0 0; padding-left:1.25rem }
    .tips-card ul li{ margin:.25rem 0 }

    .panel .card h3{ margin: 0 0 .5rem 0 }

    .intel-grid{ display:grid; grid-template-columns:1fr !important; gap:var(--space-3) }

    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--surface-3); background:#fff;
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus,select:focus,textarea:focus{ box-shadow:0 0 0 2px rgba(36,88,230,.35); border-color:var(--accent); }

    /* Small UI bits */
    .row-between{ display:flex; align-items:center; justify-content:space-between; gap:var(--space-3) }
    .btn.inline{ padding:.35rem .6rem; font-size:.9rem }
    .muted{ color:var(--text-2) }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header" role="banner">
    <div class="header-left">
      <img class="logo" src="./larato-logo.svg" alt="Larato" />
      <div class="brand-text">
        <h1 class="app-title">Inside Track Tools</h1>
        <p class="kicker">First Call Script · v2</p>
      </div>
    </div>

    <div class="header-right">
      <div class="calltype-mini" role="group" aria-labelledby="sales-model-label">
        <span id="sales-model-label" class="mini-label">Direct or partner sales</span>
        <select id="call_type" name="call_type" form="script-form" required aria-describedby="call_type_error">
          <option value="">Select…</option>
          <option>Direct</option>
          <option>Partner</option>
        </select>
        <label class="remember">
          <input type="checkbox" id="remember_call_type" form="script-form" />
          Remember
        </label>
        <span id="call_type_error" class="error-inline" role="alert" aria-live="polite"></span>
      </div>

      <span class="model-note">
        <span class="label">Sales model in use:</span>
        <strong id="map-label">Not set</strong>
      </span>

      <span id="user-badge" class="badge is-hidden" aria-live="polite" aria-atomic="true">
        <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="7" r="4"></circle><path d="M4 22c0-4 4-7 8-7s8 3 8 7"></path></svg>
        <span>Loading user…</span>
      </span>
    </div>
  </header>

  <!-- LAYOUT: Form | Script | Buyer needs -->
  <main id="main" class="layout" role="main">
    <!-- LEFT -->
    <section class="panel left" aria-label="Form">
      <form id="script-form" novalidate>
        <fieldset class="card" aria-labelledby="legend-call-details">
          <legend id="legend-call-details">Call details</legend>
          <div class="grid-2">
            <div class="field">
              <label for="seller_name">Your name <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_name" name="seller_name" required autocomplete="name" />
              <p class="error" id="seller_name_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="seller_company">Your company <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_company" name="seller_company" required autocomplete="organization" />
              <p class="error" id="seller_company_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="prospect_name">Prospect name <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_name" name="prospect_name" required />
              <p class="error" id="prospect_name_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="prospect_role">Prospect role <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_role" name="prospect_role" required placeholder="e.g., Finance Director" />
              <p class="error" id="prospect_role_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="prospect_company">Prospect company <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_company" name="prospect_company" required />
              <p class="error" id="prospect_company_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="card" aria-labelledby="legend-targeting">
          <legend id="legend-targeting">Targeting</legend>
          <div class="grid-2">
            <div class="field">
              <label for="product">Product <span aria-hidden="true" class="req">*</span></label>
              <select id="product" name="product" required>
                <option value="">Loading…</option>
              </select>
              <p class="error" id="product_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="buyer_behaviour">Buyer behaviour <span aria-hidden="true" class="req">*</span></label>
              <select id="buyer_behaviour" name="buyer_behaviour" required>
                <option value="">Select…</option>
                <option>Innovator</option>
                <option>Early adopter</option>
                <option>Early majority</option>
                <option>Late majority</option>
                <option>Sceptic</option>
              </select>
              <p class="error" id="buyer_behaviour_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="card" aria-labelledby="legend-preferences">
          <legend id="legend-preferences">Script preferences</legend>
          <div class="grid-2">
            <div class="field">
              <label for="tone">Tone</label>
              <select id="tone" name="tone">
                <option selected>Professional (corporate)</option>
                <option>Warm (professional)</option>
              </select>
            </div>

            <div class="field">
              <label for="length">Length</label>
              <select id="length" name="length">
                <option>~150 words (≈1 min)</option>
                <option selected>~300 words (≈2–3 min)</option>
                <option>~450 words (≈3–4 min)</option>
                <option>~650 words (≈4–5 min)</option>
              </select>
            </div>
          </div>

          <!-- USPs + Other points (optional, used in narrative) -->
          <div class="field">
            <label for="value_proposition">Unique Selling Points (optional)</label>
            <textarea id="value_proposition" name="value_proposition" rows="2" placeholder="e.g., pooled data; contract portability; self-serve provisioning"></textarea>
          </div>

          <div class="field">
            <label for="context">Other points to cover (optional)</label>
            <textarea id="context" name="context" rows="3" placeholder="Any specific themes you want woven into the call (comma, semicolon or new line separated)."></textarea>
          </div>

          <!-- NEW: Next step (salesperson-chosen) -->
          <div class="field">
            <label for="next_step">Your desired next step (shown verbatim in the script)</label>
            <input id="next_step" name="next_step" placeholder="e.g., I’ll send a 1-page summary and we can pick it up from there." />
          </div>
        </fieldset>

        <div class="actions">
          <button id="submit" class="btn primary" type="submit" disabled>
            <span class="btn-label">Generate script</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
          <button id="reset" class="btn" type="button">Reset</button>
          <button id="copy" class="btn" type="button" disabled>Copy</button>
          <button id="download" class="btn" type="button" disabled>Download .txt</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <details id="diagnostics" class="diag card" style="margin-top:var(--space-5)">
          <summary>Diagnostics</summary>
          <pre id="diag-json" tabindex="0" aria-label="Diagnostics JSON"></pre>
          <p class="muted">If you see a 401 unauthorised error, please <a href="/.auth/login/aad">sign in again</a>.</p>
        </details>
      </form>
    </section>

    <!-- MIDDLE -->
    <section class="panel middle">
      <div class="output-card card">
        <div class="row-between output-head">
          <h2 id="output-title">Generated Script</h2>
          <div class="row-between" style="gap:8px">
            <button id="popout" class="btn inline" type="button" title="Open script in a clean window">Pop-out</button>
            <div class="meta" id="output-meta" aria-live="polite" style="color:var(--text-2);font-size:.9rem"></div>
          </div>
        </div>
        <pre id="output" class="output" tabindex="0" aria-label="Generated script will appear here"></pre>

        <!-- Helpful tips (separate box) -->
        <div class="tips-card card" style="margin-top:var(--space-4)">
          <div class="row-between">
            <h3>Helpful tips</h3>
            <button id="toggle-tips" class="btn inline" type="button" aria-expanded="true" aria-controls="tips-list">Hide tips</button>
          </div>
          <ul id="tips-list"></ul>
        </div>

        <!-- Notes -->
        <div class="notes-card card" style="margin-top:var(--space-4)">
          <div class="row-between">
            <h3>Call notes</h3>
            <div class="row-between" style="gap:8px">
              <button id="save-notes" class="btn inline" type="button">Save notes</button>
              <button id="download-notes" class="btn inline" type="button">Download .txt</button>
            </div>
          </div>
          <textarea id="notes" rows="6" placeholder="Type notes during the call. Saved locally on this device."></textarea>
          <p class="muted" style="margin-top:.5rem">Notes are stored locally (this browser only).</p>
        </div>

        <div class="change-log" style="margin-top:var(--space-4)">
          <h3>What changed</h3>
          <ul id="delta-log" class="delta" aria-live="polite"></ul>
        </div>
        <div class="activity" style="margin-top:var(--space-4)">
          <h3>Recent activity</h3>
          <ol id="activity-log" class="activity-log" aria-live="polite" style="margin:0;padding-left:1.25rem"></ol>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel right" aria-labelledby="intel-title">
      <aside class="intel card">
        <div class="intel-head" style="display:flex;align-items:center;justify-content:space-between;gap:var(--space-3)">
          <h2 id="intel-title">Buyer needs</h2>
          <button id="toggle-intel" class="btn small" type="button" aria-expanded="true" aria-controls="intel-body">Hide</button>
        </div>
        <div id="intel-body">
          <div class="intel-grid">
            <section><h3>1) Buyer Priorities</h3><div id="intel-priorities" class="intel-slot"></div></section>
            <section><h3>2) Typical Pains</h3><div id="intel-pains" class="intel-slot"></div></section>
            <section><h3>3) Triggers</h3><div id="intel-triggers" class="intel-slot"></div></section>
            <section><h3>4) Value Proof</h3><div id="intel-proof" class="intel-slot"></div></section>
            <section><h3>5) Objections</h3><div id="intel-objections" class="intel-slot"></div></section>
            <section><h3>6) CTAs</h3><div id="intel-ctas" class="intel-slot"></div></section>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <template id="activity-item">
    <li>
      <span class="time"></span>
      <span class="pill product"></span>
      <span class="pill buyer"></span>
      <span class="pill length"></span>
    </li>
  </template>

  <!-- === SCRIPT: glue UI to library (prompt-based) === -->
  <script type="module">
    /* IMPORTANT: relative import so it works under sub-paths */
    import { getIndex, canonical } from "./src/lib/callLibrary.js";
    import { generatePromptBasedCallScript } from "./src/lib/callPromptEngine.js";

    (function () {
      const FORM_ID = 'script-form';
      const STORAGE_KEY = 'first_call_script_v2.form';
      const ACTIVITY_KEY = 'first_call_script_v2.activity';
      const OUTPUT_KEY = 'first_call_script_v2.last_output';
      const CALL_PREF_KEY = 'first_call_script_v2.call_pref';
      const TIPS_HIDDEN_KEY = 'first_call_script_v2.tips_hidden';
      const NOTES_KEY_PREFIX = 'first_call_script_v2.notes';
      const INTEL_URL = './intel.json';
      const RESTORE_LAST = false;

      const REQUIRED = ['call_type','seller_name','seller_company','prospect_name','prospect_role','prospect_company','buyer_behaviour','product'];

      const form = document.getElementById(FORM_ID);
      const submitBtn = document.getElementById('submit');
      const resetBtn = document.getElementById('reset');
      const copyBtn = document.getElementById('copy');
      const downloadBtn = document.getElementById('download');
      const outputEl = document.getElementById('output');
      const tipsCard = document.querySelector('.tips-card');
      const tipsList = document.getElementById('tips-list');
      const toggleTipsBtn = document.getElementById('toggle-tips');
      const popoutBtn = document.getElementById('popout');
      const notesArea = document.getElementById('notes');
      const saveNotesBtn = document.getElementById('save-notes');
      const downloadNotesBtn = document.getElementById('download-notes');
      const outputMeta = document.getElementById('output-meta');
      const statusEl = document.getElementById('status');
      const deltaLog = document.getElementById('delta-log');
      const activityLog = document.getElementById('activity-log');
      const activityTpl = document.getElementById('activity-item');
      const diag = document.getElementById('diagnostics');
      const diagJson = document.getElementById('diag-json');

      const productSel = document.getElementById('product');
      const buyerBehSel = document.getElementById('buyer_behaviour');
      const toggleIntelBtn = document.getElementById('toggle-intel');
      const intelBody = document.getElementById('intel-body');

      const callTypeSel = document.getElementById('call_type');
      const rememberCallType = document.getElementById('remember_call_type');
      const mapLabel = document.getElementById('map-label');

      let intel = null;
      let lastOutput = localStorage.getItem(OUTPUT_KEY) || '';

      const nowTime = () => new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      const on = (el, evts, h, opt) => { if (el) evts.forEach(e => el.addEventListener(e, h, opt)); };

      function setBusy(isBusy) {
        submitBtn && (submitBtn.disabled = isBusy || !allRequiredFilled(form));
        resetBtn && (resetBtn.disabled = isBusy);
        const hasText = !!(outputEl?.textContent?.trim());
        copyBtn && (copyBtn.disabled = isBusy || !hasText);
        downloadBtn && (downloadBtn.disabled = isBusy || !hasText);
        submitBtn && submitBtn.classList.toggle('busy', isBusy);
      }
      function setStatus(msg, kind='info'){ if (statusEl){ statusEl.textContent = msg; statusEl.dataset.kind = kind; } }

      function allRequiredFilled(formEl){
        if (!formEl) return false;
        const labels = { call_type:'Direct or partner sales', seller_name:'Your name', seller_company:'Your company',
          prospect_name:'Prospect name', prospect_role:'Prospect role', prospect_company:'Prospect company',
          buyer_behaviour:'Buyer behaviour', product:'Product' };
        const missing = [];
        for (const name of REQUIRED){
          const el = formEl.elements[name] || document.getElementById(name);
          const val = (el && typeof el.value === 'string') ? el.value.trim() : '';
          if (!val) missing.push(labels[name] || name);
        }
        if (missing.length) setStatus(`Please complete: ${missing.join(', ')}.`, 'error'); else setStatus('');
        return missing.length === 0;
      }
      function refreshSubmitState(){ submitBtn && (submitBtn.disabled = !allRequiredFilled(form)); }

      function validateField(input) {
        if (!input) return;
        const id = input.id;
        const errorEl = document.getElementById(`${id}_error`) || (id==='call_type' ? document.getElementById('call_type_error') : null);
        const valid = !!String(input.value || '').trim();
        if (!errorEl) return;
        if (valid) { errorEl.textContent=''; input.removeAttribute('aria-invalid'); input.classList.remove('invalid'); }
        else { errorEl.textContent = id==='call_type' ? 'Please choose a call type.' : 'This field is required.'; input.setAttribute('aria-invalid','true'); input.classList.add('invalid'); }
      }

      function saveForm(){
        if (!form) return;
        const fd = Object.fromEntries(new FormData(form).entries());
        localStorage.setItem(STORAGE_KEY, JSON.stringify(fd));
      }
      function loadForm(){
        if (!form) return;
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          Object.entries(data).forEach(([k,v]) => {
            const el = form.elements[k] || document.getElementById(k);
            if (el) el.value = v;
          });
        } catch {}
      }
      function clearFormState(){
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(ACTIVITY_KEY);
      }

      // ---------- Buyer needs helpers ----------
      const toArr = v => Array.isArray(v) ? v.filter(Boolean).map(String) : (v ? [String(v)] : []);
      const norm = s => String(s || '').toLowerCase().replace(/\s+/g,' ').replace(/[\u2010-\u2015_\-\/]+/g,'-').replace(/[^\w\- ]+/g,'').trim();
      const BEHAVIOUR_SYNONYMS = { 'early adopter':'early-adopter','early majority':'early-majority','late majority':'late-majority','skeptic':'sceptic','sceptic':'sceptic' };
      function getKeyInsensitive(obj, requested){
        if (!obj || typeof obj !== 'object') return null;
        const want = norm(requested);
        for (const k of Object.keys(obj)) if (norm(k) === want) return k;
        for (const k of Object.keys(obj)) if (norm(k).includes(want)) return k;
        return null;
      }
      const pEl = t => { const el=document.createElement('p'); el.textContent=t; return el; };
      const setSlot = (id, arr=[]) => {
        const slot=document.getElementById(id);
        const items=(arr.length?arr:['No data available for this selection.']);
        slot && slot.replaceChildren(...items.map(pEl));
      };
      const fillAll = arr => {
        setSlot('intel-priorities', arr); setSlot('intel-pains', arr); setSlot('intel-triggers', arr);
        setSlot('intel-proof', arr); setSlot('intel-objections', arr); setSlot('intel-ctas', arr);
      };

      function normaliseIntel(raw){
        if (!raw || typeof raw !== 'object') return { products:{} };
        if (raw.products && typeof raw.products === 'object') return raw;
        const out = { products:{} };
        Object.entries(raw).forEach(([product, buyersObj]) => {
          const behaviours = {};
          if (buyersObj && typeof buyersObj === 'object') {
            Object.entries(buyersObj).forEach(([behaviour, arr]) => {
              const [priorities, pains, triggers, proof, objections, ctas] = Array.isArray(arr) ? arr : [];
              behaviours[behaviour] = { priorities: toArr(priorities), pains: toArr(pains), triggers: toArr(triggers), proof: toArr(proof), objections: toArr(objections), ctas: toArr(ctas) };
            });
          }
          out.products[product] = { behaviours };
        });
        return out;
      }

      function renderIntel(productLabel, behaviourLabel){
        if (!intel) return;
        const products = intel.products || {};
        const productKey = getKeyInsensitive(products, productLabel);
        const productNode = productKey ? products[productKey] : null;
        if (!productNode){ fillAll([`No data available (unknown product).`]); return; }

        let node = null;
        if (productNode.behaviours){
          let key = getKeyInsensitive(productNode.behaviours, behaviourLabel);
          if (!key){ const syn = BEHAVIOUR_SYNONYMS[norm(behaviourLabel)]; if (syn) key = getKeyInsensitive(productNode.behaviours, syn); }
          if (key) node = productNode.behaviours[key];
        }
        if (!node && productNode.buyers){
          let key = getKeyInsensitive(productNode.buyers, behaviourLabel);
          if (!key){ const syn = BEHAVIOUR_SYNONYMS[norm(behaviourLabel)]; if (syn) key = getKeyInsensitive(productNode.buyers, syn); }
          if (key) node = productNode.buyers[key];
        }
        if (!node && productNode.needs) node = productNode.needs;

        if (!node){
          const behavioursList = [...Object.keys(productNode.behaviours || {}), ...Object.keys(productNode.buyers || {})].join(', ') || '—';
          fillAll([`No data for this behaviour. Available: ${behavioursList}`]);
          return;
        }

        const sections = {
          priorities: toArr(node?.priorities ?? node?.Priorities),
          pains:      toArr(node?.pains      ?? node?.Pains),
          triggers:   toArr(node?.triggers   ?? node?.Triggers),
          proof:      toArr(node?.proof      ?? node?.Proof ?? node?.value ?? node?.Value),
          objections: toArr(node?.objections ?? node?.Objections),
          ctas:       toArr(node?.ctas       ?? node?.CTAs  ?? node?.callsToAction ?? node?.CallsToAction)
        };

        const allEmpty = Object.values(sections).every(a => a.length === 0);
        if (allEmpty){ fillAll(['No data available for this selection.']); return; }

        setSlot('intel-priorities', sections.priorities);
        setSlot('intel-pains',      sections.pains);
        setSlot('intel-triggers',   sections.triggers);
        setSlot('intel-proof',      sections.proof);
        setSlot('intel-objections', sections.objections);
        setSlot('intel-ctas',       sections.ctas);
      }

      // ---------- Activity / delta ----------
      function addActivity(entry) {
        const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]');
        list.unshift(entry);
        localStorage.setItem(ACTIVITY_KEY, JSON.stringify(list.slice(0,3)));
        renderActivity();
      }
      function renderActivity() {
        const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]');
        if (!activityLog) return;
        activityLog.innerHTML = '';
        list.forEach(item => {
          const node = activityTpl.content.cloneNode(true);
          node.querySelector('.time').textContent = item.time;
          node.querySelector('.product').textContent = item.product;
          node.querySelector('.buyer').textContent = item.buyer_behaviour || item.buyer || '';
          node.querySelector('.length').textContent = item.length || '';
          activityLog.appendChild(node);
        });
      }
      function computeDelta(oldText, newText) {
        const oldLines = (oldText||'').split('\n'), newLines = (newText||'').split('\n');
        let added = 0, removed = 0;
        const oldSet = new Set(oldLines), newSet = new Set(newLines);
        newLines.forEach(l => { if (!oldSet.has(l) && l.trim()) added++; });
        oldLines.forEach(l => { if (!newSet.has(l) && l.trim()) removed++; });
        return { added, removed };
      }
      function renderDelta(delta) {
        if (!deltaLog) return;
        deltaLog.innerHTML = '';
        const a = document.createElement('li'); a.textContent = `+${delta.added} new line${delta.added===1?'':'s'}`;
        const r = document.createElement('li'); r.textContent = `−${delta.removed} removed line${delta.removed===1?'':'s'}`;
        deltaLog.appendChild(a); deltaLog.appendChild(r);
      }

      // ---------- Header chip (remembered call type) ----------
      function loadCallPref() {
        try {
          const pref = JSON.parse(localStorage.getItem(CALL_PREF_KEY) || 'null');
          if (pref?.call_type && callTypeSel && !callTypeSel.value) callTypeSel.value = pref.call_type;
          if (pref?.remember === true && rememberCallType) rememberCallType.checked = true;
        } catch {}
        updateMapIndicator();
      }
      function saveCallPrefIfRequested() {
        if (rememberCallType && rememberCallType.checked && callTypeSel && callTypeSel.value) {
          localStorage.setItem(CALL_PREF_KEY, JSON.stringify({ remember: true, call_type: callTypeSel.value }));
        } else if (rememberCallType && !rememberCallType.checked) {
          localStorage.removeItem(CALL_PREF_KEY);
        }
        updateMapIndicator();
      }
      function updateMapIndicator() {
        const pref = JSON.parse(localStorage.getItem(CALL_PREF_KEY) || 'null');
        if (mapLabel) mapLabel.textContent = pref?.call_type || (callTypeSel?.value || 'Not set');
      }

      // ---------- Tips toggle ----------
      function applyTipsVisibility() {
        const hidden = localStorage.getItem(TIPS_HIDDEN_KEY) === '1';
        tipsList.hidden = hidden;
        toggleTipsBtn.setAttribute('aria-expanded', String(!hidden));
        toggleTipsBtn.textContent = hidden ? 'Show tips' : 'Hide tips';
      }

      // ---------- Notes helpers ----------
      const notesKey = () => {
        const pn = (form?.elements?.prospect_name?.value || '').trim().toLowerCase();
        const pc = (form?.elements?.prospect_company?.value || '').trim().toLowerCase();
        return `${NOTES_KEY_PREFIX}::${pc}::${pn}` || NOTES_KEY_PREFIX;
      };
      function loadNotes(){ try{ notesArea.value = localStorage.getItem(notesKey()) || ''; }catch{} }
      function saveNotes(){ try{ localStorage.setItem(notesKey(), notesArea.value || ''); setStatus('Notes saved.'); }catch(e){ setStatus('Could not save notes.', 'error'); } }
      function downloadText(filename, text){
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // ---------- Events ----------
      on(callTypeSel, ['change','input','blur'], () => {
        validateField(callTypeSel); saveForm(); updateMapIndicator(); refreshSubmitState();
      });
      on(rememberCallType, ['change','input','blur'], () => {
        saveCallPrefIfRequested(); refreshSubmitState();
      });
      on(toggleTipsBtn, ['click'], () => {
        const hidden = !(toggleTipsBtn.getAttribute('aria-expanded') === 'true');
        localStorage.setItem(TIPS_HIDDEN_KEY, hidden ? '0':'1'); // will be flipped in apply
        applyTipsVisibility();
      });
      on(saveNotesBtn, ['click'], saveNotes);
      on(downloadNotesBtn, ['click'], () => {
        const who = (form?.elements?.prospect_name?.value || 'prospect').trim().replace(/\s+/g,'-');
        downloadText(`call-notes_${who}_${new Date().toISOString().slice(0,10)}.txt`, notesArea.value || '');
      });

      on(form, ['input','change','blur'], (e) => {
        if (e.target.matches('input,select,textarea')) {
          validateField(e.target); saveForm(); refreshSubmitState();
        }
        if (e.type==='change' && (e.target === productSel || e.target === buyerBehSel)) {
          const label = productSel?.options?.[productSel.selectedIndex]?.text ?? productSel?.value ?? '';
          renderIntel(label, buyerBehSel?.value || '');
        }
        if (e.target === form?.elements?.prospect_name || e.target === form?.elements?.prospect_company) {
          loadNotes(); // switch notes bucket when identity fields change
        }
      }, true);

      toggleIntelBtn && toggleIntelBtn.addEventListener('click', () => {
        const expanded = toggleIntelBtn.getAttribute('aria-expanded') === 'true';
        toggleIntelBtn.setAttribute('aria-expanded', String(!expanded));
        if (intelBody) intelBody.hidden = expanded;
        toggleIntelBtn.textContent = expanded ? 'Show' : 'Hide';
      });

      resetBtn && resetBtn.addEventListener('click', () => {
        if (!form) return;
        form.reset(); clearFormState(); loadCallPref();
        const label = productSel?.options?.[productSel.selectedIndex]?.text ?? productSel?.value ?? '';
        renderIntel(label, buyerBehSel?.value || '');
        renderActivity(); refreshSubmitState(); setStatus('Form reset. Stored values cleared.');
        form.querySelector('input, select, textarea')?.focus();
        loadNotes();
      });

      copyBtn && copyBtn.addEventListener('click', async () => {
        const txt = outputEl?.textContent || ''; if (!txt.trim()) return;
        await navigator.clipboard.writeText(txt);
        setStatus('Copied to clipboard.');
      });

      downloadBtn && downloadBtn.addEventListener('click', () => {
        const txt = outputEl?.textContent || ''; if (!txt.trim()) return;
        const blob = new Blob([txt], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `first-call-script_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        setStatus('Download started.');
      });

      popoutBtn && popoutBtn.addEventListener('click', () => {
        const txt = (outputEl?.textContent || '').trim();
        const meta = (outputMeta?.textContent || '').trim();
        const w = window.open('', '_blank', 'noopener,noreferrer');
        if (!w) return;
        w.document.write(`<!doctype html><meta charset="utf-8"><title>Script</title>
          <style>
            body{font:16.5px/1.7 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;padding:24px;background:#fff;color:#111}
            .meta{color:#6b7280;font-size:.9rem;margin-bottom:12px}
            pre{white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:12px;padding:20px}
            .bar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-bottom:8px}
            button{padding:.4rem .6rem;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;cursor:pointer}
          </style>
          <div class="bar"><button onclick="window.print()">Print</button><button onclick="navigator.clipboard.writeText(document.querySelector('pre').textContent)">Copy</button></div>
          <div class="meta">${meta}</div>
          <pre>${txt.replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre>`);
        w.document.close();
      });

      // ---------- Submit ----------
      form && form.addEventListener('submit', async (e) => {
        e.preventDefault();

        for (const name of REQUIRED){
          const el = form.elements[name] || document.getElementById(name);
          if (!el || !String(el.value||'').trim()){
            validateField(el); el?.focus(); setStatus('Please complete required fields.', 'error'); return;
          }
        }

        const fd = Object.fromEntries(new FormData(form).entries());
        const variables = {
          seller_name: fd.seller_name || '',
          seller_company: fd.seller_company || '',
          prospect_name: fd.prospect_name || '',
          prospect_role: fd.prospect_role || '',
          prospect_company: fd.prospect_company || '',
          call_type: fd.call_type || '',
          buyer_type: fd.buyer_behaviour || '',
          product: fd.product || '',
          tone: fd.tone || '',
          length: fd.length || '',
          value_proposition: fd.value_proposition || '',
          context: fd.context || '',
          next_step: fd.next_step || ''
        };

        setBusy(true); setStatus('Generating call script…'); diag && (diag.open = false); diagJson && (diagJson.textContent = '');

        const lookup = {
          product: variables.product,
          buyerType: canonical.buyer(variables.buyer_type),
          mode: canonical.mode(variables.call_type)
        };

        const lengthHint = /\d+/.exec(variables.length || "")?.[0] || "300";

        try {
          const result = await generatePromptBasedCallScript({
            input: variables,
            tone: variables.tone,
            lengthHint: Number(lengthHint),
            lookup
          });

          const text = (result.script || '').trim();
          outputEl.textContent = text;
          outputMeta.textContent = result.meta || `Library · ${lookup.product || '—'} · ${variables.buyer_type || '—'} · ${variables.call_type || '—'}`;

          // Helpful tips (exactly 3 from engine)
          if (tipsList) {
            tipsList.innerHTML = '';
            (result.tips || []).forEach(t => {
              const li = document.createElement('li');
              li.textContent = t;
              tipsList.appendChild(li);
            });
          }

          const delta = computeDelta(lastOutput, outputEl.textContent);
          renderDelta(delta);
          lastOutput = outputEl.textContent; localStorage.setItem(OUTPUT_KEY, lastOutput);

          addActivity({ time: nowTime(), product: variables.product || '—', buyer_behaviour: variables.buyer_type || '—', length: variables.length || '—' });

          setStatus('Done. (Generated from curated Library)');
          setBusy(false);
          document.getElementById('output-title')?.focus();
        } catch (err) {
          setStatus('Could not generate a call script. Please check content paths.', 'error');
          if (diag) { diag.open = true; diagJson.textContent = String(err); }
          setBusy(false);
        }
      });

      // ---------- Init ----------
      (async function init(){
        // Buyer needs preload (fallback)
        try {
          const res = await fetch(INTEL_URL, { cache: 'no-store' });
          const raw = await res.json();
          intel = normaliseIntel(raw);
        } catch { intel = { products:{} }; }

        // Populate Product from index (safe populate)
        try {
          const idx = await getIndex();                      // reads ./content/call-library/v1/index.json
          const items = Array.isArray(idx?.products) ? idx.products : [];
          if (productSel) {
            productSel.innerHTML = '<option value="">Select…</option>';
            for (const { id, label } of items) {
              const opt = document.createElement('option');
              opt.value = id; opt.textContent = label || id;
              productSel.appendChild(opt);
            }
          }
        } catch (e) {
          console.error('[Product] Failed to load index.json', e);
          if (productSel) productSel.innerHTML = '<option value="">Select…</option>';
        }

        loadForm();
        loadNotes();
        loadCallPref();
        applyTipsVisibility();

        // First render of Buyer needs if selections exist
        if (productSel?.value && buyerBehSel?.value) {
          const label = productSel?.options?.[productSel.selectedIndex]?.text ?? productSel?.value ?? '';
          renderIntel(label, buyerBehSel.value);
        }

        refreshSubmitState();
      })();
    })();
  </script>

</body>
</html>

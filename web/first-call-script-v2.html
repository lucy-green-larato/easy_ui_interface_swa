<!doctype html>
<html lang="en" data-app="inside-track-tools">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inside Track Tools · First Call Script (v2)</title>
  <link rel="stylesheet" href="./styles.css?v=lookfix-plainpanels" />
  <style>
    /* Page-scoped CSS only */
    :root{
      --bg:#f7f7f9; --surface-1:#fff; --surface-2:#eef0f4; --surface-3:#e5e8ee;
      --text-1:#1d2129; --text-2:#5b6270; --accent:#2458e6; --accent-pressed:#1f49be;
      --danger:#b00020; --ok:#0a7f2e; --ring:2px solid rgba(36,88,230,.35);
      --shadow:0 1px 2px rgba(0,0,0,.06), 0 6px 24px rgba(0,0,0,.06);
      --radius:10px; --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:24px; --space-6:32px;
      --font-system:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text-1);font:16px/1.45 var(--font-system)}

    /* Header */
    .app-header{display:flex;align-items:center;justify-content:space-between;gap:var(--space-3);padding:var(--space-3) var(--space-5)}
    .header-left{display:flex;align-items:center;gap:.75rem;min-width:0;flex:1 1 auto}
    .logo{width:clamp(44px,5vw,52px);height:auto;object-fit:contain;flex-shrink:0}
    .brand-text{display:flex;flex-direction:column}
    .app-title{font-weight:600;margin:.25rem 0 0}
    .kicker{font-size:.875rem;color:var(--text-2);margin-top:.125rem}
    .header-right{display:flex;align-items:center;gap:.75rem;flex:0 0 auto}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--surface-3);background:var(--surface-1);cursor:pointer;font-weight:600}
    .btn.small{padding:6px 10px;font-size:.9rem}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.primary:hover{background:var(--accent-pressed)}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.5);border-top-color:#fff;display:none}
    .btn.primary.busy .spinner{display:inline-block;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* “Direct or partner sales” – same look as other controls */
    .calltype-mini{
      display:flex;align-items:center;gap:.6rem;
      padding:6px 10px;border-radius:999px;
      background:var(--surface-1); border:1px solid var(--surface-3);
      font-size:.95rem; white-space:nowrap;
    }
    .calltype-mini .mini-label{font-weight:600}
    .calltype-mini select{padding:6px 10px;border-radius:8px;border:1px solid var(--surface-3);background:#fff}
    .calltype-mini .remember{display:flex;align-items:center;gap:.35rem;color:var(--text-2)}
    .error-inline{color:var(--danger);font-size:.85rem}

    .model-note{display:inline-flex;align-items:center;gap:.35rem;padding:6px 10px;background:var(--surface-2);border:1px solid var(--surface-3);border-radius:999px;font-size:.9rem;color:var(--text-2)}
    .badge{display:flex;align-items:center;gap:.4rem;padding:8px 12px;background:var(--surface-2);border:1px solid var(--surface-3);border-radius:999px;font-size:.9rem;color:var(--text-1);white-space:nowrap}
    .badge svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2}
    .badge.is-hidden{display:none}

    /* LAYOUT — use full screen width, no outer “cards” on the three big sections */
    .layout{
      display:grid;
      grid-template-columns: minmax(340px,1fr) minmax(420px,1.2fr) minmax(340px,1fr); /* middle a touch wider */
      gap: var(--space-6);
      padding: var(--space-5);
      align-items:start;
      width:100%;
      max-width:100vw; /* fill footprint */
      box-sizing:border-box;
    }
    @media (max-width: 1200px){ .layout{ grid-template-columns: 1fr; } }

    .panel{display:block}

    /* Default “card” (kept for other parts of the page) */
    .card{background:var(--surface-1);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--space-5);margin:0;border:1px solid #e9ebf0}

    /* CHANGED: Plain panels = no background, no border, no shadow (for the 3 big areas) */
    .panel-plain{background:transparent;border:0;box-shadow:none;padding:0;margin:0}

    fieldset{border:0;margin:0 0 var(--space-5);padding:0}
    legend{font-weight:600;margin-bottom:var(--space-3);font-size:1.125rem}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-4)}
    @media (max-width: 800px){ .grid-2{grid-template-columns:1fr} }

    label{display:block;margin-bottom:6px;font-weight:600}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--surface-3);background:#fff;
      outline:none;transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus,select:focus,textarea:focus{ box-shadow: var(--ring); border-color: var(--accent); }
    .help{margin:.25rem 0 0;color:var(--text-2);font-size:.9rem}
    .error{min-height:1.25rem;color:var(--danger);font-size:.9rem;margin:.25rem 0 0}

    .actions{display:flex;gap:var(--space-3);align-items:center;margin-top:var(--space-4);flex-wrap:wrap}
    .status{margin-top:var(--space-3);min-height:1.35rem;color:var(--text-2)}
    .status[data-kind="error"]{color:var(--danger)}
    .status[data-kind="ok"]{color:var(--ok)}

    /* Script output keeps a subtle single border for readability */
    .output{white-space:pre-wrap;background:#f6f7fb;color:#1f2937;border:1px solid #e5e7eb;padding:var(--space-4);border-radius:8px;min-height:180px;outline:none}

    /* Buyer needs as ONE column, with light chips and NO extra box around the whole panel */
    .intel-grid{display:grid;grid-template-columns:1fr;gap:var(--space-3)}
    .intel .intel-slot{background:var(--surface-2);padding:var(--space-3);border-radius:8px;border:0}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="app-header" role="banner">
    <div class="header-left">
      <img class="logo" src="./larato-logo.svg" alt="Larato" />
      <div class="brand-text">
        <h1 class="app-title">Inside Track Tools</h1>
        <p class="kicker">First Call Script · v2</p>
      </div>
    </div>

    <div class="header-right">
      <div class="calltype-mini" role="group" aria-labelledby="sales-model-label">
        <span id="sales-model-label" class="mini-label">Direct or partner sales</span>
        <select id="call_type" name="call_type" form="script-form" required aria-describedby="call_type_error">
          <option value="">Select…</option>
          <option>Direct</option>
          <option>Partner</option>
        </select>
        <label class="remember">
          <input type="checkbox" id="remember_call_type" form="script-form" />
          Remember
        </label>
        <span id="call_type_error" class="error-inline" role="alert" aria-live="polite"></span>
      </div>

      <span class="model-note">
        <span class="label">Sales model in use:</span>
        <strong id="map-label">Not set</strong>
      </span>

      <span id="user-badge" class="badge is-hidden" aria-live="polite" aria-atomic="true">
        <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="7" r="4"></circle><path d="M4 22c0-4 4-7 8-7s8 3 8 7"></path></svg>
        <span>Loading user…</span>
      </span>
    </div>
  </header>

  <!-- LAYOUT: Form | Script | Buyer needs -->
  <main id="main" class="layout" role="main">
    <!-- LEFT: form (“Call details” is now plain, no box) -->
    <section class="panel left" aria-label="Form">
      <form id="script-form" novalidate>
        <!-- CHANGED: remove card background behind Call details -->
        <fieldset class="panel-plain" aria-labelledby="legend-call-details">
          <legend id="legend-call-details">Call details</legend>
          <div class="grid-2">
            <div class="field">
              <label for="seller_name">Your name <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_name" name="seller_name" required autocomplete="name" />
              <p class="help">Shown in the opening line.</p>
              <p class="error" id="seller_name_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="seller_company">Your company <span aria-hidden="true" class="req">*</span></label>
              <input id="seller_company" name="seller_company" required autocomplete="organization" />
              <p class="help">Organisation you represent.</p>
              <p class="error" id="seller_company_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="prospect_name">Prospect name <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_name" name="prospect_name" required />
              <p class="error" id="prospect_name_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="prospect_role">Prospect role <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_role" name="prospect_role" required placeholder="e.g., Finance Director" />
              <p class="error" id="prospect_role_error" role="alert" aria-live="polite"></p>
            </div>
            <div class="field">
              <label for="prospect_company">Prospect company <span aria-hidden="true" class="req">*</span></label>
              <input id="prospect_company" name="prospect_company" required />
              <p class="error" id="prospect_company_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <!-- Keep cards for the other two sections so the form remains structured -->
        <fieldset class="card" aria-labelledby="legend-targeting">
          <legend id="legend-targeting">Targeting</legend>
          <div class="grid-2">
            <div class="field">
              <label for="product">Product <span aria-hidden="true" class="req">*</span></label>
              <select id="product" name="product" required>
                <option value="">Loading…</option>
              </select>
              <p class="help">One of the Inside Track product categories.</p>
              <p class="error" id="product_error" role="alert" aria-live="polite"></p>
            </div>

            <div class="field">
              <label for="buyer_behaviour">Buyer behaviour <span aria-hidden="true" class="req">*</span></label>
              <select id="buyer_behaviour" name="buyer_behaviour" required>
                <option value="">Select…</option>
                <option>Innovator</option>
                <option>Early adopter</option>
                <option>Early majority</option>
                <option>Late majority</option>
                <option>Sceptic</option>
              </select>
              <p class="help">Adoption profile from the Inside Track company record.</p>
              <p class="error" id="buyer_behaviour_error" role="alert" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="card" aria-labelledby="legend-preferences">
          <legend id="legend-preferences">Script preferences</legend>
          <div class="grid-2">
            <div class="field">
              <label for="tone">Tone</label>
              <select id="tone" name="tone">
                <option value="">(No preference)</option>
                <option>Professional (corporate)</option>
                <option>Warm (relaxed)</option>
              </select>
              <p class="help">Optional style guidance.</p>
            </div>

            <div class="field">
              <label for="length">Length</label>
              <select id="length" name="length">
                <option>~50 words (≈30–45 sec)</option>
                <option selected>~100 words (≈1 min)</option>
                <option>~150 words (≈1.5–2 min)</option>
              </select>
              <p class="help">Approximate spoken duration is shown.</p>
            </div>
          </div>

          <div class="field">
            <label for="value_proposition">Unique Selling Points (optional)</label>
            <textarea id="value_proposition" name="value_proposition" rows="2" placeholder="Your USPs. Leave blank if you prefer the model to infer."></textarea>
          </div>

          <div class="field">
            <label for="context">Other points to cover in the call (optional)</label>
            <textarea id="context" name="context" rows="3" placeholder="Any additional talking points. Optional."></textarea>
          </div>
        </fieldset>

        <div class="actions">
          <button id="submit" class="btn primary" type="submit" disabled>
            <span class="btn-label">Generate script</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
          <button id="reset" class="btn" type="button">Reset</button>
          <button id="copy" class="btn" type="button" disabled>Copy</button>
          <button id="download" class="btn" type="button" disabled>Download .txt</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <details id="diagnostics" class="card" style="margin-top:var(--space-5)">
          <summary>Diagnostics</summary>
          <pre id="diag-json" tabindex="0" aria-label="Diagnostics JSON"></pre>
          <p class="muted">If you see a 401 unauthorised error, please <a href="/.auth/login/aad">sign in again</a>.</p>
        </details>
      </form>
    </section>

    <!-- MIDDLE: Generated Script (plain, no outer card) -->
    <section class="panel middle">
      <div class="output-card panel-plain"> <!-- CHANGED -->
        <div style="display:flex;align-items:baseline;justify-content:space-between;gap:var(--space-3);margin-bottom:var(--space-3)">
          <h2 id="output-title">Generated Script</h2>
          <div class="meta" id="output-meta" aria-live="polite" style="color:var(--text-2);font-size:.9rem"></div>
        </div>
        <pre id="output" class="output" tabindex="0" aria-label="Generated script will appear here"></pre>
        <div class="change-log" style="margin-top:var(--space-4)">
          <h3>What changed</h3>
          <ul id="delta-log" class="delta" aria-live="polite"></ul>
        </div>
        <div class="activity" style="margin-top:var(--space-4)">
          <h3>Recent activity</h3>
          <ol id="activity-log" class="activity-log" aria-live="polite" style="margin:0;padding-left:1.25rem"></ol>
        </div>
      </div>
    </section>

    <!-- RIGHT: Buyer needs (plain, no outer card; content still gets subtle chips) -->
    <section class="panel right" aria-labelledby="intel-title">
      <aside class="intel panel-plain"> <!-- CHANGED -->
        <div style="display:flex;align-items:center;justify-content:space-between;gap:var(--space-3);margin-bottom:var(--space-3)">
          <h2 id="intel-title">Buyer needs</h2>
          <button id="toggle-intel" class="btn small" type="button" aria-expanded="true" aria-controls="intel-body">Hide</button>
        </div>
        <div id="intel-body">
          <div class="intel-grid">
            <section>
              <h3>1) Buyer Priorities</h3>
              <div id="intel-priorities" class="intel-slot"></div>
            </section>
            <section>
              <h3>2) Typical Pains</h3>
              <div id="intel-pains" class="intel-slot"></div>
            </section>
            <section>
              <h3>3) Triggers</h3>
              <div id="intel-triggers" class="intel-slot"></div>
            </section>
            <section>
              <h3>4) Value Proof</h3>
              <div id="intel-proof" class="intel-slot"></div>
            </section>
            <section>
              <h3>5) Objections</h3>
              <div id="intel-objections" class="intel-slot"></div>
            </section>
            <section>
              <h3>6) CTAs</h3>
              <div id="intel-ctas" class="intel-slot"></div>
            </section>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <template id="activity-item">
    <li>
      <span class="time"></span>
      <span class="pill product"></span>
      <span class="pill buyer"></span>
      <span class="pill length"></span>
    </li>
  </template>

  <script>
    (function () {
      /* Everything below is unchanged logic-wise. Keeping it short: only the look changed. */
      const FORM_ID = 'script-form';
      const STORAGE_KEY = 'first_call_script_v2.form';
      const ACTIVITY_KEY = 'first_call_script_v2.activity';
      const OUTPUT_KEY = 'first_call_script_v2.last_output';
      const CALL_PREF_KEY = 'first_call_script_v2.call_pref';
      const INTEL_URL = './intel.json';
      const REQUIRED = ['call_type','seller_name','seller_company','prospect_name','prospect_role','prospect_company','buyer_behaviour','product'];

      const form = document.getElementById(FORM_ID);
      const submitBtn = document.getElementById('submit');
      const resetBtn = document.getElementById('reset');
      const copyBtn = document.getElementById('copy');
      const downloadBtn = document.getElementById('download');
      const outputEl = document.getElementById('output');
      const outputMeta = document.getElementById('output-meta');
      const statusEl = document.getElementById('status');
      const deltaLog = document.getElementById('delta-log');
      const activityLog = document.getElementById('activity-log');
      const activityTpl = document.getElementById('activity-item');
      const diag = document.getElementById('diagnostics');
      const diagJson = document.getElementById('diag-json');
      const productSel = document.getElementById('product');
      const buyerBehSel = document.getElementById('buyer_behaviour');
      const toggleIntelBtn = document.getElementById('toggle-intel');
      const intelBody = document.getElementById('intel-body');
      const callTypeSel = document.getElementById('call_type');
      const rememberCallType = document.getElementById('remember_call_type');
      const mapLabel = document.getElementById('map-label');

      const nowTime = () => new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      // Deterministic validation: handles header select + restored values
      function allRequiredFilled(formEl) {
        const missing = [];
        const map = {
          call_type:'Direct or partner sales', seller_name:'Your name', seller_company:'Your company',
          prospect_name:'Prospect name', prospect_role:'Prospect role', prospect_company:'Prospect company',
          buyer_behaviour:'Buyer behaviour', product:'Product'
        };
        for (const name of REQUIRED) {
          const el = formEl.elements[name] || document.getElementById(name); // covers header select (form-associated)
          const val = (el && typeof el.value === 'string') ? el.value.trim() : '';
          if (!val) missing.push(map[name] || name);
        }
        statusEl.textContent = missing.length ? `Please complete: ${missing.join(', ')}.` : '';
        statusEl.dataset.kind = missing.length ? 'error' : 'info';
        return missing.length === 0;
      }
      function refreshSubmitState(){ submitBtn.disabled = !allRequiredFilled(form); }

      function setBusy(isBusy) {
        submitBtn.disabled = isBusy || !form.checkValidity();
        resetBtn.disabled = isBusy;
        const hasText = !!outputEl.textContent.trim();
        copyBtn.disabled = isBusy || !hasText;
        downloadBtn.disabled = isBusy || !hasText;
        submitBtn.classList.toggle('busy', isBusy);
      }
      function setStatus(msg, kind='info') { statusEl.textContent = msg; statusEl.dataset.kind = kind; }
      function validateField(input) {
        if (input.id === 'call_type') {
          const errEl = document.getElementById('call_type_error');
          if (input.validity.valid) { errEl.textContent = ''; input.classList.remove('invalid'); }
          else { errEl.textContent = 'Please choose a call type.'; input.classList.add('invalid'); }
          return;
        }
        const errorEl = document.getElementById(`${input.id}_error`);
        if (!errorEl) return;
        if (input.validity.valid) { errorEl.textContent = ''; input.classList.remove('invalid'); }
        else {
          input.classList.add('invalid');
          errorEl.textContent = input.validity.valueMissing ? 'This field is required.' : 'Please check this value.';
        }
      }
      function saveForm() {
        const data = Object.fromEntries(new FormData(form).entries());
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }
      function loadForm() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try { const data = JSON.parse(raw); Object.entries(data).forEach(([k,v]) => { const el = form.querySelector(`[name="${k}"]`); if (el) el.value = v; }); } catch {}
      }
      function refreshSubmitState(){ submitBtn.disabled = !form.checkValidity(); }

      ['input','change'].forEach(evt => {
        form.addEventListener(evt, (e) => {
          if (e.target.matches('input,select,textarea')) {
            validateField(e.target); saveForm(); refreshSubmitState();
          }
          if (e.target === productSel || e.target === buyerBehSel) {
            renderIntel(productSel.value, buyerBehSel.value);
          }
          if (e.target === callTypeSel || e.target === rememberCallType) saveCallPrefIfRequested();
        });
      });

      toggleIntelBtn.addEventListener('click', () => {
        const expanded = toggleIntelBtn.getAttribute('aria-expanded') === 'true';
        toggleIntelBtn.setAttribute('aria-expanded', String(!expanded));
        intelBody.hidden = expanded;
        toggleIntelBtn.textContent = expanded ? 'Show' : 'Hide';
      });

      document.getElementById('reset').addEventListener('click', () => {
        form.reset(); localStorage.removeItem(STORAGE_KEY);
        setStatus('Form reset.'); renderIntel(productSel.value, buyerBehSel.value);
        refreshSubmitState(); form.querySelector('input, select, textarea')?.focus();
      });

      document.getElementById('copy').addEventListener('click', async () => {
        const txt = outputEl.textContent; if (!txt.trim()) return;
        await navigator.clipboard.writeText(txt);
        setStatus('Copied to clipboard.');
      });
      document.getElementById('download').addEventListener('click', () => {
        const txt = outputEl.textContent; if (!txt.trim()) return;
        const blob = new Blob([txt], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `first-call-script_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        setStatus('Download started.');
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        let firstInvalid = null;
        [...form.elements].forEach(el => {
          if (el.matches('input,select,textarea')) {
            validateField(el);
            if (!firstInvalid && !el.checkValidity()) firstInvalid = el;
          }
        });
        if (firstInvalid) { setStatus('Please fix the highlighted fields.', 'error'); firstInvalid.focus(); return; }

        const fd = Object.fromEntries(new FormData(form).entries());
        const variables = {
          seller_name: fd.seller_name || '',
          seller_company: fd.seller_company || '',
          prospect_name: fd.prospect_name || '',
          prospect_role: fd.prospect_role || '',
          prospect_company: fd.prospect_company || '',
          call_type: fd.call_type || '',
          buyer_type: fd.buyer_behaviour || '',
          product: fd.product || '',
          tone: fd.tone || '',
          length: fd.length || '',
          call_to_action: fd.call_to_action || '',
          context: fd.context || '',
          value_proposition: fd.value_proposition || ''
        };
        const payload = { pack: 'uk_b2b_sales_core', template: 'first_call_script_v2', variables };

        setBusy(true); setStatus('Generating…'); diag.open = false; diagJson.textContent = '';

        try {
          const res = await fetch('/api/generate', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload), credentials: 'include'
          });
          const text = await res.text();
          let data = {}; try { data = JSON.parse(text); } catch {}

          if (!res.ok) {
            setStatus(`Error ${res.status}. See diagnostics.`, 'error');
            diag.open = true; diagJson.textContent = JSON.stringify({ status: res.status, body: data || text }, null, 2);
            return;
          }

          const out = (data.output || data.preview || '').trim();
          outputEl.textContent = out || '(No output returned.)';
          outputMeta.textContent = `Generated ${nowTime()}`;
          copyBtn.disabled = !out; downloadBtn.disabled = !out;

          const delta = computeDelta(localStorage.getItem(OUTPUT_KEY)||'', out);
          renderDelta(delta);
          localStorage.setItem(OUTPUT_KEY, out);

          addActivity({ time: nowTime(), product: variables.product || '—', buyer_behaviour: variables.buyer_type || '—', length: variables.length || '—' });

          renderIntel(productSel.value, buyerBehSel.value);
          if (out) injectRemindersFromScript(out);

          setStatus('Done. Script ready.');
          document.getElementById('output-title').focus();

        } catch (err) {
          setStatus('Network error. Please try again.', 'error');
          diag.open = true; diagJson.textContent = String(err);
        } finally {
          setBusy(false);
        }
      });

      /* ---- helpers kept concise (unchanged from prior version) ---- */
      function addActivity(entry){
        const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]'); list.unshift(entry);
        localStorage.setItem(ACTIVITY_KEY, JSON.stringify(list.slice(0,3))); renderActivity();
      }
      function renderActivity(){
        const list = JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]'); activityLog.innerHTML='';
        list.forEach(item => {
          const node = activityTpl.content.cloneNode(true);
          node.querySelector('.time').textContent = item.time;
          node.querySelector('.product').textContent = item.product;
          node.querySelector('.buyer').textContent = item.buyer_behaviour;
          node.querySelector('.length').textContent = item.length;
          activityLog.appendChild(node);
        });
      }
      function computeDelta(a,b){const A=(a||'').split('\n'),B=(b||'').split('\n');let add=0,rem=0;const SA=new Set(A),SB=new Set(B);B.forEach(l=>{if(!SA.has(l)&&l.trim())add++});A.forEach(l=>{if(!SB.has(l)&&l.trim())rem++});return{added:add,removed:rem}}
      function renderDelta(d){deltaLog.innerHTML='';const x=document.createElement('li');x.textContent=`+${d.added} new line${d.added===1?'':'s'}`;const y=document.createElement('li');y.textContent=`−${d.removed} removed line${d.removed===1?'':'s'}`;deltaLog.appendChild(x);deltaLog.appendChild(y);}

      /* Intel + reminders (same behaviour as before) */
      const norm = s => String(s || '').toLowerCase().replace(/\s+/g,' ').replace(/[\u2010-\u2015_\-\/]+/g,'-').trim();
      const BEHAVIOUR_SYNONYMS = { 'early adopter':'early-adopter','early majority':'early-majority','late majority':'late-majority','skeptic':'sceptic','sceptic':'sceptic' };
      function getKeyInsensitive(obj, requested){
        if (!obj || typeof obj !== 'object') return null;
        const want = norm(requested);
        for (const k of Object.keys(obj)) if (norm(k) === want) return k;
        for (const k of Object.keys(obj)) if (norm(k).includes(want)) return k;
        return null;
      }
      const toArr = v => Array.isArray(v) ? v.filter(Boolean).map(String) : (v ? [String(v)] : []);
      const pEl = t => { const el=document.createElement('p'); el.textContent=t; return el; };
      const setSlot = (id, arr=[]) => { const slot=document.getElementById(id); const items=(arr.length?arr:['No data for this behaviour. Available: IT Director, CFO']); slot.replaceChildren(...items.map(pEl)); };
      const fillAll = arr => { setSlot('intel-priorities', arr); setSlot('intel-pains', arr); setSlot('intel-triggers', arr); setSlot('intel-proof', arr); setSlot('intel-objections', arr); setSlot('intel-ctas', arr); };

      function renderIntel(productLabel, behaviourLabel){
        if (!window._intel) return;
        const products = window._intel.products || {};
        const productKey = getKeyInsensitive(products, productLabel);
        const productNode = productKey ? products[productKey] : null;
        if (!productNode){ fillAll([`No data available (unknown product).`]); return; }

        let node = null;
        if (productNode.behaviours){
          let key = getKeyInsensitive(productNode.behaviours, behaviourLabel);
          if (!key){ const syn = BEHAVIOUR_SYNONYMS[norm(behaviourLabel)]; if (syn) key = getKeyInsensitive(productNode.behaviours, syn); }
          if (key) node = productNode.behaviours[key];
        }
        if (!node && productNode.buyers){
          let key = getKeyInsensitive(productNode.buyers, behaviourLabel);
          if (!key){ const syn = BEHAVIOUR_SYNONYMS[norm(behaviourLabel)]; if (syn) key = getKeyInsensitive(productNode.buyers, syn); }
          if (key) node = productNode.buyers[key];
        }
        if (!node && productNode.needs) node = productNode.needs;

        if (!node){
          const behavioursList = [...Object.keys(productNode.behaviours || {}), ...Object.keys(productNode.buyers || {})].join(', ') || '—';
          fillAll([`No data for this behaviour. Available: ${behavioursList}`]);
          return;
        }

        const sections = {
          priorities: toArr(node?.priorities ?? node?.Priorities),
          pains:      toArr(node?.pains      ?? node?.Pains),
          triggers:   toArr(node?.triggers   ?? node?.Triggers),
          proof:      toArr(node?.proof      ?? node?.Proof ?? node?.value ?? node?.Value),
          objections: toArr(node?.objections ?? node?.Objections),
          ctas:       toArr(node?.ctas       ?? node?.CTAs  ?? node?.callsToAction ?? node?.CallsToAction)
        };

        const allEmpty = Object.values(sections).every(a => a.length === 0);
        if (allEmpty){ fillAll(['No data available for this selection.']); return; }

        setSlot('intel-priorities', sections.priorities);
        setSlot('intel-pains',      sections.pains);
        setSlot('intel-triggers',   sections.triggers);
        setSlot('intel-proof',      sections.proof);
        setSlot('intel-objections', sections.objections);
        setSlot('intel-ctas',       sections.ctas);
      }

      function extractKeyPoints(text){
        const sentences = String(text).split(/(?<=[.!?])\s+/).map(s=>s.trim()).filter(Boolean);
        const keywords = /(reduce|save|cut|improv|increase|risk|cost|time|secure|resilien|revenue|margin|efficien|customer|cx|compliance|ml|ai|automate|protect)/i;
        const scored = sentences.map(s => { let sc=0; sc += (s.match(/[,;:]/g)||[]).length; if (keywords.test(s)) sc+=3; if (s.length>=60 && s.length<=180) sc+=2; if (/we|you|your|let's/i.test(s)) sc+=1; return { s, sc }; })
                                .sort((a,b)=>b.sc-a.sc);
        return (scored.length?scored:sentences).slice(0,3).map(o=>o.s);
      }
      function injectRemindersFromScript(text){
        const points = extractKeyPoints(text);
        if (!points.length) return;
        setSlot('intel-priorities', ['From your script:', points[0] || '']);
        setSlot('intel-pains',      ['Reminder:', points[1] || '']);
        setSlot('intel-triggers',   ['Keep in mind:', points[2] || '']);
      }

      // Prefs & badge
      function updateMapIndicator() {
        const pref = JSON.parse(localStorage.getItem('first_call_script_v2.call_pref') || 'null');
        mapLabel.textContent = pref?.call_type || (callTypeSel.value || 'Not set');
      }
      function saveCallPrefIfRequested() {
        if (rememberCallType.checked && callTypeSel.value) {
          localStorage.setItem('first_call_script_v2.call_pref', JSON.stringify({ remember: true, call_type: callTypeSel.value }));
        } else if (!rememberCallType.checked) {
          localStorage.removeItem('first_call_script_v2.call_pref');
        }
        updateMapIndicator();
      }
      async function hydrateUserBadge() {
        const el = document.getElementById('user-badge');
        try {
          const res = await fetch('/.auth/me', { credentials: 'include' });
          if (!res.ok) throw new Error(String(res.status));
          const data = await res.json();
          const claim = data?.clientPrincipal?.userDetails || 'Signed in';
          el.querySelector('span:last-child').textContent = claim;
          el.classList.remove('is-hidden');
        } catch (e) {
          el.innerHTML = 'Not signed in — <a href="/.auth/login/aad">Sign in</a>';
          el.classList.remove('is-hidden');
        }
      }

      // Init
      (async function init(){
        hydrateUserBadge();

        // Load Buyer needs intel and normalise (works with Script-1/Script-2 shapes)
        try {
          const res = await fetch(INTEL_URL, { cache: 'no-store' });
          const raw = await res.json();
          window._intel = raw.products ? raw : (function normalise(old){
            const out={products:{}}; Object.entries(old||{}).forEach(([prod,beh])=>{
              const behaviours={}; Object.entries(beh||{}).forEach(([key,arr])=>{
                const [pri,pa,tr,pr,ob,ct]=Array.isArray(arr)?arr:[];
                behaviours[key]={priorities:toArr(pri),pains:toArr(pa),triggers:toArr(tr),proof:toArr(pr),objections:toArr(ob),ctas:toArr(ct)};
              });
              out.products[prod]={behaviours};
            }); return out;
          })(raw);
        } catch { window._intel = { products:{} }; }

        // Populate products
        const productSel = document.getElementById('product');
        const products = Object.keys(window._intel.products || {});
        const current = productSel.value;
        productSel.innerHTML = '<option value="">Select…</option>';
        products.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p; opt.textContent = p;
          if (p === current) opt.selected = true;
          productSel.appendChild(opt);
        });

        loadForm();
        updateMapIndicator();
        if (productSel.value && document.getElementById('buyer_behaviour').value) {
          renderIntel(productSel.value, document.getElementById('buyer_behaviour').value);
        }
        refreshSubmitState();

        // Restore last output
        const last = localStorage.getItem(OUTPUT_KEY);
        if (last) { outputEl.textContent = last; copyBtn.disabled = false; downloadBtn.disabled = false; }
      })();
    })();
  </script>
</body>
</html>
